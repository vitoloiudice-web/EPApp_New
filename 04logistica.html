<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Logistica</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>
    <style>
        /* [Stili CSS omessi per brevità, ma identici a prima] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 20px;}
        .data-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #343a40; }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .logistica-card { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px; }
        .logistica-card p { margin: 5px 0; font-size: 0.95em; }
        .logistica-card strong { color: #343a40; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .dashboard-nav a { width: 90%; }
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <div id="modalLogistica" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLogistica()">&times;</span>
            <h2>Registra Nuovo Viaggio / Tragitto</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="selectSede">Sede Fornitore (Origine / Destinazione)</label>
                    <select id="selectSede" onchange="calcolaCosti()"></select>
                </div>
                <div class="form-group">
                    <label for="selectLab">Lab di Riferimento</label>
                    <select id="selectLab"></select>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group">
                    <label for="inputDistanza">Distanza Sede (km - Sola Andata)</label>
                    <input type="number" id="inputDistanza" oninput="calcolaCosti()" readonly value="0">
                </div>
                <div class="form-group">
                    <label for="inputData">Data Spesa</label>
                    <input type="date" id="inputData" value="">
                </div>
            </div>

            <div class="logistica-card">
                <h3 style="margin-top: 0;">Riepilogo Costi Logistici (Andata e Ritorno)</h3>
                <p>Distanza Totale (A/R): <strong id="distanzaTotale">0.00 km</strong></p>
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 8px 0;">

                <p>Costo Viaggio (Carburante): <strong id="costoViaggio">0.00 €</strong></p>
                <p style="margin-left: 20px; font-size: 0.85em;">Costo Accessori Veicolo: <strong id="costiAccessori">0.00 €</strong></p>
                <ul style="list-style: none; padding-left: 20px; margin: 0;">
                    <li><small>Incidenza Pneumatici: <strong id="costoGomme">0.00 €</strong></small></li>
                    <li><small>Incidenza RCA: <strong id="costoRCA">0.00 €</strong></small></li>
                </ul>
                <hr style="border: 0; border-top: 2px solid #A5DD2E; margin: 10px 0;">
                <p style="font-size: 1.1em; font-weight: bold;">Costi Logistici Totali: <strong id="costiLogisticiTotali" style="color: #343a40;">0.00 €</strong></p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="primary" onclick="salvaTragitto()">Salva Tragitto</button>
            </div>
        </div>
    </div>


    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Logistica</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link active">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Logistica e Trasporti</h1>
            
            <div class="data-section" id="logistica-params-section">
                <h2>Parametri Logistici Globali</h2>
                <p>Configura i parametri utilizzati per il calcolo automatico dei costi di viaggio.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="carburanteCosto">Costo Carburante Benzina (€/L) <small style="font-weight: normal;">(Media Puglia ≈ 1.71)</small></label>
                        <input type="number" id="carburanteCosto" placeholder="es. 1.71" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="carburanteConsumo">Consumo Medio Veicolo (km/L)</label>
                        <input type="number" id="carburanteConsumo" placeholder="es. 15.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="kmAnnuali">Km Percorsi Standard (Annuali)</label>
                        <input type="number" id="kmAnnuali" placeholder="es. 15000">
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="gommeCosto">Costo Treno Gomme Standard (€)</label>
                        <input type="number" id="gommeCosto" placeholder="es. 380">
                    </div>
                    <div class="form-group">
                        <label for="gommeDurataAnni">Durata Media Gomme (Anni)</label>
                        <input type="number" id="gommeDurataAnni" placeholder="es. 5">
                    </div>
                    <div class="form-group">
                        <label for="rcaSemestrale">Costo RCA Semestrale (€)</label>
                        <input type="number" id="rcaSemestrale" placeholder="es. 460">
                    </div>
                </div>
                <div style="text-align: right;">
                    <button class="primary" onclick="salvaParametriLogistica()">Salva Parametri</button>
                </div>
            </div>
            
            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLogistica()">➕ Nuova Tracciatura</button>
                </div>
                
                <h2>Tragitto Registrati</h2>
                <p>Tragitto logistici associati a specifici Lab per il calcolo del costo vivo.</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Lab Riferimento</th>
                                <th>Sede Fornitore</th>
                                <th>Distanza A/R (km)</th>
                                <th>Costo Carburante (€)</th>
                                <th>Costi Accessori (€)</th>
                                <th>Costo Logistico Totale (€)</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLogisticaBody">
                            <tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
       // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        const dashboardNav = document.getElementById('dashboardNav');

        // Parametri Logistici Default/Predefiniti
        let globalParams = {
            carburanteCosto: 1.71,      // €/L - Prezzo Benzina (Puglia Self)
            carburanteConsumo: 15.0,    // km/L
            gommeCosto: 380,            // €
            gommeDurataAnni: 5,         // Anni
            rcaSemestrale: 460,         // €
            kmAnnuali: 15000            // km
        };

        // COLLEZIONI FIREBASE
        const colLogisticaParams = db.collection('logisticaParams').doc('global');
        const colLogisticaTrips = db.collection('logisticaTrips');
        const colFornitoriSedi = db.collection('fornitoriSedi'); 
        const colLabs = db.collection('labs');

        // VARIABILI GLOBALI PER I DATI
        let fornitoriSediData = [];
        let labsData = [];

        // --- UTILS & CORE FUNCTIONS ---
        
        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('dashboardContainer').style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                await caricaParametriLogistica();
                await fetchFornitoriLabs();
                fetchLogisticaTrips();
            } else {
                window.location.href = '00index.html'; 
            }
        });


        // --- LOGICA PARAMETRI GLOBALI ---

        async function caricaParametriLogistica() {
            try {
                const doc = await colLogisticaParams.get();
                if (doc.exists) {
                    globalParams = doc.data();
                } 
                // Popola i campi input con i valori (globalParams contiene i valori da FB o i default)
                document.getElementById('carburanteCosto').value = globalParams.carburanteCosto.toFixed(2);
                document.getElementById('carburanteConsumo').value = globalParams.carburanteConsumo.toFixed(1);
                document.getElementById('kmAnnuali').value = globalParams.kmAnnuali;
                document.getElementById('gommeCosto').value = globalParams.gommeCosto;
                document.getElementById('gommeDurataAnni').value = globalParams.gommeDurataAnni;
                document.getElementById('rcaSemestrale').value = globalParams.rcaSemestrale;

            } catch(e) {
                console.error("Errore nel caricamento parametri:", e);
                // In caso di errore, mantiene i valori di default in globalParams.
            }
        }

        async function salvaParametriLogistica() {
             try {
                // Leggi i valori attuali dagli input
                const newParams = {
                    carburanteCosto: parseFloat(document.getElementById('carburanteCosto').value),
                    carburanteConsumo: parseFloat(document.getElementById('carburanteConsumo').value),
                    kmAnnuali: parseInt(document.getElementById('kmAnnuali').value),
                    gommeCosto: parseInt(document.getElementById('gommeCosto').value),
                    gommeDurataAnni: parseInt(document.getElementById('gommeDurataAnni').value),
                    rcaSemestrale: parseInt(document.getElementById('rcaSemestrale').value),
                };

                // Aggiorna la variabile globale
                globalParams = newParams;

                // Salva su Firebase
                await colLogisticaParams.set(globalParams);
                alert("Parametri logistici salvati con successo!");

            } catch (e) {
                console.error("Errore nel salvataggio dei parametri:", e);
                alert("Errore nel salvataggio. Controlla che tutti i campi siano numeri validi.");
            }
        }

        // --- LOGICA DI CALCOLO CORE ---

        /**
         * Calcola tutti i costi logistici complessi in base alla distanza (sola andata)
         * @param {number} distanzaKm - Distanza in km (sola andata)
         * @param {object} params - Parametri logistici globali (globalParams)
         * @returns {object} Oggetto contenente tutti i costi calcolati.
         */
        function calcolaCostiLogistici(distanzaKm, params) {
            if (distanzaKm <= 0 || !params.carburanteCosto || !params.carburanteConsumo) {
                return { distanzaTotale: 0, costoViaggio: 0, costoGomme: 0, costoRCA: 0, costiAccessori: 0, costiLogisticiTotali: 0 };
            }

            const distanzaA_R = distanzaKm * 2;
            
            // 5. CALCOLO "Costo Viaggio" (Carburante)
            // Formula: (distanza A/R) / consumo (km/L) * costo (€/L)
            const litriConsumati = distanzaA_R / params.carburanteConsumo;
            const costoViaggio = litriConsumati * params.carburanteCosto;

            // 6. CALCOLO "Costi Veicolo Accessori"
            
            // Costo a Km Generale (Basato su 15000 km annui)
            const kmAnnualiBase = params.kmAnnuali || 15000;
            
            // A. Incidenza Consumo Pneumatici
            // fase 1: costo annuo
            const costoAnnGomme = params.gommeCosto / params.gommeDurataAnni; // es. 380 / 5 = 76 €/anno
            // fase 3: costo a km
            const costoKmGomme = costoAnnGomme / kmAnnualiBase; // es. 76 / 15000 = 0.00506 €/km
            // fase 4: costo giornaliero
            const costoGomme = costoKmGomme * distanzaA_R;

            // B. Incidenza RCA
            // Nota: ho interpretato le fasi 1 e 2 come un calcolo del "costo RCA a km" basato sul chilometraggio annuo standard, 
            // e fase 3 come l'applicazione di quel costo a km al tragitto specifico.
            // Costo RCA Annuale
            const costoAnnRCA = params.rcaSemestrale * 2; // es. 460 * 2 = 920 €/anno
            // Costo RCA a Km Generale
            const costoKmRCA = costoAnnRCA / kmAnnualiBase; // es. 920 / 15000 = 0.0613 €/km
            // Costo Giornaliero (fase 3)
            const costoRCA = costoKmRCA * distanzaA_R;
            
            // Totale Accessori
            const costiAccessori = costoGomme + costoRCA;

            // Totale Complessivo
            const costiLogisticiTotali = costoViaggio + costiAccessori;

            return {
                distanzaTotale: distanzaA_R,
                costoViaggio: costoViaggio,
                costoGomme: costoGomme,
                costoRCA: costoRCA,
                costiAccessori: costiAccessori,
                costiLogisticiTotali: costiLogisticiTotali
            };
        }

        // --- MODALE E GESTIONE DATI ---
        
        async function fetchFornitoriLabs() {
            try {
                // 1. Carica Elenco Sedi Fornitori
                const sediSnapshot = await colFornitoriSedi.where('attivo', '==', true).get();
                fornitoriSediData = sediSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const selectSede = document.getElementById('selectSede');
                selectSede.innerHTML = '<option value="" data-dist="0">Seleziona Sede Fornitore</option>';
                fornitoriSediData.forEach(sede => {
                    const option = document.createElement('option');
                    option.value = sede.id;
                    option.textContent = `${sede.nomeFornitore} - ${sede.citta} (${sede.distanzaKm || 0} km)`;
                    option.setAttribute('data-dist', sede.distanzaKm || 0);
                    selectSede.appendChild(option);
                });

                // Carica Elenco Labs per l'associazione
                const labsSnapshot = await colLabs.where('stato', '!=', 'Completato').get();
                labsData = labsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const selectLab = document.getElementById('selectLab');
                selectLab.innerHTML = '<option value="">Seleziona Lab di Riferimento</option>';
                labsData.forEach(lab => {
                    const option = document.createElement('option');
                    option.value = lab.id;
                    option.textContent = lab.nome;
                    selectLab.appendChild(option);
                });

            } catch (e) {
                console.error("Errore nel caricamento Sedi/Labs:", e);
                alert("Impossibile caricare le sedi dei fornitori o i Labs. Verifica la collezione 'fornitoriSedi' e 'labs'.");
            }
        }
        
        function calcolaCosti() {
            const selectSede = document.getElementById('selectSede');
            const selectedOption = selectSede.options[selectSede.selectedIndex];
            
            // 2. Visualizzare distanza in km della sede
            const distanzaKm = parseFloat(selectedOption.getAttribute('data-dist')) || 0;
            
            document.getElementById('inputDistanza').value = distanzaKm.toFixed(2);
            
            const costi = calcolaCostiLogistici(distanzaKm, globalParams);

            // Popola i risultati nel riepilogo del modale
            document.getElementById('distanzaTotale').textContent = costi.distanzaTotale.toFixed(2) + ' km';
            document.getElementById('costoViaggio').textContent = costi.costoViaggio.toFixed(2) + ' €';
            document.getElementById('costiAccessori').textContent = costi.costiAccessori.toFixed(2) + ' €';
            document.getElementById('costoGomme').textContent = costi.costoGomme.toFixed(2) + ' €';
            document.getElementById('costoRCA').textContent = costi.costoRCA.toFixed(2) + ' €';
            document.getElementById('costiLogisticiTotali').textContent = costi.costiLogisticiTotali.toFixed(2) + ' €';

            return costi;
        }


        function apriModaleLogistica() { 
            // Aggiorna la data di oggi come default
            document.getElementById('inputData').valueAsDate = new Date();
            // Assicurati che i dropdown siano popolati e calcola i costi iniziali
            if (fornitoriSediData.length > 0) {
                document.getElementById('selectSede').selectedIndex = 0; 
                calcolaCosti(); 
            }
            document.getElementById('modalLogistica').style.display = 'block'; 
        }

        function chiudiModaleLogistica() { 
            document.getElementById('modalLogistica').style.display = 'none';
        }
        
        // --- SALVATAGGIO TRAGITTO ---

        async function salvaTragitto() {
            const sedeSelect = document.getElementById('selectSede');
            const labSelect = document.getElementById('selectLab');
            const dataInput = document.getElementById('inputData');
            
            const sedeId = sedeSelect.value;
            const labId = labSelect.value;
            const dataSpesa = dataInput.value;
            const distanzaKm = parseFloat(document.getElementById('inputDistanza').value);
            
            if (!sedeId || !labId || !dataSpesa || distanzaKm === 0) {
                alert("Seleziona una sede, un Lab e verifica la data/distanza.");
                return;
            }

            const sedeInfo = fornitoriSediData.find(s => s.id === sedeId);
            const labInfo = labsData.find(l => l.id === labId);
            const costi = calcolaCostiLogistici(distanzaKm, globalParams);

            const newTrip = {
                sedeId: sedeId,
                nomeSede: sedeInfo ? sedeInfo.nomeFornitore + ' (' + sedeInfo.citta + ')' : 'Sede Sconosciuta',
                labId: labId,
                nomeLab: labInfo ? labInfo.nome : 'Lab Sconosciuto',
                dataSpesa: firebase.firestore.Timestamp.fromDate(new Date(dataSpesa)),
                distanzaA_R: costi.distanzaTotale,
                costoCarburante: costi.costoViaggio,
                costiAccessori: costi.costiAccessori,
                costoTotale: costi.costiLogisticiTotali,
                parametriUsati: globalParams, // Salva i parametri usati per la tracciabilità
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await colLogisticaTrips.add(newTrip);
                alert("Tragitto logistico registrato con successo!");
                chiudiModaleLogistica();
                fetchLogisticaTrips(); // Ricarica la tabella
            } catch (e) {
                console.error("Errore nel salvataggio del tragitto:", e);
                alert("Errore durante il salvataggio del tragitto.");
            }
        }
        
        // --- VISUALIZZAZIONE TRAGITTI ---

        function fetchLogisticaTrips() {
            colLogisticaTrips.orderBy('dataSpesa', 'desc').onSnapshot(snapshot => {
                const tbody = document.getElementById('tabellaLogisticaBody');
                tbody.innerHTML = ''; // Pulisce la tabella
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const trip = doc.data();
                    const data = trip.dataSpesa.toDate().toLocaleDateString('it-IT');
                    
                    const row = tbody.insertRow();
                    row.insertCell().textContent = trip.nomeLab;
                    row.insertCell().textContent = trip.nomeSede;
                    row.insertCell().textContent = trip.distanzaA_R.toFixed(2);
                    row.insertCell().textContent = trip.costoCarburante.toFixed(2) + ' €';
                    row.insertCell().textContent = trip.costiAccessori.toFixed(2) + ' €';
                    row.insertCell().textContent = trip.costoTotale.toFixed(2) + ' €';
                    row.insertCell().textContent = data;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `<button class="primary" style="background-color: #ff9999;" onclick="eliminaTragitto('${doc.id}')">Elimina</button>`;
                });
            }, error => {
                console.error("Errore nel fetch dei tragitti:", error);
                document.getElementById('tabellaLogisticaBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento dei dati.</td></tr>';
            });
        }
        
        async function eliminaTragitto(id) {
            if (confirm('Sei sicuro di voler eliminare questo tragitto logistico?')) {
                try {
                    await colLogisticaTrips.doc(id).delete();
                    alert("Tragitto eliminato con successo.");
                } catch(e) {
                    console.error("Errore eliminazione:", e);
                    alert("Errore durante l'eliminazione.");
                }
            }
        }

    </script>
</body>
</html>