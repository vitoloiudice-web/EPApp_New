<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Logistica</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>

    <style>
        /* [Stili CSS identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 20px;}
        .data-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #343a40; }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .logistica-card { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px; }
        .logistica-card p { margin: 5px 0; font-size: 0.95em; }
        .logistica-card strong { color: #343a40; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .dashboard-nav a { width: 90%; }
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <div id="modalLogistica" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLogistica()">&times;</span>
            <h2>Registra Nuovo Viaggio / Tragitto</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="selectFornitore">Sede Fornitore (Origine / Destinazione)</label>
                    <select id="selectFornitore" onchange="calcolaCosti()"></select> 
                </div>
                <div class="form-group">
                    <label for="selectLab">Lab di Riferimento</label>
                    <select id="selectLab"></select>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group">
                    <label for="inputDistanza">Distanza Totale (km - Andata/Ritorno)</label>
                    <input type="number" id="distanzaKm" readonly value="0"> 
                </div>
                <div class="form-group">
                    <label for="inputData">Data Spesa</label>
                    <input type="date" id="inputData" value="">
                </div>
            </div>

            <div class="logistica-card">
                <h3 style="margin-top: 0;">Riepilogo Costi Logistici (Calcolati)</h3>
                <p>Distanza Totale (A/R): <strong id="distanzaTotale">0.00 km</strong></p>
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 8px 0;">

                <p>Costo Viaggio (Carburante): <strong id="costoViaggio">0.00 €</strong></p>
                <p style="margin-left: 20px; font-size: 0.85em;">Costo Accessori Veicolo: <strong id="costiAccessori">0.00 €</strong></p>
                <ul style="list-style: none; padding-left: 20px; margin: 0;">
                    <li><small>Incidenza Pneumatici: <strong id="costoGomme">0.00 €</strong></small></li>
                    <li><small>Incidenza RCA: <strong id="costoRCA">0.00 €</strong></small></li>
                </ul>
                <hr style="border: 0; border-top: 2px solid #A5DD2E; margin: 10px 0;">
                <p style="font-size: 1.1em; font-weight: bold;">Costi Logistici Totali: <strong id="costiLogisticiTotali" style="color: #343a40;">0.00 €</strong></p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="primary" onclick="salvaTragitto()">Salva Tragitto</button>
            </div>
        </div>
    </div>


    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Logistica</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link active">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Logistica e Trasporti</h1>
            
            <div class="data-section" id="logistica-params-section">
                <h2>Parametri Logistici Globali</h2>
                <p>Configura i parametri utilizzati per il calcolo automatico dei costi di viaggio.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="carburanteCosto">Costo Carburante Benzina (€/L) <small style="font-weight: normal;">(Media Puglia ≈ 1.71)</small></label>
                        <input type="number" id="carburanteCosto" placeholder="es. 1.71" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="carburanteConsumo">Consumo Medio Veicolo (km/L)</label>
                        <input type="number" id="carburanteConsumo" placeholder="es. 15.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="kmAnnuali">Km Percorsi Standard (Annuali)</label>
                        <input type="number" id="kmAnnuali" placeholder="es. 15000">
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="gommeCosto">Costo Treno Gomme Standard (€)</label>
                        <input type="number" id="gommeCosto" placeholder="es. 380">
                    </div>
                    <div class="form-group">
                        <label for="gommeDurataAnni">Durata Media Gomme (Anni)</label>
                        <input type="number" id="gommeDurataAnni" placeholder="es. 5">
                    </div>
                    <div class="form-group">
                        <label for="rcaSemestrale">Costo RCA Semestrale (€)</label>
                        <input type="number" id="rcaSemestrale" placeholder="es. 460">
                    </div>
                </div>
                <div style="text-align: right;">
                    <button class="primary" onclick="salvaParametriLogistica()">Salva Parametri</button>
                </div>
            </div>
            
            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLogistica()">➕ Nuova Tracciatura</button>
                </div>
                
                <h2>Tragitto Registrati</h2>
                <p>Tragitto logistici associati a specifici Lab per il calcolo del costo vivo.</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Lab Riferimento</th>
                                <th>Sede Fornitore</th>
                                <th>Distanza A/R (km)</th>
                                <th>Costo Carburante (€)</th>
                                <th>Costi Accessori (€)</th>
                                <th>Costo Logistico Totale (€)</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaTragittiBody">
                            <tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const dashboardNav = document.getElementById('dashboardNav');
        const modalLogistica = document.getElementById('modalLogistica');
        const selectFornitore = document.getElementById('selectFornitore');
        const distanzaKmInput = document.getElementById('distanzaKm');

        // Variabili Globali
        let sediCacheLogistica = {}; 
        let parametriLogistica = {}; 
        let labsCacheLogistica = {};

        // --- FUNZIONI UTILITY ---
        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        function apriModaleLogistica() {
            // Resetta i dropdown prima di aprire
            selectFornitore.selectedIndex = 0;
            document.getElementById('selectLab').selectedIndex = 0;
            calcolaCosti(); 
            document.getElementById('inputData').valueAsDate = new Date();
            modalLogistica.style.display = 'block';
        }

        function chiudiModaleLogistica() {
            modalLogistica.style.display = 'none';
        }

        // ==========================================================
        // LOGICA DI CARICAMENTO DATI (FIXED)
        // ==========================================================
        
        /**
         * Carica e memorizza le sedi dei fornitori con la distanza.
         * FIX: Mostra Ragione Sociale e Distanza.
         */
        async function caricaSediFornitoriLogistica() {
            console.log('[LOGISTICA] Caricamento sedi fornitore in corso (con fix RagSoc/Distanza)...');
            sediCacheLogistica = {}; 
            selectFornitore.innerHTML = '<option value="">-- Seleziona Sede e Distanza --</option>';

            try {
                const fornitoriSnapshot = await db.collection("fornitori").get();
                
                if (fornitoriSnapshot.empty) {
                    selectFornitore.innerHTML = '<option value="">Nessun Fornitore trovato.</option>';
                    return;
                }

                fornitoriSnapshot.forEach(doc => {
                    const data = doc.data();
                    const fornitoriId = doc.id;
                    
                    // 1. Logica di fallback robusta per il nome fornitore (Ragione Sociale)
                    const nomeFornitore = data.ragSoc 
                        || data.nome // Aggiunto fallback per 'nome'
                        || (data.anagrafe ? data.anagrafe.ragSoc : null)
                        || (data.anagrafe ? data.anagrafe.nome : null)
                        || `ID: ${fornitoriId.substring(0, 7)}...`; 

                    const sedi = data.sedi || [];

                    sedi.forEach((sede, index) => {
                        const sedeId = `${fornitoriId}_${index}`;
                        const nomeSede = sede.nome || sede.citta || 'Sede Principale'; 
                        
                        // Assumiamo che il campo per la distanza sia 'distanzaKm'
                        const distanza = parseFloat(sede.distanzaKm || 0); 
                        
                        // 2. Costruzione della stringa di visualizzazione richiesta
                        const nomeSedeCompleto = `${nomeFornitore} - ${nomeSede} (${distanza.toFixed(2)} Km)`;

                        // Salva il dato completo nella cache
                        sediCacheLogistica[sedeId] = { 
                            nome: nomeSedeCompleto, 
                            distanza: distanza
                        };

                        const option = document.createElement('option');
                        option.value = sedeId;
                        option.textContent = nomeSedeCompleto;
                        selectFornitore.appendChild(option);
                    });
                });

            } catch (error) {
                console.error("Errore nel caricamento delle sedi fornitori per logistica:", error);
                selectFornitore.innerHTML = '<option value="">Errore nel caricamento dei dati.</option>';
            }
        }
        
        /**
         * Carica i Labs e mostra solo il nome del Lab.
         * FIX: Mostra solo il nome (Requisito B).
         */
        async function caricaLabsPerCacheLogistica() {
             const selectLab = document.getElementById('selectLab');
             selectLab.innerHTML = '<option value="">-- Seleziona Lab --</option>';
             labsCacheLogistica = {};
             try {
                const labsSnapshot = await db.collection("labs").get();
                labsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const labId = doc.id;
                    
                    // FIX: Mostra solo il nome breve o il nome.
                    const nomeVisualizzato = data.nomeBreve || data.nome || `Lab ID: ${labId.substring(0, 7)}`;
                    
                    labsCacheLogistica[labId] = { nome: nomeVisualizzato };
                    
                    const option = document.createElement('option');
                    option.value = labId;
                    option.textContent = nomeVisualizzato;
                    selectLab.appendChild(option);
                });
             } catch (error) {
                 console.error("Errore nel caricamento dei Labs:", error);
             }
        }

        // ==========================================================
        // LOGICA DI CALCOLO E SALVATAGGIO
        // ==========================================================

        function calcolaCosti() {
            const selectedSedeId = selectFornitore.value;
            let distanzaTotale = 0; // Questa è la distanza A/R che usiamo per i calcoli

            if (selectedSedeId && sediCacheLogistica[selectedSedeId]) {
                // La distanza salvata nella cache è A/R (come definito in 02fornitori.html)
                distanzaTotale = sediCacheLogistica[selectedSedeId].distanza * 2; 
            }

            // Aggiorna i campi di sola lettura con la distanza A/R
            distanzaKmInput.value = distanzaTotale.toFixed(2);
            document.getElementById('distanzaTotale').textContent = `${distanzaTotale.toFixed(2)} km`;
            
            // Se la distanza è zero, azzera i costi
            if (distanzaTotale === 0) {
                 document.getElementById('costoViaggio').textContent = '0.00 €';
                 document.getElementById('costiAccessori').textContent = '0.00 €';
                 document.getElementById('costoGomme').textContent = '0.00 €';
                 document.getElementById('costoRCA').textContent = '0.00 €';
                 document.getElementById('costiLogisticiTotali').textContent = '0.00 €';
                 return;
            }


            // --- Logica di calcolo del costo ---
            const costoCarburantePerLitro = parseFloat(document.getElementById('carburanteCosto').value || 1.71);
            const consumoKmPerLitro = parseFloat(document.getElementById('carburanteConsumo').value || 15.0);
            const kmAnnuali = parseFloat(document.getElementById('kmAnnuali').value || 15000);
            const costoGomme = parseFloat(document.getElementById('gommeCosto').value || 380);
            const durataGommeAnni = parseFloat(document.getElementById('gommeDurataAnni').value || 5);
            const rcaSemestrale = parseFloat(document.getElementById('rcaSemestrale').value || 460);

            // 1. Costo Carburante (Viaggio)
            const litriNecessari = distanzaTotale / consumoKmPerLitro;
            const costoViaggio = litriNecessari * costoCarburantePerLitro;

            // 2. Costi Accessori (Incidenza per Km)
            const rcaAnnuale = rcaSemestrale * 2;
            const incidenzaRcaPerKm = rcaAnnuale / kmAnnuali;
            
            const costoGommeAnnuale = costoGomme / durataGommeAnni;
            const incidenzaGommePerKm = costoGommeAnnuale / kmAnnuali;
            
            const costiAccessoriPerKm = incidenzaRcaPerKm + incidenzaGommePerKm;
            const costiAccessoriTotali = costiAccessoriPerKm * distanzaTotale;

            // 3. Totale
            const costiLogisticiTotali = costoViaggio + costiAccessoriTotali;

            // Aggiorna il riepilogo
            document.getElementById('costoViaggio').textContent = `${costoViaggio.toFixed(2)} €`;
            document.getElementById('costiAccessori').textContent = `${costiAccessoriTotali.toFixed(2)} €`;
            document.getElementById('costoGomme').textContent = `${(incidenzaGommePerKm * distanzaTotale).toFixed(2)} €`;
            document.getElementById('costoRCA').textContent = `${(incidenzaRcaPerKm * distanzaTotale).toFixed(2)} €`;
            document.getElementById('costiLogisticiTotali').textContent = `${costiLogisticiTotali.toFixed(2)} €`;
        }


        function salvaParametriLogistica() {
            const parametri = {
                carburanteCosto: parseFloat(document.getElementById('carburanteCosto').value || 0),
                carburanteConsumo: parseFloat(document.getElementById('carburanteConsumo').value || 0),
                kmAnnuali: parseInt(document.getElementById('kmAnnuali').value || 0),
                gommeCosto: parseFloat(document.getElementById('gommeCosto').value || 0),
                gommeDurataAnni: parseFloat(document.getElementById('gommeDurataAnni').value || 0),
                rcaSemestrale: parseFloat(document.getElementById('rcaSemestrale').value || 0),
            };

            db.collection("logistica_config").doc("parametri_globali").set(parametri)
                .then(() => {
                    alert("Parametri logistici salvati con successo!");
                    caricaParametriLogistica(); 
                })
                .catch(error => {
                    console.error("Errore salvataggio parametri: ", error);
                    alert("Errore nel salvataggio dei parametri.");
                });
        }
        
        async function caricaParametriLogistica() {
            try {
                const doc = await db.collection("logistica_config").doc("parametri_globali").get();
                if (doc.exists) {
                    parametriLogistica = doc.data();
                    document.getElementById('carburanteCosto').value = parametriLogistica.carburanteCosto || '';
                    document.getElementById('carburanteConsumo').value = parametriLogistica.carburanteConsumo || '';
                    document.getElementById('kmAnnuali').value = parametriLogistica.kmAnnuali || '';
                    document.getElementById('gommeCosto').value = parametriLogistica.gommeCosto || '';
                    document.getElementById('gommeDurataAnni').value = parametriLogistica.gommeDurataAnni || '';
                    document.getElementById('rcaSemestrale').value = parametriLogistica.rcaSemestrale || '';
                } else {
                    console.log("Nessun parametro logistico trovato. Usando i valori di default.");
                }
            } catch (error) {
                console.error("Errore nel caricamento dei parametri logistici:", error);
            }
        }

        function salvaTragitto() {
            const selectedSedeId = selectFornitore.value;
            const labId = document.getElementById('selectLab').value;
            
            if (!selectedSedeId || !labId) {
                alert("Seleziona una sede fornitore e un Lab di riferimento.");
                return;
            }
            
            const sedeData = sediCacheLogistica[selectedSedeId];
            const dataSpesa = document.getElementById('inputData').value;
            
            // Estrai i valori calcolati
            const costoLogisticoTotale = parseFloat(document.getElementById('costiLogisticiTotali').textContent.replace(' €', ''));
            const costoCarburante = parseFloat(document.getElementById('costoViaggio').textContent.replace(' €', ''));
            const costiAccessori = parseFloat(document.getElementById('costiAccessori').textContent.replace(' €', ''));
            const distanzaAR = parseFloat(document.getElementById('distanzaKm').value);

            const tragittoData = {
                sedeId: selectedSedeId,
                nomeSedeCompleto: sedeData.nome,
                labId: labId,
                nomeLab: labsCacheLogistica[labId] ? labsCacheLogistica[labId].nome : 'Sconosciuto',
                data: dataSpesa ? firebase.firestore.Timestamp.fromDate(new Date(dataSpesa)) : null,
                distanzaKm: distanzaAR, // Salviamo la distanza A/R
                costoCarburante: costoCarburante,
                costiAccessori: costiAccessori,
                costoTotale: costoLogisticoTotale,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("logistica_tragitti").add(tragittoData)
                .then(() => {
                    alert("Tragitto registrato con successo!");
                    chiudiModaleLogistica();
                    caricaTragitti(); // Ricarica la tabella
                })
                .catch(error => {
                    console.error("Errore salvataggio tragitto: ", error);
                    alert("Errore nel salvataggio del tragitto.");
                });
        }
        
        async function caricaTragitti() {
            const tabellaBody = document.getElementById('tabellaTragittiBody');
            tabellaBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Caricamento...</td></tr>';

            try {
                const snapshot = await db.collection("logistica_tragitti").orderBy("data", "desc").get();
                if (snapshot.empty) {
                    tabellaBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dataFormattata = data.data && data.data.toDate ? new Date(data.data.toDate()).toLocaleDateString('it-IT') : 'N/A';
                    
                    const labNome = data.nomeLab || 'Generico'; // Usa il nome Lab salvato al momento
                    
                    html += `
                        <tr>
                            <td>${labNome}</td>
                            <td>${data.nomeSedeCompleto}</td>
                            <td>${(data.distanzaKm || 0).toFixed(2)}</td>
                            <td>${(data.costoCarburante || 0).toFixed(2)} €</td>
                            <td>${(data.costiAccessori || 0).toFixed(2)} €</td>
                            <td>${(data.costoTotale || 0).toFixed(2)} €</td>
                            <td>${dataFormattata}</td>
                            <td><button onclick="eliminaTragitto('${doc.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Elimina</button></td>
                        </tr>
                    `;
                });
                tabellaBody.innerHTML = html;

            } catch (error) {
                console.error("Errore nel caricamento dei tragitti:", error);
                tabellaBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento dei tragitti.</td></tr>';
            }
        }
        
        function eliminaTragitto(id) {
            if (confirm("Sei sicuro di voler eliminare questo tragitto logistico?")) {
                db.collection("logistica_tragitti").doc(id).delete().then(() => {
                    alert("Tragitto eliminato con successo.");
                    caricaTragitti(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }


        // Logica di inizializzazione
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('dashboardContainer').style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                
                Promise.all([
                    caricaParametriLogistica(), 
                    caricaSediFornitoriLogistica(),
                    caricaLabsPerCacheLogistica() 
                ]).then(() => {
                    caricaTragitti(); 
                    calcolaCosti(); 
                }).catch(err => {
                    console.error("Errore nel caricamento dati iniziali Logistica:", err);
                });

            } else {
                document.getElementById('dashboardContainer').style.display = 'none';
                window.location.href = '00index.html';
            }
        });
    </script>
</body>
</html>