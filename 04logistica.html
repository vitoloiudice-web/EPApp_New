<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Logistica</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>

    <style>
        /* Stili CSS - Identici alla versione precedente per coerenza */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 20px;}
        .data-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #343a40; }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .logistica-card { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px; }
        .logistica-card p { margin: 5px 0; font-size: 0.95em; }
        .logistica-card strong { color: #343a40; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .dashboard-nav a { width: 90%; }
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <div id="modalLogistica" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLogistica()">&times;</span>
            <h2>Registra Nuovo Viaggio / Tragitto</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="selectFornitore">Sede Fornitore (Origine / Destinazione)</label>
                    <select id="selectFornitore" onchange="calcolaCosti()"></select> 
                </div>
                <div class="form-group">
                    <label for="selectLab">Lab di Riferimento</label>
                    <select id="selectLab"></select>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group">
                    <label for="inputDistanza">Distanza Totale (km - Andata/Ritorno)</label>
                    <input type="number" id="distanzaKm" readonly value="0"> 
                </div>
                <div class="form-group">
                    <label for="inputData">Data Spesa</label>
                    <input type="date" id="inputData" value="">
                </div>
            </div>

            <div class="logistica-card">
                <h3 style="margin-top: 0;">Riepilogo Costi Logistici (Calcolati)</h3>
                <p>Distanza Totale (A/R): <strong id="distanzaTotale">0.00 km</strong></p>
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 8px 0;">

                <p>Costo Viaggio (Carburante): <strong id="costoViaggio">0.00 â‚¬</strong></p>
                <p style="margin-left: 20px; font-size: 0.85em;">Costo Accessori Veicolo: <strong id="costiAccessori">0.00 â‚¬</strong></p>
                <ul style="list-style: none; padding-left: 20px; margin: 0;">
                    <li><small>Incidenza Pneumatici: <strong id="costoGomme">0.00 â‚¬</strong></small></li>
                    <li><small>Incidenza RCA: <strong id="costoRCA">0.00 â‚¬</strong></small></li>
                </ul>
                <hr style="border: 0; border-top: 2px solid #A5DD2E; margin: 10px 0;">
                <p style="font-size: 1.1em; font-weight: bold;">Costi Logistici Totali: <strong id="costiLogisticiTotali" style="color: #343a40;">0.00 â‚¬</strong></p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="primary" onclick="salvaTragitto()">Salva Tragitto</button>
            </div>
        </div>
    </div>


    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">â˜°</span>
            <h2>Logistica</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVITÃ€</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link active">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Logistica e Trasporti</h1>
            
            <div class="data-section" id="logistica-params-section">
                <h2>Parametri Logistici Globali</h2>
                <p>Configura i parametri utilizzati per il calcolo automatico dei costi di viaggio.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="carburanteCosto">Costo Carburante Benzina (â‚¬/L) <small style="font-weight: normal;">(Media Puglia â‰ˆ 1.71)</small></label>
                        <input type="number" id="carburanteCosto" placeholder="es. 1.71" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="carburanteConsumo">Consumo Medio Veicolo (km/L)</label>
                        <input type="number" id="carburanteConsumo" placeholder="es. 15.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="kmAnnuali">Km Percorsi Standard (Annuali)</label>
                        <input type="number" id="kmAnnuali" placeholder="es. 15000">
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="gommeCosto">Costo Treno Gomme Standard (â‚¬)</label>
                        <input type="number" id="gommeCosto" placeholder="es. 380">
                    </div>
                    <div class="form-group">
                        <label for="gommeDurataAnni">Durata Media Gomme (Anni)</label>
                        <input type="number" id="gommeDurataAnni" placeholder="es. 5">
                    </div>
                    <div class="form-group">
                        <label for="rcaSemestrale">Costo RCA Semestrale (â‚¬)</label>
                        <input type="number" id="rcaSemestrale" placeholder="es. 460">
                    </div>
                </div>
                <div style="text-align: right;">
                    <button class="primary" onclick="salvaParametriLogistica()">Salva Parametri</button>
                </div>
            </div>
            
            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLogistica()">âž• Nuova Tracciatura</button>
                </div>
                
                <h2>Tragitto Registrati</h2>
                <p>Tragitto logistici associati a specifici Lab per il calcolo del costo vivo.</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Lab Riferimento</th>
                                <th>Sede Fornitore</th>
                                <th>Distanza A/R (km)</th>
                                <th>Costo Carburante (â‚¬)</th>
                                <th>Costi Accessori (â‚¬)</th>
                                <th>Costo Logistico Totale (â‚¬)</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLogisticaBody">
                            <tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
       // âš ï¸ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE âš ï¸
        const firebaseConfig = {
  	        apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	        authDomain: "epapp-bb953.firebaseapp.com",
  	        projectId: "epapp-bb953",
  	        storageBucket: "epapp-bb953.firebasestorage.app",
  	        messagingSenderId: "797675959163",
  	        appId: "1:797675959163:web:30c077ce253990239d03de",
  	        measurementId: "G-RN2896V58E"
	    };
        
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        const dashboardNav = document.getElementById('dashboardNav');

        // Parametri Logistici Default/Predefiniti (Saranno sovrascritti dai dati di Firebase)
        let globalParams = {
            carburanteCosto: 1.71,      // â‚¬/L
            carburanteConsumo: 15.0,    // km/L
            gommeCosto: 380,            // â‚¬
            gommeDurataAnni: 5,         // Anni
            rcaSemestrale: 460,         // â‚¬
            kmAnnuali: 15000            // km
        };

        // COLLEZIONI FIREBASE
        const colLogisticaParams = db.collection('logisticaParams').doc('global');
        const colLogisticaTrips = db.collection('logisticaTrips');
        const colFornitoriSedi = db.collection('fornitori'); // PUNTIAMO ALLA COLLEZIONE 'fornitori'
        const colLabs = db.collection('labs');

        // Variabili per la cache dei dati letti
        let fornitoriSediCache = []; // ConterrÃ  la lista piatta dei fornitori/sedi
        let labsCache = [];
        let selectedSedeInfo = null;


        // --- UTILS & CORE FUNCTIONS ---
        
        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('dashboardContainer').style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                
                await caricaParametriLogistica(); // Carica i parametri globali
                await caricaSediFornitore();      // Carica il dropdown dei fornitori (CORRETTO)
                await caricaLabsRiferimento();    // Carica il dropdown dei Labs
                fetchLogisticaTrips();            // Carica la tabella dei viaggi registrati
            } else {
                window.location.href = '00index.html'; 
            }
        });


        // --- 1. LOGICA PARAMETRI GLOBALI ---

        async function caricaParametriLogistica() {
            try {
                const doc = await colLogisticaParams.get();
                if (doc.exists) {
                    // Aggiorna la variabile globale con i dati di Firebase
                    globalParams = doc.data(); 
                } 
                // Popola i campi input con i valori (da FB o default se non esiste)
                document.getElementById('carburanteCosto').value = globalParams.carburanteCosto.toFixed(2);
                document.getElementById('carburanteConsumo').value = globalParams.carburanteConsumo.toFixed(1);
                document.getElementById('kmAnnuali').value = globalParams.kmAnnuali;
                document.getElementById('gommeCosto').value = globalParams.gommeCosto;
                document.getElementById('gommeDurataAnni').value = globalParams.gommeDurataAnni;
                document.getElementById('rcaSemestrale').value = globalParams.rcaSemestrale;

            } catch(e) {
                console.error("Errore nel caricamento parametri:", e);
                // Mantiene i valori di default
            }
        }

        async function salvaParametriLogistica() {
             try {
                // Leggi i valori attuali dagli input
                const newParams = {
                    carburanteCosto: parseFloat(document.getElementById('carburanteCosto').value),
                    carburanteConsumo: parseFloat(document.getElementById('carburanteConsumo').value),
                    kmAnnuali: parseInt(document.getElementById('kmAnnuali').value),
                    gommeCosto: parseInt(document.getElementById('gommeCosto').value),
                    gommeDurataAnni: parseInt(document.getElementById('gommeDurataAnni').value),
                    rcaSemestrale: parseInt(document.getElementById('rcaSemestrale').value),
                };
                
                // Verifica la validitÃ  dei numeri
                if (Object.values(newParams).some(isNaN)) {
                     alert("Assicurati che tutti i campi dei parametri globali contengano numeri validi.");
                     return;
                }

                // Aggiorna la variabile globale
                globalParams = newParams;

                // Salva su Firebase
                await colLogisticaParams.set(globalParams);
                alert("Parametri logistici salvati con successo! Ricorda che questo creerÃ  la collezione 'logisticaParams'.");
                // Ricalcola i costi nel modale se Ã¨ aperto
                calcolaCosti();

            } catch (e) {
                console.error("Errore nel salvataggio dei parametri:", e);
                alert("Errore durante il salvataggio. Controlla che tutti i campi siano numeri validi.");
            }
        }

        // --- 2. CARICAMENTO DROPDOWN (SEDI E LABS) ---
        
        async function caricaSediFornitore() {
            const selectFornitore = document.getElementById('selectFornitore');
            selectFornitore.innerHTML = '<option value="">Seleziona Sede Fornitore</option>'; // Reset
            
            // Resetta la cache globale
            fornitoriSediCache = []; 
            
            console.log("[DEBUG-LOGISTICA] Tentativo di caricamento fornitori avviato...");

            try {
                const snapshot = await colFornitoriSedi.get(); // Legge la collezione 'fornitori'

                if (snapshot.empty) {
                    console.log("[DEBUG-LOGISTICA] Snapshot vuoto.");
                    selectFornitore.innerHTML += '<option value="" disabled>Nessun fornitore trovato in Firebase</option>';
                    return;
                }
                
                console.log(`[DEBUG-LOGISTICA] Trovati ${snapshot.size} documenti in 'fornitori'. Inizio iterazione.`);

                // ðŸ’¡ ITERA TUTTI I DOCUMENTI FORNITORE ðŸ’¡
                snapshot.forEach(doc => {
                    const fornitoreData = doc.data(); 
                    const fornitoreId = doc.id;
                    
                    // 1. Leggi il nome dell'azienda dal campo CORRETTO: 'ragSoc'
                    const nomeFornitore = fornitoreData.ragSoc || `Fornitore ID: ${fornitoreId.substring(0, 4)}...`;
                    
                    const sedi = fornitoreData.sedi || []; // Array delle sedi

                    if (sedi.length === 0) {
                         console.log(`[DEBUG-LOGISTICA] Il fornitore ${nomeFornitore} (ID: ${fornitoreId}) non ha sedi definite.`);
                         return; // Salta i fornitori senza sedi definite
                    }

                    // 2. Itera l'ARRAY 'sedi' per trovare le distanze e i nomi delle sedi secondarie
                    sedi.forEach((sede, index) => {
                        
                        // Crea un ID composto per identificare in modo univoco Sede e Fornitore
                        const sedeIdCompleto = `${fornitoreId}_${index}`; // Esempio: L7..._0
                        
                        // Il campo 'distanza' Ã¨ dentro l'oggetto 'sede'
                        const distanza = sede.distanza || 0; 
                        const distanzaNumber = parseFloat(distanza) || 0;
                        
                        // Usa il nome dell'azienda e, se disponibile, il nome specifico della sede
                        // Usiamo 'citta' come fallback per nomeSede se non esiste un campo 'nomeSede'
                        const nomeSede = sede.nomeSede || sede.citta || 'Sede Principale'; 
                        
                        const nomeSedeCompleto = `${nomeFornitore} - ${nomeSede} (${distanzaNumber} Km)`;
                        
                        const option = document.createElement('option');
                        option.value = sedeIdCompleto; 
                        option.textContent = nomeSedeCompleto; 
                        option.setAttribute('data-dist', distanzaNumber); 
                        
                        selectFornitore.appendChild(option);

                        // Aggiunge la sede alla cache
                        fornitoriSediCache.push({
                            id: sedeIdCompleto,
                            fornitoreId: fornitoreId, // ID del documento fornitore
                            sedeIndex: index,         // Indice nell'array
                            nomeSedeCompleto: nomeSedeCompleto, 
                            distanza: distanzaNumber
                        });
                    });
                });
                
                console.log("[DEBUG-LOGISTICA] Caricamento dropdown completato.");

            } catch (error) {
                console.error("[DEBUG-LOGISTICA] Errore CRITICO nel caricamento delle sedi fornitore:", error);
                selectFornitore.innerHTML += '<option value="" disabled>Errore di caricamento: Controlla la console.</option>';
            }
        }
        
        async function caricaLabsRiferimento() {
            const selectLab = document.getElementById('selectLab');
            selectLab.innerHTML = '<option value="">Seleziona Lab di Riferimento</option>'; // Reset

            try {
                // Filtra solo i Lab attivi o in corso (non completati)
                const snapshot = await colLabs.where('stato', '!=', 'Completato').get();
                labsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (labsCache.length === 0) {
                     selectLab.innerHTML += '<option value="" disabled>Nessun Lab attivo trovato.</option>';
                     return;
                }

                labsCache.forEach(lab => {
                    const option = document.createElement('option');
                    option.value = lab.id; 
                    option.textContent = lab.nome || lab.titolo || `Lab ID: ${lab.id.substring(0, 4)}...`;
                    selectLab.appendChild(option);
                });

            } catch (error) {
                console.error("Errore nel caricamento dei Labs:", error);
                selectLab.innerHTML += '<option value="" disabled>Errore di caricamento</option>';
            }
        }
        
        // --- 3. LOGICA DI CALCOLO E AGGIORNAMENTO UI ---

        function calcolaCosti() {
            const selectFornitore = document.getElementById('selectFornitore');
            const selectedOption = selectFornitore.options[selectFornitore.selectedIndex];
            
            // 2. Recupera la distanza (Andata)
            const distanzaSolaAndata = parseFloat(selectedOption.getAttribute('data-dist')) || 0;
            const distanzaKm = distanzaSolaAndata; 
            
            const distanzaA_R = distanzaKm * 2; // Distanza A/R
            document.getElementById('distanzaKm').value = distanzaA_R.toFixed(2);
            
            // Trova le info della sede/fornitore nella cache usando l'ID del documento
            selectedSedeInfo = fornitoriSediCache.find(s => s.id === selectFornitore.value);
            
            if (distanzaKm <= 0) {
                 // Resetta il riepilogo se la distanza Ã¨ 0
                document.getElementById('distanzaTotale').textContent = '0.00 km';
                document.getElementById('costoViaggio').textContent = '0.00 â‚¬';
                document.getElementById('costiAccessori').textContent = '0.00 â‚¬';
                document.getElementById('costoGomme').textContent = '0.00 â‚¬';
                document.getElementById('costoRCA').textContent = '0.00 â‚¬';
                document.getElementById('costiLogisticiTotali').textContent = '0.00 â‚¬';
                return { costoTotale: 0 }; // Ritorna un costo zero
            }
            
            const params = globalParams; // Usa i parametri globali caricati/salvati
            
            // 5. CALCOLO "Costo Viaggio" (Carburante)
            const litriConsumati = distanzaA_R / params.carburanteConsumo;
            const costoViaggio = litriConsumati * params.carburanteCosto;

            // 6. CALCOLO "Costi Veicolo Accessori"
            const kmAnnualiBase = params.kmAnnuali || 15000;
            
            // A. Incidenza Consumo Pneumatici
            const costoAnnGomme = params.gommeCosto / params.gommeDurataAnni; 
            const costoKmGomme = costoAnnGomme / kmAnnualiBase; 
            const costoGomme = costoKmGomme * distanzaA_R; // Costo per il tragitto A/R

            // B. Incidenza RCA
            const costoAnnRCA = params.rcaSemestrale * 2;
            const costoKmRCA = costoAnnRCA / kmAnnualiBase; 
            const costoRCA = costoKmRCA * distanzaA_R; // Costo per il tragitto A/R
            
            const costiAccessori = costoGomme + costoRCA;

            // Totale Complessivo
            const costiLogisticiTotali = costoViaggio + costiAccessori;

            // Popola i risultati nel riepilogo del modale
            document.getElementById('distanzaTotale').textContent = distanzaA_R.toFixed(2) + ' km';
            document.getElementById('costoViaggio').textContent = costoViaggio.toFixed(2) + ' â‚¬';
            document.getElementById('costiAccessori').textContent = costiAccessori.toFixed(2) + ' â‚¬';
            document.getElementById('costoGomme').textContent = costoGomme.toFixed(2) + ' â‚¬';
            document.getElementById('costoRCA').textContent = costoRCA.toFixed(2) + ' â‚¬';
            document.getElementById('costiLogisticiTotali').textContent = costiLogisticiTotali.toFixed(2) + ' â‚¬';

            return {
                distanzaTotale: distanzaA_R,
                costoViaggio: costoViaggio,
                costiAccessori: costiAccessori,
                costoTotale: costiLogisticiTotali
            };
        }


        function apriModaleLogistica() { 
            // Aggiorna la data di oggi come default
            document.getElementById('inputData').valueAsDate = new Date();
            // Resetta i dropdown ai placeholder per forzare la ricalcolo
            document.getElementById('selectFornitore').selectedIndex = 0; 
            document.getElementById('selectLab').selectedIndex = 0; 
            calcolaCosti(); 
            document.getElementById('modalLogistica').style.display = 'block'; 
        }

        function chiudiModaleLogistica() { 
            document.getElementById('modalLogistica').style.display = 'none';
        }
        
        // --- 4. SALVATAGGIO TRAGITTO ---

        async function salvaTragitto() {
            const sedeSelect = document.getElementById('selectFornitore');
            const labSelect = document.getElementById('selectLab');
            const dataInput = document.getElementById('inputData');
            
            // L'ID della sede Ã¨ ora l'ID composto (es. 'L7..._0')
            const sedeIdCompleto = sedeSelect.value; 
            const labId = labSelect.value;
            const dataSpesa = dataInput.value;
            
            if (!sedeIdCompleto || !labId || !dataSpesa) {
                alert("Seleziona una sede fornitore, un Lab di riferimento e una data.");
                return;
            }

            const costi = calcolaCosti(); // Ricalcola i costi un'ultima volta
            
            if (costi.costoTotale === 0) {
                 alert("La distanza della sede selezionata Ã¨ 0 km. Non Ã¨ necessario registrare il tragitto.");
                 return;
            }

            // Ottiene le informazioni della sede dalla cache usando l'ID composto
            const selectedSede = fornitoriSediCache.find(s => s.id === sedeIdCompleto);
            
            if (!selectedSede) {
                alert("Errore interno: Dati sede non trovati in cache. Riprova.");
                return;
            }
            
            const labInfo = labsCache.find(l => l.id === labId);

            const newTrip = {
                // Salviamo sia l'ID del fornitore che l'ID composto per futura tracciabilitÃ 
                sedeIdCompleto: sedeIdCompleto, // ID composto (L7..._0)
                sedeFornitoreId: selectedSede.fornitoreId, // Solo ID del documento fornitore
                nomeSede: selectedSede.nomeSedeCompleto, // Nome Azienda - Sede (Km)
                
                labId: labId,
                nomeLab: labInfo ? (labInfo.nome || labInfo.titolo) : 'Lab Sconosciuto', 
                
                dataSpesa: firebase.firestore.Timestamp.fromDate(new Date(dataSpesa)),
                distanzaA_R: costi.distanzaTotale,
                costoCarburante: costi.costoViaggio,
                costiAccessori: costi.costiAccessori,
                costoTotale: costi.costoTotale,
                parametriUsati: globalParams, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Questo crea la collezione 'logisticaTrips' se non esiste
                await colLogisticaTrips.add(newTrip); 
                alert("Tragitto logistico registrato con successo!");
                chiudiModaleLogistica();
                fetchLogisticaTrips(); // Aggiorna immediatamente la tabella
            } catch (e) {
                console.error("Errore nel salvataggio del tragitto:", e);
                alert("Errore durante il salvataggio del tragitto. Controlla la console.");
            }
        }
        
        // --- 5. VISUALIZZAZIONE TRAGITTI ---

        function fetchLogisticaTrips() {
            // Usa onSnapshot per aggiornamenti in tempo reale
            colLogisticaTrips.orderBy('dataSpesa', 'desc').onSnapshot(snapshot => {
                const tbody = document.getElementById('tabellaLogisticaBody');
                tbody.innerHTML = ''; // Pulisce la tabella
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun tragitto registrato.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const trip = doc.data();
                    // Gestisce la conversione di Firestore Timestamp
                    const data = trip.dataSpesa ? trip.dataSpesa.toDate().toLocaleDateString('it-IT') : 'N/A';
                    
                    const row = tbody.insertRow();
                    row.insertCell().textContent = trip.nomeLab || 'N/A';
                    // Usiamo il nomeSede salvato che Ã¨ l'etichetta completa
                    row.insertCell().textContent = trip.nomeSede || 'N/A'; 
                    row.insertCell().textContent = (trip.distanzaA_R || 0).toFixed(2);
                    row.insertCell().textContent = (trip.costoCarburante || 0).toFixed(2) + ' â‚¬';
                    row.insertCell().textContent = (trip.costiAccessori || 0).toFixed(2) + ' â‚¬';
                    row.insertCell().textContent = (trip.costoTotale || 0).toFixed(2) + ' â‚¬';
                    row.insertCell().textContent = data;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `<button class="primary" style="background-color: #ff9999;" onclick="eliminaTragitto('${doc.id}')">Elimina</button>`;
                });
            }, error => {
                console.error("Errore nel fetch dei tragitti:", error);
                document.getElementById('tabellaLogisticaBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento dei dati.</td></tr>';
            });
        }
        
        async function eliminaTragitto(id) {
            if (confirm('Sei sicuro di voler eliminare questo tragitto logistico?')) {
                try {
                    await colLogisticaTrips.doc(id).delete();
                    alert("Tragitto eliminato con successo.");
                    // onSnapshot si occuperÃ  di ricaricare la tabella
                } catch(e) {
                    console.error("Errore eliminazione:", e);
                    alert("Errore durante l'eliminazione.");
                }
            }
        }

    </script>
</body>
</html>