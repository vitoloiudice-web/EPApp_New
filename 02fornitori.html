<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Fornitori & Sedi</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>

    <style>
        /* [Stili CSS identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 3% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Struttura Sede Item AGGIORNATA */
        .sede-wrapper { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #fcfcfc; }
        .sede-item-grid { 
            display: grid; 
            /* Nome Sede | Indirizzo Sede | Costo Nolo | Distanza Km | Azioni */
            grid-template-columns: 1fr 1.5fr 1fr 1fr 100px; 
            gap: 15px; 
            margin-bottom: 15px; 
            align-items: center; 
        }
        .sede-item-grid .form-group { margin-bottom: 0; }
        .sede-item-grid button { height: 40px; margin-top: 15px; } /* Aggiunta margine per allineamento */

        /* CSS Aggiunto per allineamento label su desktop */
        @media (min-width: 769px) {
            .sede-item-grid .form-group {
                display: flex;
                flex-direction: column;
                justify-content: flex-end; /* Allinea gli input in basso */
            }
        }


        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .form-grid { grid-template-columns: 1fr; }
            /* Adatta la griglia sede su mobile per colonne singole */
            .sede-item-grid { grid-template-columns: 1fr; gap: 10px; } 
            .sede-item-grid button { width: 100%; margin-top: 10px; }
            .modal-content { margin: 10% 5%; width: 90%; max-width: 90%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Fornitori & Sedi</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link active">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Fornitori & Sedi</h1>

            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleFornitore(null)">➕ Crea Nuovo Fornitore</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome/Ragione Sociale</th>
                                <th>P.IVA/CF</th>
                                <th>Email</th>
                                <th>Contatto Tel.</th>
                                <th>Sedi Registrate</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaFornitoriBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="fornitoreModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleFornitore()">&times;</span>
            <h2 id="fornitoreModalTitle">Crea Nuovo Fornitore</h2>
            <form id="fornitoreForm">
                <input type="hidden" id="fornitoreId" value="">
                
                <h3>Anagrafica</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="ragSoc">Ragione Sociale/Nome</label>
                        <input type="text" id="ragSoc" required>
                    </div>
                    <div class="form-group">
                        <label for="pIva">P.IVA/C.F.</label>
                        <input type="text" id="pIva">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Contatto Telefonico</label>
                        <input type="tel" id="telefono">
                    </div>
                    <div class="form-group">
                        <label for="tipoFornitore">Tipo Fornitore</label>
                        <select id="tipoFornitore">
                            <option value="sede">Sedi & Locazioni</option>
                            <option value="materiali">Materiali & Inventario</option>
                            <option value="personale">Personale Esterno</option>
                            <option value="altro">Altro</option>
                        </select>
                    </div>
                </div>

                <div class="sedi-section">
                    <h3>Sedi & Costi di Noleggio (solo per tipo "Sedi & Locazioni")</h3>
                    <div id="sediList">
                        </div>
                    <button type="button" class="primary" style="margin-top: 10px;" onclick="aggiungiSede()">➕ Aggiungi Sede</button>
                </div>

                <div class="modal-buttons" style="margin-top: 20px; text-align: right;">
                    <button type="button" onclick="chiudiModaleFornitore()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Fornitore</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // CONFIGURAZIONE FIREBASE
        // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaFornitoriBody = document.getElementById('tabellaFornitoriBody');
        const fornitoreModal = document.getElementById('fornitoreModal');
        const fornitoreForm = document.getElementById('fornitoreForm');
        const dashboardNav = document.getElementById('dashboardNav');
        const sediListDiv = document.getElementById('sediList');
        
        // Array per gestire le Sedi temporaneamente nella Modale
        let fornitoreSedi = []; 
        let labsCache = []; // Mantenuta per coerenza con file correlati e per futuri controlli
        
        // --- FUNZIONI UTILITY ---
        function formatNumber(value) {
             return parseFloat(value || 0).toFixed(2);
        }

        // --- FUNZIONI NAVIGAZIONE MOBILE ---
        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }

        // --- GESTIONE CACHE LABS (mantenuta per completezza) ---
        async function caricaLabsCache() {
            try {
                // Carica solo gli ID Sede e i dati minimi per i controlli di eliminazione
                const snapshot = await db.collection("labs").get();
                labsCache = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        idSede: data.idSede 
                    };
                });
            } catch (error) {
                console.error("Errore nel caricamento della cache Labs:", error);
                labsCache = [];
            }
        }
        
        // --- FUNZIONI CRUD FORNITORI ---

        async function caricaFornitori() {
            tabellaFornitoriBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Caricamento Fornitori...</td></tr>';
            
            await caricaLabsCache();

            db.collection("fornitori").orderBy("anagrafe.ragSoc").onSnapshot(snapshot => {
                tabellaFornitoriBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaFornitoriBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nessun Fornitore trovato.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const anagrafe = data.anagrafe || {};
                    const sediCount = data.sedi ? data.sedi.length : 0;
                    
                    const row = tabellaFornitoriBody.insertRow();
                    row.className = 'row';
                    // Nota: si passa l'ID e i dati per la modale.
                    
                    // La serializzazione JSON viene eseguita in linea per passare i dati al click
                    const dataString = JSON.stringify(data).replace(/"/g, '&quot;'); 
                    
                    row.innerHTML = `
                        <td>${anagrafe.ragSoc || 'N/D'}</td>
                        <td>${anagrafe.pIva || 'N/D'}</td>
                        <td>${anagrafe.email || 'N/D'}</td>
                        <td>${anagrafe.telefono || 'N/D'}</td>
                        <td>${sediCount}</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleFornitore('${doc.id}', ${dataString})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaFornitore('${doc.id}')">Elimina</button>
                        </td>
                    `;
                    // Aggiungi un handler click alla riga per aprire la modale (escludendo l'area dei bottoni)
                    row.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON') {
                            apriModaleFornitore(doc.id, data);
                        }
                    };
                });
            }, error => {
                 tabellaFornitoriBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Errore nel caricamento Fornitori.</td></tr>';
                 console.error("Errore nel caricamento Fornitori:", error);
            });
        }

        function apriModaleFornitore(id = null, data = {}) {
            fornitoreForm.reset();
            fornitoreSedi = [];
            sediListDiv.innerHTML = '';
            
            document.getElementById('fornitoreId').value = id || '';
            document.getElementById('fornitoreModalTitle').textContent = id ? 'Modifica Fornitore' : 'Crea Nuovo Fornitore';
            
            if (id && data.anagrafe) {
                const anagrafe = data.anagrafe;
                document.getElementById('ragSoc').value = anagrafe.ragSoc || '';
                document.getElementById('pIva').value = anagrafe.pIva || '';
                document.getElementById('email').value = anagrafe.email || '';
                document.getElementById('telefono').value = anagrafe.telefono || '';
                document.getElementById('tipoFornitore').value = anagrafe.tipoFornitore || 'altro';
                
                // Mappa i dati delle sedi
                fornitoreSedi = (data.sedi || []).map(sede => ({
                    nomeSede: sede.nomeSede || '', // Nuovo campo
                    indirizzoSede: sede.indirizzoSede || sede.nome || '', // Mappaggio retrocompatibile
                    costoNolo: sede.costoNolo !== undefined ? parseFloat(sede.costoNolo) : 0,
                    distanzaKm: sede.distanzaKm !== undefined ? parseFloat(sede.distanzaKm) : 0
                }));
                
                ricaricaListaSedi();
            } else {
                ricaricaListaSedi();
            }

            fornitoreModal.style.display = "block";
        }

        function chiudiModaleFornitore() {
            fornitoreModal.style.display = "none";
        }
        
        fornitoreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fornitoreId = document.getElementById('fornitoreId').value;
            const isEditing = !!fornitoreId;
            
            // 1. Validazione base
            if (!document.getElementById('ragSoc').value) {
                alert("La Ragione Sociale è obbligatoria.");
                return;
            }
            
            // 2. Controllo coerenza sedi in fase di ELIMINAZIONE
            // Questo controllo previene l'eliminazione di una sede se LabsCache non è vuota.
            if (isEditing) {
                const sediInizialiCount = fornitoreSedi.length;
                
                // Se fornitoreSedi contiene meno elementi di quanti ne aveva all'inizio (significa che ne è stata rimossa qualcuna)
                // Se implementi la logica di 'ID Sede' nel DB, il controllo deve essere fatto in 'rimuoviSede'
            }

            const fornitoreData = {
                anagrafe: {
                    ragSoc: document.getElementById('ragSoc').value,
                    pIva: document.getElementById('pIva').value,
                    email: document.getElementById('email').value,
                    telefono: document.getElementById('telefono').value,
                    tipoFornitore: document.getElementById('tipoFornitore').value
                },
                // Mappa i dati delle sedi con i nuovi campi
                sedi: fornitoreSedi.map(s => ({
                    nomeSede: s.nomeSede || 'Sede N/D',
                    indirizzoSede: s.indirizzoSede || 'Indirizzo N/D',
                    costoNolo: parseFloat(s.costoNolo) || 0,
                    distanzaKm: parseFloat(s.distanzaKm) || 0
                }))
            };
            
            const collectionRef = db.collection("fornitori");
            let operation;

            if (isEditing) {
                // Aggiornamento
                operation = collectionRef.doc(fornitoreId).update(fornitoreData);
            } else {
                // Creazione
                operation = collectionRef.add(fornitoreData);
            }
            
            operation.then(() => {
                alert(`Fornitore ${isEditing ? 'aggiornato' : 'creato'} con successo!`);
                chiudiModaleFornitore();
                caricaFornitori(); 
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        function eliminaFornitore(id) {
            // Controlla se esistono Labs associati (ID sede inizia con fornitore ID)
            const labsAssociati = labsCache.filter(lab => lab.idSede && lab.idSede.startsWith(id + '_'));
            
            if (labsAssociati.length > 0) {
                 alert(`Impossibile eliminare. Sono presenti ${labsAssociati.length} Labs associati ad almeno una sede di questo fornitore. Rimuovi prima l'associazione dai Lab.`);
                 return;
            }

            if (confirm("Sei sicuro di voler eliminare questo Fornitore e tutte le sue Sedi? L'operazione è irreversibile.")) {
                db.collection("fornitori").doc(id).delete().then(() => {
                    alert("Fornitore eliminato con successo!");
                    caricaFornitori();
                }).catch(error => {
                    alert(`Errore nell'eliminazione: ${error.message}`);
                    console.error("Errore:", error);
                });
            }
        }

        // --- FUNZIONI GESTIONE SEDI AGGIORNATE ---

        function ricaricaListaSedi() {
            sediListDiv.innerHTML = '';
            fornitoreSedi.forEach((sede, index) => {
                aggiungiSedeHTML(sede, index); 
            });
        }

        function aggiungiSede() {
            fornitoreSedi.push({ nomeSede: 'Nuova Sede', indirizzoSede: '', costoNolo: 0.00, distanzaKm: 0 }); 
            ricaricaListaSedi();
        }

        /**
         * Crea l'HTML per una singola sede con la nuova griglia di input.
         */
        function aggiungiSedeHTML(sede, index) { 
            const divWrapper = document.createElement('div');
            divWrapper.className = 'sede-wrapper';
            
            divWrapper.innerHTML = `
                <h4>Sede ${index + 1}</h4>
                <div class="sede-item-grid">
                    <div class="form-group">
                        <label>Nome Sede</label>
                        <input type="text" id="sedeNomeSede${index}" value="${sede.nomeSede || ''}" placeholder="Es. Sede Roma Nord" 
                            onchange="aggiornaSede(${index}, 'nomeSede', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Indirizzo Sede</label>
                        <input type="text" id="sedeIndirizzoSede${index}" value="${sede.indirizzoSede || ''}" placeholder="Via, Città, CAP" 
                            onchange="aggiornaSede(${index}, 'indirizzoSede', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Costo Nolo Giornaliero (€)</label>
                        <input type="number" id="sedeCosto${index}" step="0.01" value="${formatNumber(sede.costoNolo)}" placeholder="Costo €" 
                            onchange="aggiornaSede(${index}, 'costoNolo', parseFloat(this.value) || 0)">
                    </div>
                    <div class="form-group">
                        <label>Distanza da HQ (Km)</label>
                        <input type="number" id="sedeDistanza${index}" min="0" step="0.1" value="${sede.distanzaKm || 0}" placeholder="Km" 
                            onchange="aggiornaSede(${index}, 'distanzaKm', parseFloat(this.value) || 0)">
                    </div>
                    <div class="form-group">
                        <button type="button" class="danger" onclick="rimuoviSede(${index})">Elimina</button>
                    </div>
                </div>
                
                `;
            sediListDiv.appendChild(divWrapper);
        }

        function aggiornaSede(index, field, value) {
            if (fornitoreSedi[index]) {
                fornitoreSedi[index][field] = value;
            }
        }

        function rimuoviSede(index) {
            const fornitoreId = document.getElementById('fornitoreId').value;
            
            // In modalità modifica, controlla se la sede che stai eliminando è associata a un Lab
            if (fornitoreId) {
                const sedeIdCheck = `${fornitoreId}_${index}`;
                // Non devo filtrare sulla cache completa, ma solo sull'indice
                const labsAssociati = labsCache.filter(lab => lab.idSede === sedeIdCheck);
                
                if (labsAssociati.length > 0) {
                    alert(`Impossibile rimuovere questa Sede. Sono presenti ${labsAssociati.length} Labs associati.`);
                    return;
                }
            }

            if (confirm("Sei sicuro di voler rimuovere questa Sede?")) {
                fornitoreSedi.splice(index, 1);
                ricaricaListaSedi();
            }
        }
        
        // --- GESTIONE AUTENTICAZIONE E INIZIALIZZAZIONE ---
        auth.onAuthStateChanged((user) => {
            const dashboardContainer = document.getElementById('dashboardContainer');

            if (user) {
                dashboardContainer.style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                caricaFornitori(); 
            } else {
                dashboardContainer.style.display = 'none';
                window.location.href = '00index.html';
            }
        });
    </script>
</body>
</html>
