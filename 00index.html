<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyPeasy App - Dashboard Gestione Labs</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>
    
    <style>
        /* BASE RESET */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        
        /* LAYOUT PRINCIPALE */
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* NAVBAR / SIDEBAR */
        .dashboard-nav { 
            width: 250px; 
            background-color: #343a40; /* Grigio scuro/Nero */
            color: white; 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex-shrink: 0; 
        }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; transition: transform 0.3s, opacity 0.3s; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 10px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 90%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { 
            color: #ccc; 
            text-decoration: none; 
            padding: 12px 15px; 
            margin: 3px 0; 
            display: block; 
            width: 90%; 
            text-align: left; 
            border-radius: 4px; 
            transition: background-color 0.3s, color 0.3s, padding-left 0.3s; 
        }
        .dashboard-nav a:hover, .dashboard-nav a.active { 
            background-color: #A5DD2E; /* Verde Lime */
            color: #343a40; 
            font-weight: bold; 
            padding-left: 20px; 
        }
        
        /* CONTENUTO PRINCIPALE */
        .dashboard-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        
        /* STATISTICHE KPI */
        .kpi-grid { 
            display: flex; 
            justify-content: space-around; 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .kpi-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 5px solid #A5DD2E;
        }
        .kpi-card h2 { margin: 0 0 10px 0; font-size: 1.2em; color: #555; }
        .kpi-value { font-size: 2.5em; font-weight: bold; color: #343a40; }
        
        /* TABELLA E LISTA */
        .data-section { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            margin-bottom: 30px;
        }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr:hover { background-color: #f9f9f9; }
        .azione-tabella { width: 100px; text-align: center; }
        
        #listaLabs { list-style: none; padding: 0; }
        #listaLabs li { 
            background: #f9f9f9; 
            margin-bottom: 10px; 
            padding: 15px; 
            border-radius: 4px; 
            border-left: 4px solid #343a40; 
        }
        
        /* AUTH SCREEN */
        .auth-container { 
            height: 100vh; 
            justify-content: center; 
            align-items: center; 
            background-color: #e0e0e0; 
        }
        .auth-box { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            width: 300px;
        }
        .auth-box input { 
            margin-bottom: 15px; 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 4px;
        }
        .auth-box button {
            width: 100%; 
            background-color: #A5DD2E; 
            border: none; 
            padding: 10px;
            color: #343a40;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2 style="text-align: center; color: #A5DD2E;">EPApp Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button onclick="handleLogin()">Accedi</button>
            <p id="authMessage" style="color: red; text-align: center; margin-top: 10px;"></p>
        </div>
    </div>

    <div class="dashboard-container" style="display: none;">
        
        <nav class="dashboard-nav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link active">Dashboard</a> 

            <small>Monitoraggio Labs</small><hr>
            <a href="03labs.html" class="tab-link">Labs & Attività</a> 
            <a href="04logistica.html" class="tab-link">Costi Logistica</a> 
            
            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">Clienti & Iscrizioni</a> 
            <a href="02fornitori.html" class="tab-link">Fornitori & Sedi</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">Preventivi & Fatture</a> 
            <a href="06stats.html" class="tab-link">Statistiche & KPI</a> 
            
            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto;">Logout</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Riepilogo Generale</h1>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h2>Labs Attivi</h2>
                    <p id="statLabsAttivi" class="kpi-value">...</p>
                </div>
                <div class="kpi-card">
                    <h2>Totale Iscritti</h2>
                    <p id="statTotaleIscritti" class="kpi-value">...</p>
                </div>
                <div class="kpi-card">
                    <h2>Entrate Totali (Netto)</h2>
                    <p id="statEntrate" class="kpi-value">...</p>
                </div>
                <div class="kpi-card">
                    <h2>Uscite Totali (Costi Vivi)</h2>
                    <p id="statUscite" class="kpi-value">...</p>
                </div>
            </div>

            <div class="data-section">
                <h3>Calendario Prossimi Labs</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome Lab</th>
                            <th>Data</th>
                            <th>Sede</th>
                            <th>Cliente</th>
                            <th class="azione-tabella">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tabellaProssimiLabsBody">
                        </tbody>
                </table>
            </div>
            
            <div class="data-section">
                <h3>Ultimi Clienti Iscritti</h3>
                <ul id="listaLabs">
                    </ul>
            </div>
        </main>
    </div>

    <script>
        // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaProssimiLabsBody = document.getElementById('tabellaProssimiLabsBody');
        const listaLabs = document.getElementById('listaLabs');

        // --- GESTIONE AUTENTICAZIONE (Completa) ---
        
        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            document.getElementById('authMessage').textContent = ''; // Reset message

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // Successo gestito da onAuthStateChanged
                })
                .catch((error) => {
                    let message = "Errore di login. Credenziali non valide.";
                    if (error.code === 'auth/user-not-found') {
                        message = "Nessun utente trovato con questa email.";
                    } else if (error.code === 'auth/wrong-password') {
                        message = "Password errata.";
                    }
                    document.getElementById('authMessage').textContent = message;
                    console.error("Login Error:", error);
                });
        }
        
        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.reload(); 
            }); 
        }
        
        auth.onAuthStateChanged((user) => {
            const authScreen = document.getElementById('authScreen');
            const dashboardContainer = document.querySelector('.dashboard-container');

            if (user) {
                authScreen.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                // Carica i dati solo dopo l'autenticazione
                caricaStatisticheKPI();
                caricaProssimiLabs(); 
                caricaUltimiIscritti(); 
            } else {
                authScreen.style.display = 'flex';
                dashboardContainer.style.display = 'none';
            }
        });

        // =========================================================================
        // === FUNZIONI DI CARICAMENTO DATI ===
        // =========================================================================

        /**
         * CORREZIONE 404: Corretta la generazione della riga e del link per puntare a 03labs.html.
         */
        function caricaProssimiLabs() {
            tabellaProssimiLabsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Caricamento Prossimi Labs...</td></tr>';

            // Labs con dataFine nel futuro, ordinati cronologicamente, limite 5
            db.collection("labs")
                .where("dataFine", ">=", firebase.firestore.Timestamp.fromDate(new Date()))
                .orderBy("dataFine", "asc")
                .limit(5)
                .get()
                .then(snapshot => {
                    tabellaProssimiLabsBody.innerHTML = '';
                    if (snapshot.empty) {
                        tabellaProssimiLabsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nessun Lab programmato in arrivo.</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const labId = doc.id;
                        
                        const row = tabellaProssimiLabsBody.insertRow();
                        
                        // Assumiamo che dataInizio sia un Timestamp
                        const dataInizio = data.dataInizio ? new Date(data.dataInizio.toDate()).toLocaleDateString('it-IT') : 'N/D';
                        
                        // POPOLAMENTO DELLE CELLE (Era mancante)
                        row.insertCell().textContent = data.nomeLab || 'N/D';
                        row.insertCell().textContent = dataInizio; 
                        row.insertCell().textContent = data.sedeNome || 'N/D'; 
                        row.insertCell().textContent = data.clienteNome || 'N/D'; 
                        
                        const actionCell = row.insertCell();
                        actionCell.className = 'azione-tabella';
                        
                        // CORREZIONE CRITICA DEL LINK (risolve l'errore 404)
                        actionCell.innerHTML = `
                            <a href="03labs.html?labId=${labId}" class="primary" style="text-decoration: none; padding: 5px 10px; font-size: 0.9em; background-color: #A5DD2E; color: #343a40; border-radius: 4px;">Dettagli</a>
                        `;
                    });

                }).catch(error => {
                    console.error("Errore nel caricamento dei Prossimi Labs: ", error);
                    tabellaProssimiLabsBody.innerHTML = '<tr><td colspan="5" style="color: red; text-align: center;">Errore nel caricamento dei dati Lab.</td></tr>';
                });
        }

        function caricaStatisticheKPI() {
            // Stats Labs Attivi (Assumendo 'stato' come campo)
            db.collection("labs").where("stato", "in", ["attivo", "in preparazione"]).get().then(snapshot => {
                document.getElementById('statLabsAttivi').textContent = snapshot.size;
            });

            // Stats Totale Iscritti (Assumendo 'iscrizioni' come collezione)
            db.collection("iscrizioni").get().then(snapshot => {
                document.getElementById('statTotaleIscritti').textContent = snapshot.size;
            });

            // Stats Entrate (Esempio: 50€ per iscritto pagante)
            db.collection("iscrizioni").where("pagato", "==", true).get().then(snapshot => {
                let entrate = 0;
                snapshot.forEach(doc => {
                    // Dovresti usare il campo 'costoIscrizione' se esiste. Uso 50 come fallback.
                    entrate += 50; 
                });
                document.getElementById('statEntrate').textContent = `€ ${entrate.toFixed(2).replace('.', ',')}`;
            });
            
            // Stats Uscite (Costi Vivi - Logistica + Materiali)
             db.collection("labs").get().then(snapshot => {
                let uscite = 0;
                snapshot.forEach(doc => {
                    const lab = doc.data();
                    // Assumiamo che costoLogistico e costoMateriali siano campi numerici nel documento Lab
                    uscite += (lab.costoLogistico || 0) + (lab.costoMateriali || 0);
                });
                document.getElementById('statUscite').textContent = `€ ${uscite.toFixed(2).replace('.', ',')}`;
            });
        }

        function caricaUltimiIscritti() {
            listaLabs.innerHTML = '<li>Caricamento ultimi iscritti...</li>';
            
            // Ordina per data di iscrizione (campo 'dataIscrizione', in questo caso)
            db.collection("iscrizioni").orderBy("dataIscrizione", "desc").limit(5).get().then(snapshot => {
                listaLabs.innerHTML = '';
                if (snapshot.empty) {
                    listaLabs.innerHTML = '<li>Nessun iscritto recente trovato.</li>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const dataIscrizione = data.dataIscrizione ? new Date(data.dataIscrizione.toDate()).toLocaleDateString('it-IT') : 'N/D';
                    
                    // Assumiamo che l'iscrizione contenga i campi nomeCliente e nomeLab
                    const listItem = document.createElement('li');
                    listItem.textContent = `Iscrizione di ${data.nomeCliente || 'Cliente Sconosciuto'} per Lab: ${data.nomeLab || 'N/D'} - Data: ${dataIscrizione}`;
                    listaLabs.appendChild(listItem);
                });
            }).catch(error => {
                console.error("Errore nel caricamento degli Ultimi Iscritti: ", error);
                listaLabs.innerHTML = '<li>Errore nel caricamento dei dati.</li>';
            });
        }
        
    </script>
</body>
</html>
