<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Dashboard Gestione Labs</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>
    
    <style>
        /* BASE RESET */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        
        /* LAYOUT PRINCIPALE */
        .dashboard-container { display: none; min-height: 100vh; }
        
        /* NAVBAR / SIDEBAR */
        .dashboard-nav { 
            width: 250px; 
            background-color: #343a40; /* Grigio scuro/Nero */
            color: white; 
            padding: 20px 0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex-shrink: 0;
        }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { 
            color: #ccc; 
            text-decoration: none; 
            padding: 12px 15px; 
            margin: 3px 0; 
            display: block; 
            width: 85%; 
            text-align: left; 
            border-radius: 4px; 
            transition: background-color 0.3s, padding-left 0.3s; 
        }
        .dashboard-nav a:hover, .dashboard-nav a.active { 
            background-color: #A5DD2E; /* Verde Lime */
            color: #343a40; 
            font-weight: bold; 
            padding-left: 20px; 
        }

        /* CONTENUTO DASHBOARD */
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .stat-card h3 { color: #A5DD2E; margin-top: 0; font-size: 1.1em; }
        .stat-card p { font-size: 2em; font-weight: bold; margin: 5px 0 0 0; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .lista-labs { list-style: none; padding: 0; }
        .lista-labs li { padding: 10px; border-bottom: 1px solid #eee; }
        
        /* LOGIN/AUTH SCREEN */
        .auth-screen { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background-color: #343a40;
        }
        .login-box {
            background: white; 
            padding: 40px; 
            border-radius: 10px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .login-box h2 { color: #343a40; margin-bottom: 25px; }
        .login-box input { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box; 
        }
        .login-box button {
            width: 100%; 
            padding: 12px; 
            background-color: #A5DD2E; 
            color: #343a40; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover { background-color: #72a31f; color: white; }
        .error-message { color: red; margin-top: 10px; }

        /* RESPONSIVITÀ MOBILE */
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; }
            .dashboard-content { padding: 15px; }
            .stat-grid { grid-template-columns: 1fr; }

            .mobile-header { 
                display: flex; justify-content: space-between; align-items: center; 
                padding: 10px 15px; background-color: white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500;
            }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }

            .dashboard-nav {
                position: fixed; top: 0; left: -250px; 
                height: 100%; z-index: 1000; transition: left 0.3s ease;
            }
            .dashboard-nav.open { left: 0; }
            .dashboard-nav a { width: 90%; }
            .logo-link { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-screen">
        <div class="login-box">
            <h2>Accesso EPApp Dashboard</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit">ACCEDI</button>
            </form>
            <p id="authError" class="error-message"></p>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContainer">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Dashboard</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link active">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Riepilogo Generale</h1>

            <div class="stat-grid">
                <div class="stat-card">
                    <h3>Labs Attivi/In Prep.</h3>
                    <p id="statLabsAttivi">0</p>
                </div>
                <div class="stat-card">
                    <h3>Totale Iscritti</h3>
                    <p id="statTotaleIscritti">0</p>
                </div>
                <div class="stat-card">
                    <h3>Entrate (Pagate)</h3>
                    <p id="statEntrate">€ 0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Costi Totali (stimati)</h3>
                    <p id="statUscite">€ 0.00</p>
                </div>
            </div>

            <div class="data-section">
                <h2>Labs in Prossimità</h2>
                <div style="margin-bottom: 15px;">
                    <label for="filtroStato">Filtra per Stato:</label>
                    <select id="filtroStato" onchange="caricaLabsBreve()">
                        <option value="all">Tutti</option>
                        <option value="in preparazione" selected>In Preparazione</option>
                        <option value="attivo">Attivi</option>
                    </select>
                </div>
                <ul class="lista-labs" id="listaLabs">
                    <li>Caricamento labs...</li>
                </ul>
            </div>
        </main>
    </div>

    <script>
        // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const authScreen = document.getElementById('authScreen');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginForm = document.getElementById('loginForm');
        const authError = document.getElementById('authError');
        const dashboardNav = document.getElementById('dashboardNav');
        const listaLabs = document.getElementById('listaLabs');

        // --- FUNZIONI NAVIGAZIONE MOBILE ---
        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        // --- GESTIONE AUTENTICAZIONE ---

        // Login Handler
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            authError.textContent = '';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Successo gestito da onAuthStateChanged
                })
                .catch((error) => {
                    let errorMessage = "Errore di accesso.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Email o password non validi.';
                    }
                    authError.textContent = errorMessage;
                });
        });

        function handleLogout() { 
            auth.signOut().then(() => { 
                // Logout gestito da onAuthStateChanged
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        // Listener dello stato di Autenticazione (Protezione e Inizializzazione)
        auth.onAuthStateChanged((user) => {
            if (user) {
                authScreen.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                // Nascondi Logout link mobile se in modalità desktop
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                
                // Carica dati dashboard
                caricaStatisticheKPI();
                caricaLabsBreve();
            } else {
                authScreen.style.display = 'flex'; 
                dashboardContainer.style.display = 'none';
            }
        });

        // --- FUNZIONI CARICAMENTO DATI DASHBOARD ---
        
        // Carica lista Labs per riepilogo
        function caricaLabsBreve() {
            listaLabs.innerHTML = '<li>Caricamento Labs...</li>';
            const statoFiltro = document.getElementById('filtroStato').value;
            
            let query = db.collection("labs").orderBy("dataInizio", "asc");

            if (statoFiltro !== 'all') {
                query = query.where("statoLab", "==", statoFiltro);
            }
            
            query.limit(5).get().then(snapshot => {
                listaLabs.innerHTML = '';
                if (snapshot.size > 0) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const dataInizio = data.dataInizio ? new Date(data.dataInizio.toDate()).toLocaleDateString('it-IT') : 'N/D';
                        const item = document.createElement('li');
                        item.innerHTML = `<strong>${data.nomeLab || 'Lab Senza Nome'}</strong> - Sede: ${data.sedeNome || 'N/D'} - Inizio: ${dataInizio} <span style="float:right; color:#A5DD2E;">(${data.statoLab.toUpperCase()})</span>`;
                        listaLabs.appendChild(item);
                    });
                } else {
                    listaLabs.innerHTML = '<li>Nessun Lab trovato con i filtri selezionati.</li>';
                }
            }).catch(error => {
                console.error("Errore nel caricamento Labs brevi:", error);
                listaLabs.innerHTML = '<li>Errore nel caricamento.</li>';
            });
        }

        // Carica KPI
        function caricaStatisticheKPI() {
            // Stats Labs Attivi/In Prep.
            db.collection("labs").where("statoLab", "in", ["attivo", "in preparazione"]).get().then(snapshot => {
                document.getElementById('statLabsAttivi').textContent = snapshot.size;
            });

            // Stats Iscritti Totali
            db.collection("iscrizioni").get().then(snapshot => {
                document.getElementById('statTotaleIscritti').textContent = snapshot.size;
            });

            // Stats Entrate (Esempio: somma preventivi finali pagati)
            db.collection("labs").where("statoFattura", "==", "pagato").get().then(snapshot => {
                let entrate = 0;
                snapshot.forEach(doc => {
                    const lab = doc.data();
                    entrate += (lab.preventivoFinale || 0); 
                });
                document.getElementById('statEntrate').textContent = `€ ${entrate.toFixed(2)}`;
            });
            
            // Stats Uscite (Costi Totali Fabbisogno)
             db.collection("labs").get().then(snapshot => {
                let uscite = 0;
                snapshot.forEach(doc => {
                    const lab = doc.data();
                    uscite += (lab.costoTotaleFabbisogno || 0); 
                });
                document.getElementById('statUscite').textContent = `€ ${uscite.toFixed(2)}`;
            });
        }
    </script>
</body>
</html>
