<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyPeasy App - Dashboard Gestione Labs</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <style>
        /* BASE RESET */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        
        /* LAYOUT PRINCIPALE */
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* NAVBAR / SIDEBAR */
        .dashboard-nav { 
            width: 250px; 
            background-color: #343a40; /* Grigio scuro/Nero */
            color: white; 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex-shrink: 0; 
        }
        
        /* LOGO */
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; transition: transform 0.3s, opacity 0.3s; }
        .logo-link img:hover { opacity: 0.8; transform: scale(1.02); }
        
        /* SEPARATORI E TITOLI PICCOLI */
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 10px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 90%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        
        /* LINK DI NAVIGAZIONE */
        .dashboard-nav a { 
            color: #ccc; 
            text-decoration: none; 
            padding: 12px 15px; 
            margin: 3px 0; 
            display: block; 
            width: 90%; 
            text-align: left; 
            border-radius: 4px; 
            transition: background-color 0.3s, color 0.3s, padding-left 0.3s; 
        }
        .dashboard-nav a:hover, .dashboard-nav a.active { 
            background-color: #A5DD2E; /* Verde Limone EPApp */
            color: #343a40; 
            font-weight: bold; 
            padding-left: 20px; 
        }
        
        /* CONTENUTO PRINCIPALE */
        .dashboard-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .tab-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 30px; }
        
        /* BOX STATISTICHE HOME */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { 
            background-color: #ffffff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #A5DD2E; 
        }
        .stat-box h3 { margin: 0 0 10px 0; font-size: 1em; color: #666; }
        .stat-box p { margin: 0; font-size: 2em; font-weight: bold; color: #343a40; }
        
        /* LISTE E TABELLE */
        ul { list-style: none; padding: 0; }
        .lab-list li, .anagrafe-list li {
            background-color: #ffffff;
            border: 1px solid #eee;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lab-list li strong { color: #A5DD2E; }

        /* FILTRI E FORM GENERICI */
        .filter-section { margin-bottom: 20px; padding: 15px; background-color: #f8f8f8; border-radius: 4px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }

        /* BOTTONI */
        button.primary, button.secondary { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s, transform 0.2s; 
        }
        button.primary { background-color: #A5DD2E; color: #343a40; }
        button.secondary { background-color: #e0e0e0; color: #343a40; border: 1px solid #ccc; font-weight: normal; }
        button.primary:hover { background-color: #8ac41f; transform: translateY(-1px); }
        button.secondary:hover { background-color: #d0d0d0; transform: translateY(-1px); }

        /* MEDIA QUERIES (RESPONSIVE) */
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .dashboard-nav { width: 100%; height: auto; padding: 10px 0; flex-direction: row; flex-wrap: wrap; justify-content: space-around; }
            .dashboard-nav a { width: 45%; text-align: center; margin: 5px 0; padding: 8px 10px; }
            .dashboard-nav a:hover, .dashboard-nav a.active { padding-left: 10px; }
            .dashboard-nav small, .dashboard-nav hr { display: none; }
            .logo-link { width: 100%; text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #495057; }
            .dashboard-content { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="authScreen" style="display: none; height: 100vh; justify-content: center; align-items: center; background-color: #e0e0e0;">
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <h2 style="text-align: center; color: #A5DD2E;">EPApp Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required style="margin-bottom: 10px;">
            <input type="password" id="loginPassword" placeholder="Password" required style="margin-bottom: 20px;">
            <button class="primary" onclick="handleLogin()" style="width: 100%;">Accedi</button>
            <p id="authMessage" style="color: red; text-align: center; margin-top: 10px;"></p>
        </div>
    </div>

    <div class="dashboard-container" style="display: none;">
        
        <nav class="dashboard-nav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a> 
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link active">Dashboard</a> 

            <small>Monitoraggio Labs</small><hr>
            <a href="03labs.html" class="tab-link">Labs & Attività</a> 
            <a href="04logistica.html" class="tab-link">Logistica & Materiali</a> 
            
            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">Clienti & Iscrizioni</a> <a href="02fornitori.html" class="tab-link">Fornitori & Sedi</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">Preventivi & Fatture</a> 
            <a href="06stats.html" class="tab-link">Statistiche & KPI</a> 
            
            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto;">Logout</a>
        </nav>

        <main class="dashboard-content">
            <h1>Riepilogo Generale</h1>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <h3>Labs Attivi (Oggi/Prossimi)</h3>
                    <p id="statLabsAttivi">0</p>
                </div>
                <div class="stat-box">
                    <h3>Totale Iscritti</h3>
                    <p id="statTotaleIscritti">0</p>
                </div>
                <div class="stat-box">
                    <h3>Totale Entrate (Pagate)</h3>
                    <p id="statEntrate">€ 0.00</p>
                </div>
                <div class="stat-box">
                    <h3>Totale Uscite (Costi Vivi)</h3>
                    <p id="statUscite">€ 0.00</p>
                </div>
            </div>

            <div class="tab-content">
                <h2>Calendario Prossimi Labs</h2>
                <div class="filter-section">
                    <div class="form-grid">
                        <div class="form-group"><label for="filterMese">Filtra per Mese:</label><select id="filterMese" onchange="filtraLabs()"><option value="">Tutti i Mesi</option></select></div>
                        <div class="form-group"><label for="filterStato">Filtra per Stato:</label><select id="filterStato" onchange="filtraLabs()"><option value="">Tutti gli Stati</option><option value="in preparazione">In Prep.</option><option value="attivo">Attivo</option><option value="completato">Completato</option></select></div>
                    </div>
                    <p style="margin-top: 15px; font-weight: bold;" id="risultatoFiltri">Labs trovati: 0</p>
                </div>
                
                <ul id="listaLabs" class="lab-list">
                    <li>Caricamento Labs in corso...</li>
                </ul>
            </div>
            
        </main>
    </div>

    <script>
        // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        let labsCache = {}; 
        
        // --- FUNZIONI DI AUTENTICAZIONE (Comuni a tutti i file) ---
        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {})
                .catch((error) => {
                    document.getElementById('authMessage').textContent = `Errore di login: ${error.message}`;
                });
        }
        function handleLogout() {
            auth.signOut().then(() => { window.location.reload(); });
        }
        
        // Listener per lo stato di autenticazione
        auth.onAuthStateChanged((user) => {
            const authScreen = document.getElementById('authScreen');
            const dashboardContainer = document.querySelector('.dashboard-container');
            const logoutLink = document.getElementById('logoutLink');
            
            if (user) {
                if(authScreen) authScreen.style.display = 'none';
                if(dashboardContainer) dashboardContainer.style.display = 'flex';
                if(logoutLink) logoutLink.textContent = `Logout (${user.email})`;
                inizializzaDashboard();
            } else {
                if(authScreen) authScreen.style.display = 'flex';
                if(dashboardContainer) dashboardContainer.style.display = 'none';
                if(authScreen) {
                    authScreen.style.display = 'flex'; 
                    dashboardContainer.style.display = 'none';
                }
            }
        });

        // --- FUNZIONI SPECIFICHE DASHBOARD (OMESSE per brevità, sono le stesse del passo precedente) ---
        function inizializzaDashboard() {
            caricaMesiFiltro();
            caricaLabs();
            caricaStatisticheKPI();
        }

        function caricaMesiFiltro() {
            const mesi = [
                { val: '01', nome: 'Gennaio' }, { val: '02', nome: 'Febbraio' }, { val: '03', nome: 'Marzo' },
                { val: '04', nome: 'Aprile' }, { val: '05', nome: 'Maggio' }, { val: '06', nome: 'Giugno' },
                { val: '07', nome: 'Luglio' }, { val: '08', nome: 'Agosto' }, { val: '09', nome: 'Settembre' },
                { val: '10', nome: 'Ottobre' }, { val: '11', nome: 'Novembre' }, { val: '12', nome: 'Dicembre' }
            ];
            const select = document.getElementById('filterMese');
            mesi.forEach(mese => {
                const option = document.createElement('option');
                option.value = mese.val;
                option.textContent = mese.nome;
                select.appendChild(option);
            });
            const meseCorrente = new Date().getMonth() + 1;
            select.value = meseCorrente < 10 ? '0' + meseCorrente : '' + meseCorrente;
        }

        function caricaLabs() {
            db.collection("labs").orderBy("data").get().then((querySnapshot) => {
                labsCache = {};
                querySnapshot.forEach((doc) => {
                    labsCache[doc.id] = doc.data();
                });
                filtraLabs();
            }).catch(error => {
                console.error("Errore nel caricamento dei Labs: ", error);
                document.getElementById('listaLabs').innerHTML = '<li>Errore nel caricamento dei dati dei Labs.</li>';
            });
        }

        function filtraLabs() {
            const listaLabs = document.getElementById('listaLabs');
            listaLabs.innerHTML = '';
            
            const filtroMese = document.getElementById('filterMese').value;
            const filtroStato = document.getElementById('filterStato').value;
            let count = 0;

            const labsOrdinati = Object.keys(labsCache).sort((a, b) => {
                const dataA = labsCache[a].data;
                const dataB = labsCache[b].data;
                if (dataA < dataB) return -1;
                if (dataA > dataB) return 1;
                return 0;
            });
            
            labsOrdinati.forEach(labId => {
                const lab = labsCache[labId];
                const dataLab = lab.data || 'N/D'; 
                const meseLab = dataLab.substring(5, 7); 

                const matchMese = !filtroMese || meseLab === filtroMese;
                const matchStato = !filtroStato || lab.stato === filtroStato;

                if (matchMese && matchStato) {
                    count++;
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>${lab.nome || 'Lab Senza Nome'}</strong> (${lab.tipo || 'Tipo N/D'})<br>
                            <small>Data: ${dataLab} | Stato: ${lab.stato || 'N/D'} | Sede: ${lab.sedeId || 'N/D'}</small>
                        </div>
                        <div>
                            <button class="primary" onclick="window.location.href='labs.html?id=${labId}'">Dettagli</button>
                        </div>
                    `;
                    listaLabs.appendChild(li);
                }
            });
            
            document.getElementById('risultatoFiltri').textContent = `Labs trovati: ${count}`;

            if (count === 0) {
                 listaLabs.innerHTML = '<li>Nessun Lab trovato con i filtri selezionati.</li>';
            }
        }

        function caricaStatisticheKPI() {
            // Stats Labs Attivi
            db.collection("labs").where("stato", "in", ["attivo", "in preparazione"]).get().then(snapshot => {
                document.getElementById('statLabsAttivi').textContent = snapshot.size;
            });

            // Stats Iscritti 
            db.collection("iscrizioni").get().then(snapshot => {
                document.getElementById('statTotaleIscritti').textContent = snapshot.size;
            });

            // Stats Entrate (Esempio)
            db.collection("iscrizioni").where("pagato", "==", true).get().then(snapshot => {
                let entrate = 0;
                snapshot.forEach(doc => {
                    entrate += 50; 
                });
                document.getElementById('statEntrate').textContent = `€ ${entrate.toFixed(2)}`;
            });
            
            // Stats Uscite (Costi Vivi)
             db.collection("labs").get().then(snapshot => {
                let uscite = 0;
                snapshot.forEach(doc => {
                    const lab = doc.data();
                    uscite += (lab.costoLogistico || 0) + (lab.costoMateriali || 0);
                });
                document.getElementById('statUscite').textContent = `€ ${uscite.toFixed(2)}`;
            });
        }
    </script>
</body>
</html>