<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Labs & Attività</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* [Stili CSS base identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 30px; }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 3% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .full-width { grid-column: 1 / -1; } /* Campo su tutta la larghezza */

        /* Stili specifici per la gestione Attività */
        .attivita-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 100px; 
            gap: 10px; 
            align-items: end; 
            margin-bottom: 15px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .materiali-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .materiali-table th, .materiali-table td { padding: 8px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }


        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .form-grid { grid-template-columns: 1fr; }
            .attivita-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 10% 5%; width: 90%; max-width: 90%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Labs & Attività</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link active">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Labs</h1>

            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLab(null)">➕ Crea Nuovo Lab</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice Lab</th>
                                <th>Nome Lab</th>
                                <th>Cliente</th>
                                <th>Sede</th>
                                <th>Inizio</th>
                                <th>Durata (Sett.)</th>
                                <th>Costo Totale (€)</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLabsBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <h1>Catalogo Attività</h1>
            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleAttivita(null)">➕ Aggiungi Nuova Attività</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome Breve</th>
                                <th>Tipologia</th>
                                <th>Costo Base Materiali (€)</th>
                                <th>Materiali Richiesti</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaAttivitaBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="labModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLab()">&times;</span>
            <h2 id="labModalTitle">Crea Nuovo Lab</h2>
            <form id="labForm">
                <input type="hidden" id="labId" value="">
                
                <h3>Dettagli Base Lab</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="codiceLab">Codice Lab (es. RM_2025_01)</label>
                        <input type="text" id="codiceLab" required>
                    </div>
                    <div class="form-group">
                        <label for="nomeLab">Nome Lab</label>
                        <input type="text" id="nomeLab" required>
                    </div>
                    <div class="form-group">
                        <label for="statoLab">Stato</label>
                        <select id="statoLab">
                            <option value="preventivo">Preventivo</option>
                            <option value="in_preparazione">In Preparazione</option>
                            <option value="attivo">Attivo</option>
                            <option value="concluso">Concluso</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idCliente">Cliente</label>
                        <select id="idCliente" required>
                            <option value="">Seleziona Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idSede">Sede del Lab</label>
                        <select id="idSede" required>
                            <option value="">Seleziona Sede</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataInizio">Data Inizio</label>
                        <input type="date" id="dataInizio" required>
                    </div>
                    <div class="form-group">
                        <label for="durataSettimane">Durata (Settimane)</label>
                        <input type="number" id="durataSettimane" min="1" value="1" required>
                    </div>
                </div>

                <h3>Attività Associate</h3>
                <div class="full-width">
                    <div id="attivitaList">
                        </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="primary" onclick="aggiungiAttivitaLab()">➕ Aggiungi Attività</button>
                    </div>
                </div>

                <div class="full-width" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h3>Riepilogo Costi</h3>
                    <p>Costo totale Labs (Materiali + Costo Sede/Nolo): <strong id="costoTotaleLab">€ 0.00</strong></p>
                    <p style="font-size: 0.85em; color: #888;">* I costi sono aggiornati in tempo reale in base alle Attività e alla Sede selezionate.</p>
                </div>

                <div class="modal-buttons" style="margin-top: 20px; text-align: right;">
                    <button type="button" onclick="chiudiModaleLab()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Lab</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="attivitaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleAttivita()">&times;</span>
            <h2 id="attivitaModalTitle">Aggiungi Nuova Attività</h2>
            <form id="attivitaForm">
                <input type="hidden" id="attivitaId" value="">
                
                <h3>Dettagli Attività</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="codiceAttivita">Codice Attività (es. ACT_MECC)</label>
                        <input type="text" id="codiceAttivita" required>
                    </div>
                    <div class="form-group">
                        <label for="nomeBreve">Nome Breve</label>
                        <input type="text" id="nomeBreve" required>
                    </div>
                    <div class="form-group">
                        <label for="tipologiaAttivita">Tipologia</label>
                        <select id="tipologiaAttivita" required>
                            <option value="">Seleziona Tipologia</option>
                            </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="descrizioneDettagliata">Descrizione Dettagliata</label>
                        <textarea id="descrizioneDettagliata" rows="2"></textarea>
                    </div>
                </div>

                <h3>Fabbisogno Materiali</h3>
                <div id="materialiRichiestiList">
                    </div>
                <div style="margin-top: 10px;">
                    <button type="button" class="primary" onclick="aggiungiMateriale()">➕ Aggiungi Materiale</button>
                </div>

                <div class="modal-buttons" style="margin-top: 20px; text-align: right;">
                    <button type="button" onclick="chiudiModaleAttivita()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Attività</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // CONFIGURAZIONE FIREBASE
        // ⚠️ SOSTITUISCI QUESTO OGGETTO CON LA TUA CONFIGURAZIONE REALE DI FIREBASE ⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaLabsBody = document.getElementById('tabellaLabsBody');
        const labModal = document.getElementById('labModal');
        const labForm = document.getElementById('labForm');
        const tabellaAttivitaBody = document.getElementById('tabellaAttivitaBody');
        const attivitaModal = document.getElementById('attivitaModal');
        const attivitaForm = document.getElementById('attivitaForm');
        const materialiRichiestiList = document.getElementById('materialiRichiestiList');
        const attivitaListDiv = document.getElementById('attivitaList');
        const selectIdCliente = document.getElementById('idCliente');
        const selectIdSede = document.getElementById('idSede');
        
        // Cache per dati esterni
        let clientiCache = []; 
        let sediCache = []; // Cache Sedi (Fornitore + Sede)
        let attivitaCatalogoCache = []; // Cache Catalogo Attività
        let materialiInventarioCache = []; // Cache Inventario
        
        // Dati temporanei Modali
        let materialiRichiesti = []; 
        let labAttivita = []; 

        // Costanti
        const TIPOLOGIE_ATTIVITA = ["Tecnologico", "Manuale", "Creativo", "Fisico", "Team Building", "Altro"];

        // --- FUNZIONI UTILITY ---
        function formatNumber(value) {
             return parseFloat(value || 0).toFixed(2);
        }

        function toggleNav() {
            document.getElementById('dashboardNav').classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        function populateTipologiaSelect() {
            const select = document.getElementById('tipologiaAttivita');
            select.innerHTML = '<option value="">Seleziona Tipologia</option>';
            TIPOLOGIE_ATTIVITA.forEach(tipologia => {
                const option = document.createElement('option');
                option.value = tipologia.toLowerCase().replace(' ', '_');
                option.textContent = tipologia;
                select.appendChild(option);
            });
        }

        // --- GESTIONE CACHE E SELECT ---

        async function caricaClientiPerSelect() {
            try {
                const snapshot = await db.collection("clienti").get();
                clientiCache = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ragSoc: doc.data().anagrafe.ragSoc || 'Cliente N/D'
                }));
                
                selectIdCliente.innerHTML = '<option value="">Seleziona Cliente</option>';
                clientiCache.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.ragSoc;
                    selectIdCliente.appendChild(option);
                });
            } catch (error) {
                console.error("Errore nel caricamento cache Clienti:", error);
            }
        }
        
        /**
         * FUNZIONE CRITICA: CORRETTA PER ADATTARSI AI NUOVI CAMPI 'nomeSede' e 'indirizzoSede'
         * (modifiche fatte in 02fornitori.html)
         */
        async function caricaSediPerCache() {
            sediCache = [];
            try {
                const snapshot = await db.collection("fornitori").where("anagrafe.tipoFornitore", "==", "sede").get();
                
                snapshot.forEach(docFornitore => {
                    const fornitoreId = docFornitore.id;
                    const ragSocFornitore = docFornitore.data().anagrafe.ragSoc || 'Fornitore N/D';
                    const sedi = docFornitore.data().sedi || [];
                    
                    sedi.forEach((sede, index) => {
                        // Costruisce il nome della sede usando i NUOVI campi
                        const nomeSedeCompleto = sede.nomeSede 
                                ? `${sede.nomeSede} - ${sede.indirizzoSede || 'Indirizzo N/D'}` 
                                : (sede.nome ? `${sede.nome} - ${ragSocFornitore}` : `Sede ${index + 1}`);

                        sediCache.push({
                            // ID della sede è la concatenazione: ID_FORNITORE_INDEX
                            id: `${fornitoreId}_${index}`,
                            nomeDisplay: nomeSedeCompleto,
                            costoNolo: parseFloat(sede.costoNolo) || 0,
                            distanzaKm: parseFloat(sede.distanzaKm) || 0
                        });
                    });
                });
                
                // Popola la Select dopo aver popolato la cache
                caricaSediPerSelect(); 

            } catch (error) {
                console.error("Errore nel caricamento cache Sedi:", error);
            }
        }

        function caricaSediPerSelect() {
            selectIdSede.innerHTML = '<option value="">Seleziona Sede</option>';
            sediCache.forEach(sede => {
                const option = document.createElement('option');
                option.value = sede.id;
                // La proprietà 'nomeDisplay' è stata creata apposta per questo scopo
                option.textContent = `${sede.nomeDisplay} (Fornitore: ${sediCache.find(s => s.id === sede.id) ? sediCache.find(s => s.id === sede.id).nomeDisplay.split(' - ')[1] : 'N/D'})`;
                
                // Un po' più semplice:
                option.textContent = sede.nomeDisplay;

                selectIdSede.appendChild(option);
            });
        }
        
        async function caricaMaterialiPerSelect() {
            try {
                const snapshot = await db.collection("inventario").get();
                materialiInventarioCache = snapshot.docs.map(doc => ({
                    id: doc.id,
                    codice: doc.data().codice || 'N/D',
                    nome: doc.data().nome || 'Articolo N/D',
                    costoUnitario: parseFloat(doc.data().costoAcquisto) || 0
                }));
            } catch (error) {
                console.error("Errore nel caricamento cache Inventario:", error);
            }
        }

        async function caricaAttivitaPerCache() {
            try {
                const snapshot = await db.collection("attivita_labs").get();
                attivitaCatalogoCache = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const costoBase = (data.materialiRichiesti || []).reduce((sum, item) => {
                        const materiale = materialiInventarioCache.find(m => m.id === item.idMateriale);
                        return sum + (materiale ? materiale.costoUnitario * item.quantita : 0);
                    }, 0);
                    
                    return {
                        id: doc.id,
                        codice: data.codiceAttivita || 'N/D',
                        nome: data.nomeBreve || 'N/D',
                        materialiRichiesti: data.materialiRichiesti || [],
                        costoBase: costoBase // Costo base materiali calcolato
                    };
                });
            } catch (error) {
                console.error("Errore nel caricamento cache Attività:", error);
            }
        }


        // --- FUNZIONI CRUD LABS ---

        async function caricaLabs() {
            tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Caricamento Labs...</td></tr>';
            
            // Si attende il caricamento delle cache
            await Promise.all([
                caricaClientiPerSelect(), 
                caricaSediPerCache(), 
                caricaMaterialiPerSelect()
            ]);
            await caricaAttivitaPerCache(); // Ricarica Attività dopo Inventario

            db.collection("labs").orderBy("dataInizio", "desc").onSnapshot(snapshot => {
                tabellaLabsBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nessun Lab trovato.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const cliente = clientiCache.find(c => c.id === data.idCliente) || { ragSoc: 'Cliente Sconosciuto' };
                    const sede = sediCache.find(s => s.id === data.idSede) || { nomeDisplay: 'Sede Sconosciuta', costoNolo: 0 };
                    
                    // Calcolo costo totale
                    const costoAttivita = (data.attivita || []).reduce((sum, labAct) => {
                        const catalogoAct = attivitaCatalogoCache.find(a => a.id === labAct.idAttivita);
                        return sum + (catalogoAct ? catalogoAct.costoBase * labAct.quantita : 0);
                    }, 0);
                    
                    // Noleggio = costo sede giornaliero * durata in giorni (assumendo 5 giorni lavorativi/settimana)
                    const costoNolo = sede.costoNolo * (parseInt(data.durataSettimane) || 0) * 5; 
                    const costoTotale = costoAttivita + costoNolo;
                    
                    const row = tabellaLabsBody.insertRow();
                    row.className = 'row';
                    row.onclick = () => apriModaleLab(doc.id, data);
                    
                    row.innerHTML = `
                        <td>${data.codiceLab || 'N/D'}</td>
                        <td>${data.nomeLab || 'N/D'}</td>
                        <td>${cliente.ragSoc}</td>
                        <td>${sede.nomeDisplay.split(' - ')[0]}</td>
                        <td>${data.dataInizio || 'N/D'}</td>
                        <td>${data.durataSettimane || 0}</td>
                        <td>${formatNumber(costoTotale)} €</td>
                        <td>${data.statoLab || 'N/D'}</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleLab('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaLab('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }, error => {
                 tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Errore nel caricamento Labs.</td></tr>';
                 console.error("Errore nel caricamento Labs:", error);
            });
        }

        function apriModaleLab(id = null, data = {}) {
            labForm.reset();
            labAttivita = [];
            attivitaListDiv.innerHTML = '';
            
            document.getElementById('labId').value = id || '';
            document.getElementById('labModalTitle').textContent = id ? 'Modifica Lab' : 'Crea Nuovo Lab';
            
            if (id) {
                document.getElementById('codiceLab').value = data.codiceLab || '';
                document.getElementById('nomeLab').value = data.nomeLab || '';
                document.getElementById('statoLab').value = data.statoLab || 'preventivo';
                document.getElementById('idCliente').value = data.idCliente || '';
                document.getElementById('idSede').value = data.idSede || '';
                document.getElementById('dataInizio').value = data.dataInizio || '';
                document.getElementById('durataSettimane').value = data.durataSettimane || 1;
                
                labAttivita = data.attivita || [];
                ricaricaListaAttivitaLab();
            } else {
                // Nuovo lab: assicurati che il costo sia a zero
                document.getElementById('costoTotaleLab').textContent = '€ 0.00';
            }

            // Aggiorna costo ogni volta che si apre la modale (o si cambia select)
            document.getElementById('idSede').onchange = calcolaCostoTotaleLab;
            document.getElementById('durataSettimane').onchange = calcolaCostoTotaleLab;
            
            calcolaCostoTotaleLab(); 
            labModal.style.display = "block";
        }

        function chiudiModaleLab() {
            labModal.style.display = "none";
        }
        
        labForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const labId = document.getElementById('labId').value;
            const isEditing = !!labId;
            
            const labData = {
                codiceLab: document.getElementById('codiceLab').value,
                nomeLab: document.getElementById('nomeLab').value,
                statoLab: document.getElementById('statoLab').value,
                idCliente: document.getElementById('idCliente').value,
                idSede: document.getElementById('idSede').value,
                dataInizio: document.getElementById('dataInizio').value,
                durataSettimane: parseInt(document.getElementById('durataSettimane').value) || 1,
                attivita: labAttivita 
            };
            
            const collectionRef = db.collection("labs");
            let operation;

            if (isEditing) {
                // Aggiornamento
                operation = collectionRef.doc(labId).update(labData);
            } else {
                // Creazione
                operation = collectionRef.add(labData);
            }
            
            operation.then(() => {
                alert(`Lab ${isEditing ? 'aggiornato' : 'creato'} con successo!`);
                chiudiModaleLab();
                // onSnapshot ricarica automaticamente caricaLabs()
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        function eliminaLab(id) {
            if (confirm("Sei sicuro di voler eliminare questo Lab? L'operazione è irreversibile.")) {
                db.collection("labs").doc(id).delete().then(() => {
                    alert("Lab eliminato con successo!");
                    // onSnapshot ricarica automaticamente caricaLabs()
                }).catch(error => {
                    alert(`Errore nell'eliminazione: ${error.message}`);
                    console.error("Errore:", error);
                });
            }
        }

        // --- GESTIONE ATTIVITÀ LAB (Interno Modale Lab) ---
        
        function ricaricaListaAttivitaLab() {
            attivitaListDiv.innerHTML = '';
            labAttivita.forEach((labAct, index) => {
                aggiungiAttivitaLabHTML(labAct, index);
            });
            calcolaCostoTotaleLab();
        }

        function aggiungiAttivitaLab() {
            labAttivita.push({ idAttivita: '', quantita: 1 });
            ricaricaListaAttivitaLab();
        }

        function aggiungiAttivitaLabHTML(labAct, index) {
            const div = document.createElement('div');
            div.className = 'attivita-grid';
            
            let options = attivitaCatalogoCache.map(act => 
                `<option value="${act.id}" ${labAct.idAttivita === act.id ? 'selected' : ''}>${act.codice} - ${act.nome} (Costo Mat. € ${formatNumber(act.costoBase)})</option>`
            ).join('');
            
            div.innerHTML = `
                <div class="form-group">
                    <label>Attività da Catalogo</label>
                    <select id="labAttivitaSelect${index}" onchange="aggiornaAttivitaLab(${index}, 'idAttivita', this.value); calcolaCostoTotaleLab()">
                        <option value="">Seleziona Attività</option>
                        ${options}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantità</label>
                    <input type="number" min="1" value="${labAct.quantita}" 
                        onchange="aggiornaAttivitaLab(${index}, 'quantita', parseInt(this.value) || 1); calcolaCostoTotaleLab()">
                </div>
                <div class="form-group" style="grid-column: span 1;">
                    <label>Costo Stimato (€)</label>
                    <input type="text" readonly value="${formatNumber(calcolaCostoAttivitaSingola(labAct.idAttivita, labAct.quantita))}">
                </div>
                <div>
                    <button type="button" class="danger" onclick="rimuoviAttivitaLab(${index})">Rimuovi</button>
                </div>
            `;
            attivitaListDiv.appendChild(div);
        }

        function aggiornaAttivitaLab(index, field, value) {
            if (labAttivita[index]) {
                labAttivita[index][field] = value;
                // Ricarica la lista per aggiornare il campo "Costo Stimato" della riga
                ricaricaListaAttivitaLab(); 
            }
        }

        function rimuoviAttivitaLab(index) {
            labAttivita.splice(index, 1);
            ricaricaListaAttivitaLab();
        }

        // --- LOGICA CALCOLO COSTI ---

        function calcolaCostoAttivitaSingola(idAttivita, quantita) {
            const catalogoAct = attivitaCatalogoCache.find(a => a.id === idAttivita);
            return (catalogoAct ? catalogoAct.costoBase : 0) * (quantita || 1);
        }

        function calcolaCostoTotaleLab() {
            const idSede = document.getElementById('idSede').value;
            const durataSettimane = parseInt(document.getElementById('durataSettimane').value) || 0;
            const outputElement = document.getElementById('costoTotaleLab');
            
            const sede = sediCache.find(s => s.id === idSede);
            
            // 1. Costo Noleggio (assumendo 5 giorni a settimana)
            const costoNolo = sede ? sede.costoNolo * durataSettimane * 5 : 0;
            
            // 2. Costo Attività (Materiali)
            const costoAttivita = labAttivita.reduce((sum, labAct) => {
                return sum + calcolaCostoAttivitaSingola(labAct.idAttivita, labAct.quantita);
            }, 0);

            const costoTotale = costoNolo + costoAttivita;
            
            outputElement.textContent = `€ ${formatNumber(costoTotale)}`;
        }


        // --- FUNZIONI CRUD ATTIVITÀ ---

        async function caricaAttivita() {
            tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Caricamento Attività...</td></tr>';
            
            // Necessario per avere i costi aggiornati
            await caricaMaterialiPerSelect();
            await caricaAttivitaPerCache(); 

            db.collection("attivita_labs").onSnapshot(snapshot => {
                tabellaAttivitaBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nessuna Attività nel catalogo.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const materialiCount = (data.materialiRichiesti || []).length;
                    
                    // Recupera il costo base dalla cache che è stata appena ricaricata
                    const cachedAct = attivitaCatalogoCache.find(a => a.id === doc.id);
                    const costoBase = cachedAct ? cachedAct.costoBase : 0;
                    
                    const row = tabellaAttivitaBody.insertRow();
                    row.className = 'row';
                    
                    row.innerHTML = `
                        <td>${data.codiceAttivita || 'N/D'}</td>
                        <td>${data.nomeBreve || 'N/D'}</td>
                        <td>${data.tipologiaAttivita || 'N/D'}</td>
                        <td>${formatNumber(costoBase)} €</td>
                        <td>${materialiCount} articoli</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleAttivita('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="primary" style="background-color: #17a2b8; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); generaSchedaAttivitaPDF('${doc.id}')">PDF</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaAttivita('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }, error => {
                 tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Errore nel caricamento Attività.</td></tr>';
                 console.error("Errore nel caricamento Attività:", error);
            });
        }

        function apriModaleAttivita(id = null, data = {}) {
            attivitaForm.reset();
            materialiRichiesti = [];
            materialiRichiestiList.innerHTML = '';
            
            document.getElementById('attivitaId').value = id || '';
            document.getElementById('attivitaModalTitle').textContent = id ? 'Modifica Attività' : 'Aggiungi Nuova Attività';
            
            if (id) {
                document.getElementById('codiceAttivita').value = data.codiceAttivita || '';
                document.getElementById('nomeBreve').value = data.nomeBreve || '';
                document.getElementById('tipologiaAttivita').value = data.tipologiaAttivita || '';
                document.getElementById('descrizioneDettagliata').value = data.descrizioneDettagliata || '';
                
                materialiRichiesti = data.materialiRichiesti || [];
                ricaricaListaMaterialiRichiesti();
            }

            attivitaModal.style.display = "block";
        }

        function chiudiModaleAttivita() {
            attivitaModal.style.display = "none";
        }
        
        attivitaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const attivitaId = document.getElementById('attivitaId').value;
            const isEditing = !!attivitaId;
            
            const attivitaData = {
                codiceAttivita: document.getElementById('codiceAttivita').value,
                nomeBreve: document.getElementById('nomeBreve').value,
                tipologiaAttivita: document.getElementById('tipologiaAttivita').value,
                descrizioneDettagliata: document.getElementById('descrizioneDettagliata').value,
                materialiRichiesti: materialiRichiesti
            };
            
            const collectionRef = db.collection("attivita_labs");
            let operation;

            if (isEditing) {
                operation = collectionRef.doc(attivitaId).update(attivitaData);
            } else {
                operation = collectionRef.add(attivitaData);
            }
            
            operation.then(() => {
                alert(`Attività ${isEditing ? 'aggiornata' : 'creata'} con successo!`);
                chiudiModaleAttivita();
                caricaAttivita(); // onSnapshot
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        function eliminaAttivita(id) {
            if (confirm("Sei sicuro di voler eliminare questa Attività dal catalogo? Controlla che non sia associata a Lab attivi.")) {
                // Prevenzione: Dovresti prima controllare in DB se l'ID è usato in qualche Lab.
                
                db.collection("attivita_labs").doc(id).delete().then(() => {
                    alert("Attività eliminata con successo.");
                    caricaAttivita(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione dell'attività: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }


        // --- GESTIONE MATERIALI ATTIVITÀ (Interno Modale Attività) ---

        function ricaricaListaMaterialiRichiesti() {
            materialiRichiestiList.innerHTML = '';
            materialiRichiesti.forEach((materiale, index) => {
                aggiungiMaterialeHTML(materiale, index);
            });
        }

        function aggiungiMateriale() {
            materialiRichiesti.push({ idMateriale: '', quantita: 1 });
            ricaricaListaMaterialiRichiesti();
        }

        function aggiungiMaterialeHTML(materiale, index) {
            const div = document.createElement('div');
            div.className = 'attivita-grid';
            
            let options = materialiInventarioCache.map(m => 
                `<option value="${m.id}" ${materiale.idMateriale === m.id ? 'selected' : ''}>${m.codice} - ${m.nome} (Costo Unit. € ${formatNumber(m.costoUnitario)})</option>`
            ).join('');
            
            div.innerHTML = `
                <div class="form-group" style="grid-column: span 2;">
                    <label>Articolo da Inventario</label>
                    <select id="materialeSelect${index}" onchange="aggiornaMaterialeRichiesto(${index}, 'idMateriale', this.value)">
                        <option value="">Seleziona Articolo</option>
                        ${options}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantità</label>
                    <input type="number" min="1" value="${materiale.quantita}" 
                        onchange="aggiornaMaterialeRichiesto(${index}, 'quantita', parseInt(this.value) || 1)">
                </div>
                <div>
                    <button type="button" class="danger" onclick="rimuoviMaterialeRichiesto(${index})">Rimuovi</button>
                </div>
            `;
            materialiRichiestiList.appendChild(div);
        }

        function aggiornaMaterialeRichiesto(index, field, value) {
            if (materialiRichiesti[index]) {
                materialiRichiesti[index][field] = value;
            }
            // Ricarica la cache attività per aggiornare i costi sul catalogo
            caricaAttivitaPerCache(); 
        }

        function rimuoviMaterialeRichiesto(index) {
            materialiRichiesti.splice(index, 1);
            ricaricaListaMaterialiRichiesti();
            // Ricarica la cache attività per aggiornare i costi sul catalogo
            caricaAttivitaPerCache(); 
        }

        // --- FUNZIONI PDF (html2canvas & jspdf) ---

        async function generaSchedaAttivitaPDF(id) {
            try {
                const doc = await db.collection("attivita_labs").doc(id).get();
                if (!doc.exists) {
                    alert("Attività non trovata.");
                    return;
                }
                const data = doc.data();

                const nomeAttivita = data.nomeBreve || 'Senza Nome';
                const materiali = data.materialiRichiesti || [];

                // Creazione di un elemento temporaneo per il contenuto PDF
                const input = document.createElement('div');
                input.style.width = '794px'; // A4 width in pixels
                input.style.padding = '30px';
                input.style.backgroundColor = 'white';
                input.innerHTML = `
                    <h1 style="color: #343a40;">Scheda Tecnica Attività: ${nomeAttivita}</h1>
                    <p style="font-style: italic; color: #888;">Codice: ${data.codiceAttivita || 'N/D'} | Tipologia: ${data.tipologiaAttivita || 'N/D'}</p>
                    <hr style="border: 1px solid #A5DD2E;">
                    
                    <h3 style="color: #555;">Descrizione</h3>
                    <p>${data.descrizioneDettagliata || 'Nessuna descrizione dettagliata fornita.'}</p>

                    <h3 style="color: #555; margin-top: 20px;">Fabbisogno Materiali</h3>
                `;

                if (materiali.length > 0) {
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Codice Articolo</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Nome</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Quantità Richiesta</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Costo Unitario (€)</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Costo Totale (€)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    let costoTotaleMateriali = 0;

                    materiali.forEach(item => {
                        const materiale = materialiInventarioCache.find(m => m.id === item.idMateriale);
                        const nomeMateriale = materiale ? materiale.nome : 'Articolo Sconosciuto';
                        const codiceMateriale = materiale ? materiale.codice : 'N/D';
                        const costoUnitario = materiale ? materiale.costoUnitario : 0;
                        const costoRiga = costoUnitario * item.quantita;
                        costoTotaleMateriali += costoRiga;

                        tableHTML += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${codiceMateriale}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${nomeMateriale}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.quantita}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${formatNumber(costoUnitario)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${formatNumber(costoRiga)}</td>
                            </tr>
                        `;
                    });

                    tableHTML += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Costo Base Totale Materiali:</td>
                                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${formatNumber(costoTotaleMateriali)} €</td>
                                </tr>
                            </tfoot>
                        </table>
                    `;
                    input.innerHTML += tableHTML;
                } else {
                    input.innerHTML += '<p>Nessun materiale richiesto per questa attività.</p>';
                }
                
                // Nasconde il contenuto temporaneo
                input.style.display = 'block';
                input.style.position = 'fixed';
                input.style.top = '0';
                input.style.left = '-10000px'; 
                document.body.appendChild(input);

                // Generazione PDF
                const canvas = await html2canvas(input, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'pt', 'a4');
                const imgWidth = 595; // A4 width in pt
                const pageHeight = 842; // A4 height in pt
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Scheda_Attivita_${data.codiceAttivita}.pdf`);
                
                input.remove();

            } catch (error) {
                console.error("Errore nel recupero dati per PDF Attività:", error);
                alert("Si è verificato un errore nel recupero dei dati o nella creazione della scheda PDF. Controlla la console.");
            }
        }


        // ==========================================================
        // INIZIALIZZAZIONE
        // ==========================================================

        // Logica di inizializzazione
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('dashboardContainer').style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                
                populateTipologiaSelect(); 
                
                // Caricamento in sequenza assicurandosi che le dipendenze siano rispettate
                Promise.all([
                    caricaMaterialiPerSelect(), // Necessario per la cache attività
                    caricaClientiPerSelect(),   // Necessario per la select Labs
                    caricaSediPerCache()        // Necessario per la select Labs (e risoluzione del bug)
                ]).then(() => {
                    caricaAttivitaPerCache();   // Dipende da Materiali
                    caricaLabs();               // Dipende da tutte le cache precedenti
                    caricaAttivita();           // Carica la tabella Attività
                }).catch(err => {
                    console.error("Errore nel caricamento dati iniziali Labs:", err);
                });

            } else {
                document.getElementById('dashboardContainer').style.display = 'none';
                window.location.href = '00index.html';
            }
        });
    </script>
</body>
</html>