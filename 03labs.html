<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Labs & Attività</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* [Stili CSS base identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 20px;}
        .data-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #343a40; }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; position: relative; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Stile per i campi readonly */
        .form-group input[readonly], .form-group select[readonly], .form-group textarea[readonly] {
            background-color: #f0f0f0;
            cursor: default;
        }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 700px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }
        
        /* Modifiche per rendere i bottoni delle tab più evidenti */
        .tab-buttons { display: flex; border-bottom: none; margin-bottom: 20px; } 
        .tab-buttons button { 
            background: #e9ecef; 
            border: 1px solid #dee2e6; 
            padding: 10px 20px; 
            cursor: pointer; 
            font-weight: bold; 
            color: #555; 
            transition: all 0.3s ease; 
            border-radius: 5px 5px 0 0; 
            margin-right: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .tab-buttons button:hover {
            background-color: #dee2e6; 
            color: #343a40;
        }
        .tab-buttons button.active { 
            background-color: #A5DD2E; 
            color: #343a40; 
            border-color: #A5DD2E; 
            font-weight: bold; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            position: relative;
            z-index: 1; 
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #attivitaTable th, #attivitaTable td { padding: 8px; }
        
        /* Stile specifico per il Codice Attività */
        .codice-info-icon { margin-left: 5px; cursor: pointer; color: #A5DD2E; font-weight: bold; }
        .codice-info-popup {
            display: none; position: absolute; top: 100%; left: 0; z-index: 10;
            background-color: #f9f9f9; border: 1px solid #ddd; 
            padding: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 300px; font-size: 0.8em; margin-top: 5px;
        }
        .codice-info-popup strong { color: #343a40; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .dashboard-nav a { width: 90%; }
            .form-row { flex-direction: column; gap: 0; }
            .codice-info-popup { width: 100%; left: 0; }
        }
    </style>
</head>
<body>

    <div id="modalLab" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLab()">&times;</span>
            <h2 id="modalLabTitle">Nuovo Lab</h2>
            
            <div class="tab-buttons">
                <button id="tabLabButton" class="active" onclick="openTab('tabLab')">LAB (Anagrafica)</button>
                <button id="tabAttivitaButton" onclick="openTab('tabAttivita')">ATTIVITÀ (Programma)</button>
            </div>
            
            <div id="tabLab" class="tab-content active">
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputNomeLab">Nome Lab</label>
                        <input type="text" id="inputNomeLab" placeholder="Nome completo del Lab" required>
                    </div>
                    <div class="form-group">
                        <label for="selectTipologia">Tipologia Lab</label>
                        <select id="selectTipologia" onchange="calcolaCodiceLab(); calcolaDateLab();" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputCodiceLab">Codice Lab (6 caratteri alfanumerici)</label>
                        <input type="text" id="inputCodiceLab" readonly placeholder="XXX000" style="font-weight: bold; background-color: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label for="inputDataInizio">Data Inizio</label>
                        <input type="date" id="inputDataInizio" onchange="calcolaDateLab()" required>
                    </div>
                </div>
                 <div class="form-row">
                     <div class="form-group">
                        <label for="inputDurataSettimane">Durata (Settimane)</label>
                        <input type="number" id="inputDurataSettimane" min="1" value="1" oninput="calcolaDateLab()" required readonly> 
                    </div>
                    <div class="form-group">
                        <label for="inputDataFine">Data Fine (Calcolata)</label>
                        <input type="date" id="inputDataFine" readonly style="background-color: #f0f0f0;">
                    </div>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label for="inputMaxPartecipanti">Max Partecipanti</label>
                        <input type="number" id="inputMaxPartecipanti" min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label for="selectSede">Sede del Fornitore (Se Lab in Esterna)</label>
                        <select id="selectSede"></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="inputNote">Note</label>
                        <textarea id="inputNote" placeholder="Note operative, requisiti speciali..."></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="primary" onclick="salvaLab('tabAttivita')">Continua: Definizione Attività</button>
                </div>
            </div>
            
            <div id="tabAttivita" class="tab-content">
                <h3 style="margin-top: 0;">Programma Attività (Tempo Totale: <span id="tempoTotaleAttivita">0</span> min)</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="selectAttivita">Attività da Assegnare</label>
                        <select id="selectAttivita"></select>
                    </div>
                    <div class="form-group" style="min-width: 100px;">
                        <label for="inputDurataAssegnata">Durata Assegnata (min)</label>
                        <input type="number" id="inputDurataAssegnata" min="5" value="60"> 
                    </div>
                    <div class="form-group" style="flex: 0; min-width: 150px; display: flex; align-items: flex-end;">
                        <button class="primary" onclick="aggiungiAttivitaAllaTabella()">Aggiungi Attività</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table" id="attivitaTable">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Attività</th>
                                <th>Durata (min)</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="attivitaTableBody">
                            </tbody>
                    </table>
                </div>

                 <div style="margin-top: 20px; text-align: right;">
                    <button class="primary" onclick="salvaLab()">Salva Lab Completo</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="modalAttivita" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button" onclick="chiudiModaleAttivita()">&times;</span>
            <h2 id="modalAttivitaTitle">Catalogo Attività</h2>
            
            <div class="tab-buttons">
                <button class="active" onclick="openAttivitaTab('tabAttivitaLista')">LISTA ATTIVITÀ</button>
                <button onclick="openAttivitaTab('tabNuovaAttivita')">NUOVA ATTIVITÀ</button>
            </div>
            
            <div id="tabAttivitaLista" class="tab-content active">
                 <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome Breve</th>
                                <th>Costo Base (€)</th>
                                <th>Materiali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaAttivitaBody">
                            <tr><td colspan="5" style="text-align: center;">Nessuna attività nel catalogo.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tabNuovaAttivita" class="tab-content">
                <h3 style="margin-top: 0;">Dettagli Nuova Attività</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputCodiceAttivita">
                            Codice Attività (es. RSI001) 
                            <span class="codice-info-icon" onclick="toggleCodiceInfo(this)">ⓘ</span>
                        </label>
                        <input type="text" id="inputCodiceAttivita" placeholder="Codice univoco alfanumerico (6 digit)" 
                                oninput="this.value = this.value.toUpperCase().slice(0, 6);" onblur="calcolaCodiceAttivita(this.value.slice(0,3))" required>
                        <div id="codiceInfoPopup" class="codice-info-popup">
                            Il codice è composto da 6 caratteri alfanumerici:<br>
                            1. **3 caratteri (Tipo-Azione-Fase):** Es. Routine (R), Saluto (S), Iniziale (I) &rarr; **RSI**.<br>
                            2. **3 caratteri (Progressivo):** Es. **001**.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputNomeBreveAttivita">Nome Breve (Catalogo)</label>
                        <input type="text" id="inputNomeBreveAttivita" placeholder="es. Robotica Base" required>
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="inputNomeCompletoAttivita">Nome Completo</label>
                        <input type="text" id="inputNomeCompletoAttivita" placeholder="Descrizione completa dell'attività">
                    </div>
                    <div class="form-group">
                        <label for="inputCostoBaseAttivita">Costo Base Totale (Materiali)</label>
                        <input type="text" id="inputCostoBaseAttivita" value="0.00" readonly style="font-weight: bold; background-color: #f0f0f0;">
                    </div>
                </div>

                <h4 style="margin-top: 20px;">Fabbisogno Materiali</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="selectMateriale">Materiale (Codice e Costo Unitario)</label>
                        <select id="selectMateriale"></select> </div>
                    <div class="form-group" style="min-width: 100px;">
                        <label for="inputQuantitaMateriale">Quantità</label>
                        <input type="number" id="inputQuantitaMateriale" min="1" value="1">
                    </div>
                    <div class="form-group" style="flex: 0; min-width: 150px; display: flex; align-items: flex-end;">
                        <button class="primary" onclick="aggiungiMaterialeTemp()">Aggiungi Materiale</button>
                    </div>
                </div>
                
                <div class="table-responsive" style="margin-top: 10px;">
                    <table class="data-table" style="min-width: unset;">
                        <thead>
                            <tr>
                                <th>Materiale</th>
                                <th>Quantità</th>
                                <th>Costo Unitario (€)</th>
                                <th>Costo Totale (€)</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="materialiTemporaneiBody">
                            </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="primary" onclick="salvaNuovaAttivita()">Salva Attività nel Catalogo</button>
                </div>
            </div>

        </div>
    </div>


    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Labs & Attività</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link active">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <div class="tab-buttons" style="margin-bottom: 30px; border-bottom: none;">
                <button class="active" onclick="showSection('labsSection', this)">GESTIONE LABS</button>
                <button onclick="showSection('attivitaSection', this)">CATALOGO ATTIVITÀ</button>
            </div>

            <div id="labsSection" class="data-section" style="display: block;">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLab()">➕ Nuovo Lab</button>
                </div>
                
                <h2>Labs Attivi</h2>
                <p>Elenco dei laboratori e progetti attivi e programmati.</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome Lab</th>
                                <th>Tipologia</th>
                                <th>Sede Fornitore</th>
                                <th>Data Inizio</th>
                                <th>Durata (Sett.)</th>
                                <th>Attività</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLabsBody">
                            <tr><td colspan="8" style="text-align: center;">Nessun Lab attivo.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="attivitaSection" class="data-section" style="display: none;">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleAttivita()">➕ Gestione Catalogo</button>
                </div>
                
                <h2>Catalogo Attività</h2>
                <p>Definizione delle singole attività didattiche e del loro fabbisogno materiali.</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                             <tr>
                                <th>Codice</th>
                                <th>Nome Breve</th>
                                <th>Costo Base (€)</th>
                                <th>Materiali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaAttivitaCatalogoBody">
                            <tr><td colspan="5" style="text-align: center;">Nessuna attività nel catalogo.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebaseapp.com",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        // Inizializza Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const dashboardNav = document.getElementById('dashboardNav');
        const modalLab = document.getElementById('modalLab');
        const modalAttivita = document.getElementById('modalAttivita');
        const selectTipologia = document.getElementById('selectTipologia');
        const inputCodiceLab = document.getElementById('inputCodiceLab');
        const inputCodiceAttivita = document.getElementById('inputCodiceAttivita');
        const inputDataInizio = document.getElementById('inputDataInizio');
        const inputDurataSettimane = document.getElementById('inputDurataSettimane'); 
        const inputDataFine = document.getElementById('inputDataFine');


        // Variabili Globali
        let fornitoriSediCache = {}; 
        let attivitaCatalogoCache = {}; 
        let labAttivitaTemporanee = []; 
        let materialiTemporanei = []; 
        let inventarioCache = {}; 

        // LAB EDITING
        let isEditMode = false;
        let labToEditId = null;

        // ==========================================================
        // UTILITY E NAVIGAZIONE
        // ==========================================================

        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() {
            auth.signOut().then(() => {
                window.location.href = '00index.html';
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        function showSection(sectionId, button) {
            document.getElementById('labsSection').style.display = 'none';
            document.getElementById('attivitaSection').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
            
            document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            if (sectionId === 'attivitaSection') {
                caricaAttivita();
            }
        }

        // Tipologie Lab AGGIORNATE con la nuova logica
        const tipologieLab = [
            { nome: "OpenDay (1 giorno)", prefisso: "OPN", durataSettimane: 1, modificabile: true },
            { nome: "Singolo (1 giorno)", prefisso: "SNG", durataSettimane: 1, modificabile: true },
            { nome: "Mensile (4 settimane)", prefisso: "MNS", durataSettimane: 4, modificabile: false },
            { nome: "Bimestrale (8 settimane)", prefisso: "BMS", durataSettimane: 8, modificabile: false },
            { nome: "Trimestrale (12 settimane)", prefisso: "TMS", durataSettimane: 12, modificabile: false },
            { nome: "Quadrimestrale (16 settimane)", prefisso: "QMS", durataSettimane: 16, modificabile: false },
            { nome: "Campus (Durata Manuale)", prefisso: "CPS", durataSettimane: 5, modificabile: true },
            { nome: "Crea nuovo tipo (Durata Manuale)", prefisso: "NVT", durataSettimane: 1, modificabile: true }
        ];

        function populateTipologiaSelect() {
            selectTipologia.innerHTML = '<option value="">-- Seleziona --</option>';
            tipologieLab.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.prefisso;
                option.textContent = tipo.nome;
                selectTipologia.appendChild(option);
            });
        }
        
        /**
         * Calcola la data di fine aggiungendo le settimane alla data di inizio.
         * @param {string} dataInizio - Data di inizio in formato 'YYYY-MM-DD'.
         * @param {number} durataSettimane - Durata in settimane.
         * @returns {string} Data di fine in formato 'YYYY-MM-DD'.
         */
        function calcolaDataFine(dataInizio, durataSettimane) {
            if (!dataInizio || durataSettimane <= 0) return '';
            
            // Crea un oggetto Date dalla stringa YYYY-MM-DD (per evitare problemi di fuso orario, crea una data a mezzogiorno)
            const data = new Date(dataInizio + 'T12:00:00'); 
            
            // Calcola giorni totali da aggiungere (Settimane * 7 giorni)
            const giorniDaAggiungere = durataSettimane * 7;
            
            // Aggiunge la durata in giorni
            data.setDate(data.getDate() + giorniDaAggiungere);
            
            // Formatta in YYYY-MM-DD
            const year = data.getFullYear();
            const month = String(data.getMonth() + 1).padStart(2, '0');
            const day = String(data.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Aggiorna il campo Data Fine in base alla Tipologia, Data Inizio e Durata (Settimane).
         */
        function calcolaDateLab() {
            const dataInizioValue = inputDataInizio.value;
            const prefissoTipologia = selectTipologia.value;
            let durataSettimane = parseInt(inputDurataSettimane.value) || 0;
            
            const tipoSelezionato = tipologieLab.find(t => t.prefisso === prefissoTipologia);

            if (tipoSelezionato) {
                // 1. Logica di Durata e Modificabilità del Campo
                if (!tipoSelezionato.modificabile) {
                    // Durata Fissa per Mensile, Bimestrale, Trimestrale, etc.
                    durataSettimane = tipoSelezionato.durataSettimane;
                    inputDurataSettimane.value = durataSettimane;
                    inputDurataSettimane.setAttribute('readonly', 'readonly');
                    inputDurataSettimane.style.backgroundColor = '#f0f0f0';
                } else {
                    // Durata Manuale (OpenDay, Singolo, Campus, Nuovo Tipo)
                    inputDurataSettimane.removeAttribute('readonly');
                    inputDurataSettimane.style.backgroundColor = 'white';
                    
                    // Se non sono in edit mode e non ho inserito nulla, ripristino il default
                    if (!isEditMode && (!durataSettimane || durataSettimane < 1)) {
                         durataSettimane = tipoSelezionato.durataSettimane;
                         inputDurataSettimane.value = durataSettimane;
                    } else if (isEditMode) {
                        // In edit mode, lascio il valore già presente
                        durataSettimane = parseInt(inputDurataSettimane.value) || tipoSelezionato.durataSettimane;
                    }
                }
            } else {
                // Nessuna tipologia selezionata
                durataSettimane = 0;
                inputDurataSettimane.value = '';
                inputDurataSettimane.removeAttribute('readonly');
                inputDurataSettimane.style.backgroundColor = 'white';
            }

            // 2. Calcolo della Data Fine
            if (dataInizioValue && durataSettimane > 0) {
                const dataFine = calcolaDataFine(dataInizioValue, durataSettimane);
                inputDataFine.value = dataFine;
            } else {
                inputDataFine.value = '';
            }
        }

        // Funzione per calcolare il Codice Lab
        async function calcolaCodiceLab() {
            const prefisso = selectTipologia.value;
            if (!prefisso) {
                inputCodiceLab.value = '';
                return;
            }
            try {
                const docRef = db.collection("labs_config").doc("contatori_lab");
                const doc = await docRef.get();
                let contatore = 1;
                if (doc.exists) {
                    const contatori = doc.data();
                    // Gestione speciale per 'Crea nuovo tipo' (NVT) - si basa sul contatore NVT
                    const chiaveContatore = prefisso === 'NVT' ? 'NVT' : prefisso;
                    contatore = (contatori[chiaveContatore] || 0) + 1;
                }
                const numeroProgressivo = String(contatore).padStart(3, '0');
                inputCodiceLab.value = `${prefisso}${numeroProgressivo}`;
            } catch (error) {
                console.error("Errore nel calcolo del Codice Lab:", error);
                inputCodiceLab.value = `${prefisso}ERR`;
            }
        }

        // Funzione per il Codice Attività (Punto B)
        async function calcolaCodiceAttivita(prefisso) {
            const prefissoMaiusc = prefisso.toUpperCase().slice(0, 3);
            if (prefissoMaiusc.length !== 3 || inputCodiceAttivita.value.length === 6) {
                return; 
            }
            try {
                const docRef = db.collection("labs_config").doc("contatori_attivita");
                const doc = await docRef.get();
                let contatore = 1;
                if (doc.exists) {
                    const contatori = doc.data();
                    // Utilizza il prefisso di 3 caratteri come chiave
                    contatore = (contatori[prefissoMaiusc] || 0) + 1;
                }
                const numeroProgressivo = String(contatore).padStart(3, '0');
                inputCodiceAttivita.value = `${prefissoMaiusc}${numeroProgressivo}`;
            } catch (error) {
                console.error("Errore nel calcolo del Codice Attività:", error);
                inputCodiceAttivita.value = `${prefissoMaiusc}ERR`;
            }
        }

        // Funzione per mostrare/nascondere la nota esplicativa (Punto B.1)
        function toggleCodiceInfo(icon) {
            const popup = document.getElementById('codiceInfoPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        function openTab(tabId) {
            document.querySelectorAll('#modalLab .tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#modalLab .tab-buttons button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById(`tab${tabId.substring(3)}Button`).classList.add('active');

            if (tabId === 'tabAttivita') {
                aggiornaTabellaAttivitaTemp();
            }
        }
        
        function openAttivitaTab(tabId) {
            document.getElementById('tabAttivitaLista').classList.remove('active');
            document.getElementById('tabNuovaAttivita').classList.remove('active');
            
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('#modalAttivita .tab-buttons button').forEach(btn => btn.classList.remove('active'));
            if (tabId === 'tabAttivitaLista') {
                 document.querySelectorAll('#modalAttivita .tab-buttons button')[0].classList.add('active');
            } else if (tabId === 'tabNuovaAttivita') {
                document.querySelectorAll('#modalAttivita .tab-buttons button')[1].classList.add('active');
                if (!inputCodiceAttivita.value || inputCodiceAttivita.value.length < 6) { 
                    calcolaCodiceAttivita("ABC"); // Prefisso fittizio iniziale per suggerimento
                }
            }
        }


        // ==========================================================
        // LAB LOGIC (CRUD)
        // ==========================================================

        function resetFormLab() {
            document.getElementById('modalLabTitle').textContent = 'Nuovo Lab';
            document.getElementById('inputNomeLab').value = '';
            document.getElementById('selectTipologia').value = '';
            document.getElementById('inputCodiceLab').value = '';
            document.getElementById('inputDataInizio').value = '';
            inputDurataSettimane.value = 1; 
            inputDataFine.value = '';
            document.getElementById('inputMaxPartecipanti').value = '10';
            document.getElementById('selectSede').value = '';
            document.getElementById('inputNote').value = '';
            
            // Ripristina la modificabilità di default
            inputDurataSettimane.removeAttribute('readonly');
            inputDurataSettimane.style.backgroundColor = 'white';
            
            labAttivitaTemporanee = [];
            aggiornaTabellaAttivitaTemp();
            calcolaDateLab(); 
            
            isEditMode = false;
            labToEditId = null;
            openTab('tabLab');
        }

        function apriModaleLab(labId = null) {
            resetFormLab();
            
            if (labId) {
                isEditMode = true;
                labToEditId = labId;
                caricaDatiLab(labId);
                document.getElementById('modalLabTitle').textContent = 'Modifica Lab';
            }
            modalLab.style.display = 'block';
        }

        function chiudiModaleLab() {
            modalLab.style.display = 'none';
        }
        
        async function caricaLabs() {
            const tableBody = document.getElementById('tabellaLabsBody');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Caricamento Lab...</td></tr>';

            db.collection("labs").orderBy("dataInizio", "desc").onSnapshot(snapshot => {
                tableBody.innerHTML = '';
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun Lab attivo.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const lab = doc.data();
                    
                    const tipologiaNome = tipologieLab.find(t => t.prefisso === lab.codiceLab.substring(0, 3))?.nome || 'N/D';
                    const sedeNome = fornitoriSediCache[lab.idSede] || 'Non Specificata';
                    
                    const numAttivita = (lab.attivitaProgrammate || []).length;
                    
                    row.insertCell().textContent = lab.codiceLab;
                    row.insertCell().textContent = lab.nomeLab;
                    row.insertCell().textContent = tipologiaNome;
                    row.insertCell().textContent = sedeNome;
                    row.insertCell().textContent = lab.dataInizio || 'N/D';
                    row.insertCell().textContent = lab.durataSettimane || 'N/D'; 
                    row.insertCell().textContent = `${numAttivita} Attività`;

                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="primary" onclick="generaSchedaLab('${doc.id}')">PDF</button>
                        <button class="primary" onclick="apriModaleLab('${doc.id}')">Modifica</button>
                        <button class="danger" onclick="eliminaLab('${doc.id}')">Elimina</button>
                    `;
                });
            }, error => {
                console.error("Errore nel fetch dei Labs:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento dei dati.</td></tr>';
            });
        }
        
        async function caricaDatiLab(labId) {
            try {
                const doc = await db.collection("labs").doc(labId).get();
                if (!doc.exists) {
                    alert("Lab non trovato.");
                    return;
                }
                const lab = doc.data();
                
                // Imposta i valori di base
                document.getElementById('inputNomeLab').value = lab.nomeLab;
                
                // Trova la tipologia in base al prefisso (primi 3 caratteri)
                const prefisso = lab.codiceLab.substring(0, 3);
                selectTipologia.value = prefisso; 
                
                inputCodiceLab.value = lab.codiceLab;
                inputDataInizio.value = lab.dataInizio;
                inputDurataSettimane.value = lab.durataSettimane || 1; 
                document.getElementById('inputMaxPartecipanti').value = lab.maxPartecipanti;
                document.getElementById('selectSede').value = lab.idSede || '';
                document.getElementById('inputNote').value = lab.note || '';
                
                // Applica la logica di calcolo per gestire readonly e data fine
                calcolaDateLab(); 
                
                // Carica le attività temporanee per la tab Attività
                labAttivitaTemporanee = lab.attivitaProgrammate || [];
                aggiornaTabellaAttivitaTemp();
                
            } catch (error) {
                console.error("Errore nel caricamento dati Lab:", error);
                alert("Si è verificato un errore nel caricamento dei dati del Lab.");
            }
        }
        
        async function salvaLab(nextTab = null) {
            const nomeLab = document.getElementById('inputNomeLab').value;
            const prefissoTipologia = selectTipologia.value;
            const codiceLab = inputCodiceLab.value;
            const dataInizio = inputDataInizio.value;
            const durataSettimane = parseInt(inputDurataSettimane.value) || 0; 
            const dataFine = inputDataFine.value; 
            const maxPartecipanti = parseInt(document.getElementById('inputMaxPartecipanti').value) || 0;
            const idSede = document.getElementById('selectSede').value;
            const note = document.getElementById('inputNote').value;
            
            if (!nomeLab || !prefissoTipologia || !codiceLab || !dataInizio || durataSettimane <= 0) {
                alert("Per favore, compila i campi obbligatori dell'Anagrafica (Nome, Tipologia, Data Inizio, Durata > 0).");
                return;
            }

            if (nextTab) {
                // Passa alla scheda Attività senza salvare
                openTab(nextTab);
                return;
            }
            
            // Se si salva il lab completo, controllo che ci siano attività
            if (labAttivitaTemporanee.length === 0) {
                if (!confirm("Non hai assegnato alcuna attività. Sei sicuro di voler salvare il Lab vuoto?")) {
                    openTab('tabAttivita');
                    return;
                }
            }

            const labData = {
                nomeLab,
                codiceLab,
                dataInizio,
                durataSettimane, 
                dataFine,     
                maxPartecipanti,
                idSede: idSede || null,
                note,
                attivitaProgrammate: labAttivitaTemporanee,
                timestampUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (isEditMode && labToEditId) {
                    await db.collection("labs").doc(labToEditId).update(labData);
                    alert("Lab aggiornato con successo!");
                } else {
                    // Crea il lab
                    const newLabRef = await db.collection("labs").add(labData);
                    
                    // Aggiorna il contatore nella config solo se Lab è nuovo
                    const contatoreRef = db.collection("labs_config").doc("contatori_lab");
                    await db.runTransaction(async (transaction) => {
                        const contatoreDoc = await transaction.get(contatoreRef);
                        const contatori = contatoreDoc.exists ? contatoreDoc.data() : {};
                        const chiaveContatore = prefissoTipologia === 'NVT' ? 'NVT' : prefissoTipologia;
                        const nuovoContatore = (contatori[chiaveContatore] || 0) + 1;
                        contatori[chiaveContatore] = nuovoContatore;
                        transaction.set(contatoreRef, contatori);
                    });
                    
                    // Imposta l'ID del lab appena creato
                    await newLabRef.update({ id: newLabRef.id });
                    
                    alert("Lab creato con successo!");
                }
                
                chiudiModaleLab();
                caricaLabs(); 

            } catch (error) {
                console.error("Errore nel salvataggio/aggiornamento del Lab:", error);
                alert("Errore durante il salvataggio del Lab: " + error.message);
            }
        }
        
        function eliminaLab(id) {
            if (confirm("Sei sicuro di voler eliminare questo Lab? L'operazione è irreversibile.")) {
                db.collection("labs").doc(id).delete().then(() => {
                    alert("Lab eliminato con successo.");
                    caricaLabs(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione del Lab: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }
        
        // Funzioni per l'aggiunta di Attività al Lab (Lab > tab Attività)
        function aggiungiAttivitaAllaTabella() {
            const selectAttivita = document.getElementById('selectAttivita');
            const inputDurataAssegnata = document.getElementById('inputDurataAssegnata');
            
            const codiceAttivita = selectAttivita.value;
            const durataAssegnata = parseInt(inputDurataAssegnata.value) || 0;

            if (!codiceAttivita || durataAssegnata <= 0) {
                alert("Seleziona un'attività e specifica una durata valida.");
                return;
            }
            
            const attivitaSelezionata = attivitaCatalogoCache[codiceAttivita];
            if (!attivitaSelezionata) {
                alert("Attività non trovata nel catalogo.");
                return;
            }
            
            const nuovaAttivita = {
                codiceAttivita: codiceAttivita,
                nomeBreve: attivitaSelezionata.nomeBreve,
                durata: durataAssegnata
            };
            
            labAttivitaTemporanee.push(nuovaAttivita);
            aggiornaTabellaAttivitaTemp();
        }

        function rimuoviAttivitaTemp(index) {
            labAttivitaTemporanee.splice(index, 1);
            aggiornaTabellaAttivitaTemp();
        }
        
        function aggiornaTabellaAttivitaTemp() {
            const tableBody = document.getElementById('attivitaTableBody');
            const tempoTotaleSpan = document.getElementById('tempoTotaleAttivita');
            tableBody.innerHTML = '';
            
            let tempoTotale = 0;

            if (labAttivitaTemporanee.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nessuna attività programmata.</td></tr>';
            } else {
                labAttivitaTemporanee.forEach((attivita, index) => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = attivita.codiceAttivita;
                    row.insertCell().textContent = attivita.nomeBreve;
                    row.insertCell().textContent = attivita.durata + ' min';
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `<button class="danger" onclick="rimuoviAttivitaTemp(${index})">X</button>`;
                    
                    tempoTotale += attivita.durata;
                });
            }
            
            tempoTotaleSpan.textContent = tempoTotale;
        }


        // ==========================================================
        // CATALOGO ATTIVITA LOGIC (CRUD)
        // ==========================================================

        function resetFormAttivita() {
            document.getElementById('inputCodiceAttivita').value = '';
            document.getElementById('inputNomeBreveAttivita').value = '';
            document.getElementById('inputNomeCompletoAttivita').value = '';
            document.getElementById('inputCostoBaseAttivita').value = '0.00';
            materialiTemporanei = [];
            aggiornaTabellaMaterialiTemp();
        }
        
        function apriModaleAttivita() {
            resetFormAttivita();
            modalAttivita.style.display = 'block';
            openAttivitaTab('tabAttivitaLista');
        }

        function chiudiModaleAttivita() {
            modalAttivita.style.display = 'none';
        }

        // Funzioni per l'aggiunta di materiali a una Nuova Attività (Catalogo)
        function aggiungiMaterialeTemp() {
            const selectMateriale = document.getElementById('selectMateriale');
            const inputQuantitaMateriale = document.getElementById('inputQuantitaMateriale');
            
            const materialeKey = selectMateriale.value;
            const quantita = parseInt(inputQuantitaMateriale.value) || 0;
            
            if (!materialeKey || quantita <= 0) {
                alert("Seleziona un materiale e specifica una quantità valida.");
                return;
            }

            const [codice, costoUnitarioStr] = materialeKey.split('|');
            const costoUnitario = parseFloat(costoUnitarioStr);
            const nomeMateriale = inventarioCache[codice];

            const nuovoMateriale = {
                codice: codice,
                nome: nomeMateriale || 'Materiale Sconosciuto',
                quantita: quantita,
                costoUnitario: costoUnitario,
                costoTotale: quantita * costoUnitario
            };

            // Controlla se il materiale è già presente e, in tal caso, aggiorna la quantità
            const existingIndex = materialiTemporanei.findIndex(m => m.codice === codice);
            if (existingIndex > -1) {
                materialiTemporanei[existingIndex].quantita += quantita;
                materialiTemporanei[existingIndex].costoTotale = materialiTemporanei[existingIndex].quantita * costoUnitario;
            } else {
                materialiTemporanei.push(nuovoMateriale);
            }

            aggiornaTabellaMaterialiTemp();
        }

        function rimuoviMaterialeTemp(index) {
            materialiTemporanei.splice(index, 1);
            aggiornaTabellaMaterialiTemp();
        }

        function aggiornaTabellaMaterialiTemp() {
            const tableBody = document.getElementById('materialiTemporaneiBody');
            const inputCostoBaseAttivita = document.getElementById('inputCostoBaseAttivita');
            tableBody.innerHTML = '';
            
            let costoBaseTotale = 0;

            if (materialiTemporanei.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nessun materiale assegnato.</td></tr>';
            } else {
                materialiTemporanei.forEach((materiale, index) => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = materiale.codice + ' (' + materiale.nome + ')';
                    row.insertCell().textContent = materiale.quantita;
                    row.insertCell().textContent = '€ ' + materiale.costoUnitario.toFixed(2);
                    row.insertCell().textContent = '€ ' + materiale.costoTotale.toFixed(2);
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `<button class="danger" onclick="rimuoviMaterialeTemp(${index})">X</button>`;
                    
                    costoBaseTotale += materiale.costoTotale;
                });
            }
            
            inputCostoBaseAttivita.value = costoBaseTotale.toFixed(2);
        }

        async function salvaNuovaAttivita() {
            const codiceAttivita = inputCodiceAttivita.value;
            const nomeBreve = document.getElementById('inputNomeBreveAttivita').value;
            const nomeCompleto = document.getElementById('inputNomeCompletoAttivita').value;
            const costoBaseAttivita = parseFloat(document.getElementById('inputCostoBaseAttivita').value);

            if (!codiceAttivita || codiceAttivita.length !== 6 || !nomeBreve) {
                alert("Per favore, compila il Codice Attività (6 caratteri) e il Nome Breve.");
                return;
            }
            
            // Controllo unicita del Codice solo in caso di NUOVA attività
            const existingDoc = await db.collection("attivita_labs").doc(codiceAttivita).get();
            if (existingDoc.exists) {
                 alert("Un'attività con questo codice esiste già. Scegline un altro.");
                 return;
            }

            const attivitaData = {
                codiceAttivita: codiceAttivita,
                nomeBreve: nomeBreve,
                nomeCompleto: nomeCompleto,
                costoBaseAttivita: costoBaseAttivita,
                materialiRichiesti: materialiTemporanei,
                timestampCreazione: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection("attivita_labs").doc(codiceAttivita).set(attivitaData);
                
                // Aggiorna il contatore nella config
                const prefisso = codiceAttivita.substring(0, 3);
                const contatoreRef = db.collection("labs_config").doc("contatori_attivita");
                await db.runTransaction(async (transaction) => {
                    const contatoreDoc = await transaction.get(contatoreRef);
                    const contatori = contatoreDoc.exists ? contatoreDoc.data() : {};
                    const numeroProgressivoAttuale = parseInt(codiceAttivita.substring(3)) || 0;
                    
                    // Solo se il nuovo codice è maggiore, aggiorna il contatore
                    if (numeroProgressivoAttuale > (contatori[prefisso] || 0)) {
                         contatori[prefisso] = numeroProgressivoAttuale;
                         transaction.set(contatoreRef, contatori);
                    }
                });
                
                alert("Attività salvata con successo nel catalogo!");
                chiudiModaleAttivita();
                caricaAttivita(); 
                caricaAttivitaPerCache();

            } catch (error) {
                console.error("Errore nel salvataggio dell'Attività:", error);
                alert("Errore durante il salvataggio dell'Attività: " + error.message);
            }
        }
        
        async function caricaAttivita() {
            const tableBodyLabs = document.getElementById('tabellaAttivitaCatalogoBody');
            const tableBodyModal = document.getElementById('tabellaAttivitaBody');
            
            tableBodyLabs.innerHTML = '<tr><td colspan="5" style="text-align: center;">Caricamento Attività...</td></tr>';
            tableBodyModal.innerHTML = '<tr><td colspan="5" style="text-align: center;">Caricamento Attività...</td></tr>';

            db.collection("attivita_labs").orderBy("codiceAttivita").onSnapshot(snapshot => {
                tableBodyLabs.innerHTML = '';
                tableBodyModal.innerHTML = '';
                if (snapshot.empty) {
                    const noData = '<tr><td colspan="5" style="text-align: center;">Nessuna attività nel catalogo.</td></tr>';
                    tableBodyLabs.innerHTML = noData;
                    tableBodyModal.innerHTML = noData;
                    return;
                }

                snapshot.forEach(doc => {
                    const attivita = doc.data();
                    
                    const numMateriali = (attivita.materialiRichiesti || []).length;
                    
                    // Tabella principale
                    let row = tableBodyLabs.insertRow();
                    row.insertCell().textContent = attivita.codiceAttivita;
                    row.insertCell().textContent = attivita.nomeBreve;
                    row.insertCell().textContent = parseFloat(attivita.costoBaseAttivita || 0).toFixed(2);
                    row.insertCell().textContent = numMateriali + ' articoli';

                    let actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="primary" onclick="generaSchedaAttivita('${doc.id}')">PDF</button>
                        <button class="danger" onclick="eliminaAttivita('${doc.id}')">Elimina</button>
                    `;
                    
                    // Tabella nella modale (lista)
                    row = tableBodyModal.insertRow();
                    row.insertCell().textContent = attivita.codiceAttivita;
                    row.insertCell().textContent = attivita.nomeBreve;
                    row.insertCell().textContent = parseFloat(attivita.costoBaseAttivita || 0).toFixed(2);
                    row.insertCell().textContent = numMateriali + ' articoli';

                    actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="primary" onclick="generaSchedaAttivita('${doc.id}')">PDF</button>
                        <button class="danger" onclick="eliminaAttivita('${doc.id}')">Elimina</button>
                    `;
                });
            }, error => {
                console.error("Errore nel fetch delle Attività:", error);
                const errorData = '<tr><td colspan="5" style="text-align: center; color: red;">Errore nel caricamento dei dati.</td></tr>';
                tableBodyLabs.innerHTML = errorData;
                tableBodyModal.innerHTML = errorData;
            });
        }
        
        async function caricaAttivitaPerCache() {
            attivitaCatalogoCache = {};
            const selectAttivita = document.getElementById('selectAttivita');
            selectAttivita.innerHTML = '<option value="">-- Seleziona Attività --</option>';

            try {
                const snapshot = await db.collection("attivita_labs").get();
                snapshot.forEach(doc => {
                    const attivita = doc.data();
                    attivitaCatalogoCache[doc.id] = attivita;
                    
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${attivita.codiceAttivita} - ${attivita.nomeBreve}`;
                    selectAttivita.appendChild(option);
                });
            } catch (error) {
                console.error("Errore nel caricamento cache attività:", error);
            }
        }
        
        // ==========================================================
        // CACHE E UTILITY GLOBALI
        // ==========================================================

        async function caricaSediPerCache() {
            fornitoriSediCache = {};
            const selectSede = document.getElementById('selectSede');
            selectSede.innerHTML = '<option value="">-- Seleziona Sede (Opzionale) --</option>';

            try {
                const snapshot = await db.collection("fornitori").get();
                snapshot.forEach(doc => {
                    const fornitore = doc.data();
                    if (fornitore.sedi && Array.isArray(fornitore.sedi)) {
                        fornitore.sedi.forEach((sede, index) => {
                            const sedeId = `${doc.id}_${index}`;
                            const sedeNomeCompleto = `${fornitore.nomeFornitore} - ${sede.nome || 'Sede N/D'}`;
                            fornitoriSediCache[sedeId] = sedeNomeCompleto;
                            
                            const option = document.createElement('option');
                            option.value = sedeId;
                            option.textContent = sedeNomeCompleto;
                            selectSede.appendChild(option);
                        });
                    }
                });
            } catch (error) {
                console.error("Errore nel caricamento cache sedi:", error);
            }
        }
        
        async function caricaMaterialiPerSelect() {
            inventarioCache = {};
            const selectMateriale = document.getElementById('selectMateriale');
            selectMateriale.innerHTML = '<option value="">-- Seleziona Materiale --</option>';

            try {
                const snapshot = await db.collection("inventario").get();
                snapshot.forEach(doc => {
                    const articolo = doc.data();
                    if (articolo.costoUnitario > 0) {
                        const key = `${articolo.codiceArticolo}|${articolo.costoUnitario.toFixed(2)}`;
                        inventarioCache[articolo.codiceArticolo] = articolo.nomeArticolo;
                        
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${articolo.codiceArticolo} - ${articolo.nomeArticolo} (€ ${articolo.costoUnitario.toFixed(2)})`;
                        selectMateriale.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Errore nel caricamento materiali per select:", error);
            }
        }
        
        // ==========================================================
        // GENERAZIONE PDF
        // ==========================================================

        // Generazione Scheda LAB (Omessa per Focus sulle Modifiche)
        function generaSchedaLab(id) {
            alert(`Generazione Scheda Lab (PDF) in preparazione per Lab ID: ${id}.\n\n(La funzionalità completa richiede una logica di rendering complessa non inclusa per brevità).`);
        }
        
        // Generazione Scheda Attività (NON OMESSA, VERSIONE COMPLETA)
        async function generaSchedaAttivita(id) {
            try {
                const doc = await db.collection("attivita_labs").doc(id).get();
                if (!doc.exists) {
                    alert("Attività non trovata.");
                    return;
                }
                const data = doc.data();
                
                // Creazione di un elemento temporaneo per il rendering HTML
                const input = document.createElement('div');
                input.style.width = '190mm'; 
                input.style.margin = '10mm';
                input.style.padding = '10mm';
                input.style.backgroundColor = 'white';
                input.style.position = 'absolute'; 
                input.style.left = '-5000px'; 
                document.body.appendChild(input);

                let htmlContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px;">
                        <h1 style="color: #A5DD2E; border-bottom: 2px solid #ccc; padding-bottom: 10px;">Scheda Tecnica Attività</h1>
                        <h2 style="color: #343a40;">${data.nomeBreve} (Cod. ${data.codiceAttivita})</h2>
                        <p><strong>Nome Completo:</strong> ${data.nomeCompleto || 'N/D'}</p>
                        
                        <h3 style="margin-top: 30px; color: #555;">Dettagli Economici</h3>
                        <p><strong>Costo Base Materiali:</strong> € ${parseFloat(data.costoBaseAttivita || 0).toFixed(2)}</p>
                        
                        <h3 style="margin-top: 30px; color: #555;">Fabbisogno Materiali</h3>
                `;

                if (data.materialiRichiesti && data.materialiRichiesti.length > 0) {
                    htmlContent += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Codice</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Materiale</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Quantità</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Costo Totale (€)</th>
                            </tr>
                        </thead>
                        <tbody>`;
                        
                    data.materialiRichiesti.forEach(m => {
                        htmlContent += `
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 8px;">${m.codice}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">${m.nome}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">${m.quantita}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${m.costoTotale.toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    htmlContent += `</tbody></table>`;
                } else {
                    htmlContent += `<p>Nessun materiale richiesto.</p>`;
                }
                
                htmlContent += '</div>';

                input.innerHTML = htmlContent;
                
                // Conversione in PDF con html2canvas e jspdf
                const { jsPDF } = window.jspdf;
                
                html2canvas(input, { scale: 2, allowTaint: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; 
                    const pageHeight = 297;  
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Scheda_Attivita_${data.codiceAttivita}.pdf`);
                    
                    input.remove(); // Rimuove l'elemento temporaneo dopo il salvataggio

                }).catch(err => {
                    console.error("Errore durante la generazione del PDF (Attività):", err);
                    alert("Errore durante la creazione del PDF. Controlla la console.");
                    input.remove();
                });

            } catch (error) {
                console.error("Errore nel recupero dati per PDF Attività:", error);
                alert("Si è verificato un errore nel recupero dei dati per la scheda PDF.");
            }
        }

        function eliminaAttivita(id) {
            if (confirm("Sei sicuro di voler eliminare questa Attività dal catalogo? L'operazione è irreversibile.")) {
                db.collection("attivita_labs").doc(id).delete().then(() => {
                    alert("Attività eliminata con successo.");
                    caricaAttivita(); 
                    caricaAttivitaPerCache();
                }).catch(error => {
                    alert("Errore durante l'eliminazione dell'attività: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }


        // ==========================================================
        // INIZIALIZZAZIONE
        // ==========================================================

        // Logica di inizializzazione
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('dashboardContainer').style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                
                populateTipologiaSelect(); 
                
                Promise.all([
                    caricaMaterialiPerSelect(), 
                    caricaAttivitaPerCache(),           
                    caricaSediPerCache()        
                ]).then(() => {
                    caricaLabs(); 
                    caricaAttivita();
                }).catch(err => {
                    console.error("Errore nel caricamento dati iniziali Labs:", err);
                });

            } else {
                document.getElementById('dashboardContainer').style.display = 'none';
                window.location.href = '00index.html';
            }
        });
    </script>
</body>
</html>