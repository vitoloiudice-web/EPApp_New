<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Labs & Attività</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>

    <style>
        /* [Stili CSS base identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .mobile-header { display: none; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 1200px; } 
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 950px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* Griglia Modale e Sezioni */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .lab-section-header, .fabbisogno-header { margin-top: 20px; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; color: #343a40; border-bottom: 2px solid #A5DD2E; padding-bottom: 5px; }
        .materiale-add-grid { display: grid; grid-template-columns: 3fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 15px; }
        .materiali-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .materiali-list-table th, .materiali-list-table td { padding: 8px; border: 1px solid #eee; text-align: left; }
        
        /* NUOVO: Sezione Panoramica a Griglia */
        .panoramica-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* 4 colonne */
            gap: 20px; 
        }
        .panoramica-item {
            background-color: #e9f0e3; /* Sfondo chiaro e rilassante */
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #A5DD2E;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .panoramica-item .panoramica-title {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
        }
        .panoramica-item .panoramica-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #343a40;
        }
        .panoramica-item.full-width {
            grid-column: 1 / span 4; /* Occupano tutta la larghezza */
            border-left: 5px solid #007bff;
            background-color: #e0f7fa;
        }

        /* Sezione Costi e Finanza LAB */
        .costi-finanza-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .costi-finanza-grid div { padding: 5px 0; border-bottom: 1px dotted #eee; }
        .costi-finanza-grid .label { font-weight: bold; color: #555; }
        .costi-finanza-grid .value { text-align: right; font-weight: bold; }
        .costi-finanza-grid .separator { grid-column: 1 / span 3; border-top: 1px solid #ccc; margin: 5px 0; }

        @media (max-width: 992px) {
            .panoramica-grid { grid-template-columns: repeat(2, 1fr); }
            .panoramica-item.full-width { grid-column: 1 / span 2; }
            .data-table { min-width: 900px; } 
        }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            /* ... altri stili per mobile ... */
            .panoramica-grid { grid-template-columns: 1fr; }
            .panoramica-item.full-width { grid-column: 1 / span 1; }
            .form-grid, .materiale-add-grid { grid-template-columns: 1fr; }
            .costi-finanza-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Labs & Attività</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI & ISCRIZIONI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link active">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Labs, Progetti e Attività Didattiche</h1>

            <div class="data-section" id="panoramicaSection" style="margin-bottom: 30px;">
                <h2 style="margin-top: 0;">Panoramica Generale 📊</h2>
                <div id="panoramicaGrid" class="panoramica-grid">
                    <div class="panoramica-item">
                        <span class="panoramica-title">Lab Totali</span>
                        <span class="panoramica-value" id="totaleLabs">0</span>
                    </div>
                    <div class="panoramica-item">
                        <span class="panoramica-title">Costo Totale Labs (Vivo)</span>
                        <span class="panoramica-value" id="costoTotaleLabs">€ 0.00</span>
                    </div>
                    <div class="panoramica-item">
                        <span class="panoramica-title">Costo Medio Lab (Vivo)</span>
                        <span class="panoramica-value" id="costoMedioLab">€ 0.00</span>
                    </div>
                    <div class="panoramica-item">
                        <span class="panoramica-title">Incidenza Costo/Iscritto</span>
                        <span class="panoramica-value" id="incidenzaCostoIscritto">€ 0.00</span>
                    </div>
                    <div class="panoramica-item full-width">
                        <span class="panoramica-title">Iscritti Totali (da 07iscrizioni)</span>
                        <span class="panoramica-value" id="totaleIscritti">0</span>
                    </div>
                </div>
            </div>
            <div class="data-section" style="margin-bottom: 30px;">
                <h2>Catalogo Attività (Fabbisogno)</h2>
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleAttivita(null)">➕ Aggiungi Attività</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Tipologia/Nome</th>
                                <th>Durata (Min)</th>
                                <th>Costo Base (€)</th>
                                <th>Materiali</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaAttivitaBody">
                            <tr><td colspan="7" style="text-align: center;">Nessuna Attività caricata.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="data-section">
                <h2 style="margin-top: 0;">Gestione Labs/Progetti</h2>
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLab(null)">➕ Aggiungi Lab/Progetto</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Tipologia/Nome</th>
                                <th>Durata (Ore)</th>
                                <th>Costo Vivo</th>
                                <th>Prezzo Suggerito</th>
                                <th>Listino Effettivo</th>
                                <th>Delta %</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLabsBody">
                            <tr><td colspan="9" style="text-align: center;">Nessun Lab caricato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="labModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLab()">&times;</span>
            <h2 id="labModalTitle">Aggiungi Nuovo Lab/Progetto</h2>
            <form id="labForm">
                <input type="hidden" id="labId" value="">

                <div class="form-grid">
                    <div class="form-group">
                        <label for="codiceLab">Codice Lab (2 char)</label>
                        <input type="text" id="codiceLab" maxlength="2" required>
                    </div>
                    <div class="form-group">
                        <label for="tipologiaLab">Tipologia Lab</label>
                        <select id="tipologiaLab" onchange="impostaNomeDurata()">
                            <option value="OD">OpenDay (OD) - 1 ora</option>
                            <option value="SI">Singolo (SI) - 2 ore</option>
                            <option value="1M">Mensile (1M) - 4 ore</option>
                            <option value="2M">Bimestrale (2M) - 8 ore</option>
                            <option value="3M">Trimestrale (3M) - 12 ore</option>
                            <option value="CE">Campus Estivo (CE) - 20 ore</option>
                            <option value="AL">Altro (AL) - Manuale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nomeBreveLab">Nome Breve</label>
                        <input type="text" id="nomeBreveLab" required>
                    </div>
                    <div class="form-group">
                        <label for="durataComplessivaOre">Durata Totale (Ore)</label>
                        <input type="number" id="durataComplessivaOre" step="0.5" min="0.5" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="sedeLabId">Sede & Logistica</label>
                        <select id="sedeLabId" onchange="calcolaDettagliFinanziari()">
                            <option value="">-- Seleziona Sede (Costo Log.) --</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="statoAvanzamento">Stato Lab</label>
                        <select id="statoAvanzamento">
                            <option value="bozza">Bozza</option>
                            <option value="attivato">Attivato</option>
                            <option value="incorso">In corso</option>
                            <option value="inesaurimento">In Esaurimento</option>
                            <option value="esaurito">Esaurito</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="percentualeProfittoDesiderata">Profitto Desiderato (%) (Min 125)</label>
                        <input type="number" id="percentualeProfittoDesiderata" min="125" step="5" value="125" onchange="calcolaDettagliFinanziari()">
                    </div>
                    <div class="form-group" style="grid-column: 2 / span 2;">
                        <label for="listinoEffettivo">Listino Effettivo (€)</label>
                        <input type="number" id="listinoEffettivo" step="0.01" min="0" value="0.00" required onchange="calcolaDettagliFinanziari()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descrizioneLab">Descrizione Dettagliata</label>
                    <textarea id="descrizioneLab" rows="2"></textarea>
                </div>
                
                <div class="lab-section-header">Abbinamento Attività</div>
                <div class="materiale-add-grid">
                    <div class="form-group">
                        <label for="attivitaSelect">Attività dal Catalogo</label>
                        <select id="attivitaSelect">
                            <option value="">-- Caricamento Attività... --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="durataAttivitaMinuti">Durata Assegnata (Min.)</label>
                        <input type="number" id="durataAttivitaMinuti" min="1" value="60">
                    </div>
                    <button type="button" class="primary" onclick="aggiungiAttivitaLab()" style="width: 100%; margin: 0; padding: 10px 5px;">Aggiungi</button>
                </div>

                <div class="table-responsive">
                    <table class="materiali-list-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Attività</th>
                                <th style="width: 20%;">Durata (Min.)</th>
                                <th style="width: 20%;">Costo Base (€)</th>
                                <th style="width: 10%;">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="listaAttivitaAbbinate">
                            <tr><td colspan="4" style="text-align: center; font-style: italic;">Nessuna attività abbinata.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="lab-section-header">Riepilogo Costi e Finanza LAB 💾</div>
                <div class="costi-finanza-grid">
                    <div class="label">Costo Totale Attività:</div><div class="value" id="costoTotaleAttivita">€ 0.00</div><div></div>
                    <div class="label">Costo Logistica (Sede):</div><div class="value" id="costoLogistica">€ 0.00</div><div></div>
                    <div class="separator"></div>
                    
                    <div class="label">**COSTO VIVO LAB (A):**</div><div class="value" id="costoVivoLab">€ 0.00</div><div></div>
                    
                    <div class="label">Profitto Desiderato (%):</div><div class="value" id="profittoDesideratoPerc">125 %</div><div></div>
                    <div class="label">Profitto (€):</div><div class="value" id="profittoEuro">€ 0.00</div><div></div>

                    <div class="separator"></div>

                    <div class="label">PREZZO SUGGERITO (B):</div><div class="value" id="prezzoSuggerito">€ 0.00</div><div></div>
                    <div class="label">Listino Effettivo:</div><div class="value" id="listinoEffettivoVis">€ 0.00</div><div></div>
                    
                    <div class="separator"></div>

                    <div class="label" style="font-size: 1.1em;">DIFFERENZA € (Listino - Suggerito):</div><div class="value" id="differenzaEuro" style="font-size: 1.1em;">€ 0.00</div><div></div>
                    <div class="label" style="font-size: 1.1em;">DELTA %:</div><div class="value" id="deltaPercent" style="font-size: 1.1em;">0.00 %</div><div></div>
                    
                    <div class="separator"></div>

                    <div class="label">Costo per Partecipante (ipotizzando 10):</div><div class="value" id="costoPerPartecipante">€ 0.00</div><div></div>
                </div>


                <div class="modal-buttons" style="margin-top: 30px; text-align: right;">
                    <button type="button" onclick="chiudiModaleLab()" style="background-color: #ccc;">Annulla</button>
                    <button type="button" class="primary" style="background-color: #007bff;" onclick="stampaSchedaLabPDF(document.getElementById('labId').value)">🖨️ PDF Riepilogo</button>
                    <button type="submit" class="primary">Salva Lab</button>
                </div>
            </form>
        </div>
    </div>


    <div id="attivitaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleAttivita()">&times;</span>
            <h2 id="attivitaModalTitle">Aggiungi Nuova Attività</h2>
            <form id="attivitaForm">
                <input type="hidden" id="attivitaId" value="">

                <div class="form-grid">
                    <div class="form-group">
                        <label for="codiceAttivita">Codice Attività (3 char)</label>
                        <input type="text" id="codiceAttivita" maxlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="tipologiaAttivita">Tipologia Attività</label>
                        <select id="tipologiaAttivita" onchange="impostaNomeBreveAttivita()">
                            <option value="ROU">Routine (ROU)</option>
                            <option value="PER">Persone (PER)</option>
                            <option value="OGG">Oggetti (OGG)</option>
                            <option value="MOM">Momenti (MOM)</option>
                            <option value="COL">Colori (COL)</option>
                            <option value="FOR">Forme (FOR)</option>
                            <option value="NUM">Numeri (NUM)</option>
                            <option value="SIT">Situazioni (SIT)</option>
                            <option value="AMB">Ambienti (AMB)</option>
                            <option value="ALT">Altro (ALT)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nomeBreveAttivita">Nome Breve</label>
                        <input type="text" id="nomeBreveAttivita" required>
                    </div>
                    <div class="form-group">
                        <label for="durataMinutiAttivita">Durata (Minuti)</label>
                        <input type="number" id="durataMinutiAttivita" min="1" value="60">
                    </div>
                    <div class="form-group">
                        <label for="statoAttivita">Stato Attività</label>
                        <select id="statoAttivita">
                            <option value="bozza">Bozza</option>
                            <option value="approvata">Approvata</option>
                            <option value="obsoleta">Obsoleta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="costoBaseAttivitaVisual">Costo Base Calcolato (€)</label>
                        <input type="text" id="costoBaseAttivitaVisual" value="0.00" disabled style="background-color: #eee; font-weight: bold;">
                        <input type="hidden" id="costoBaseAttivita" value="0.00"> </div>
                </div>

                <div class="form-group">
                    <label for="linkAudio">Link Audio/Base (YouTube/Spotify, ecc.)</label>
                    <input type="url" id="linkAudio" placeholder="https://youtube.com/...">
                </div>
                
                <div class="form-group">
                    <label for="descrizioneAttivita">Descrizione Dettagliata</label>
                    <textarea id="descrizioneAttivita" rows="2"></textarea>
                </div>

                <div class="fabbisogno-header">Fabbisogno Materiali (da Inventario)</div>
                <div class="materiale-add-grid">
                    <div class="form-group">
                        <label for="materialeInventarioSelect">Articolo dall'Inventario</label>
                        <select id="materialeInventarioSelect">
                            <option value="">-- Caricamento Inventario... --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantitaRichiesta">Quantità Necessaria</label>
                        <input type="number" id="quantitaRichiesta" min="1" value="1">
                    </div>
                    <button type="button" class="primary" onclick="aggiungiMateriale()" style="width: 100%; margin: 0; padding: 10px 5px;">Aggiungi</button>
                </div>

                <div class="table-responsive">
                    <table class="materiali-list-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Articolo</th>
                                <th style="width: 20%;">Qtà</th>
                                <th style="width: 20%;">Costo Unitario</th>
                                <th style="width: 10%;">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="listaMaterialiRichiesti">
                            <tr><td colspan="4" style="text-align: center; font-style: italic;">Nessun materiale richiesto.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-buttons" style="margin-top: 30px; text-align: right;">
                    <button type="button" onclick="chiudiModaleAttivita()" style="background-color: #ccc;">Annulla</button>
                    <button type="button" class="primary" style="background-color: #007bff;" onclick="stampaSchedaAttivitaPDF(document.getElementById('attivitaId').value)">🖨️ PDF Scheda</button>
                    <button type="submit" class="primary">Salva Attività</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // CONFIGURAZIONE FIREBASE 
        const firebaseConfig = {
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML (Labs)
        const labModal = document.getElementById('labModal');
        const labForm = document.getElementById('labForm');
        const tabellaLabsBody = document.getElementById('tabellaLabsBody');
        const sedeLabSelect = document.getElementById('sedeLabId');
        const attivitaSelect = document.getElementById('attivitaSelect');
        const listaAttivitaAbbinateDiv = document.getElementById('listaAttivitaAbbinate');
        
        // Elementi HTML (Attività)
        const attivitaModal = document.getElementById('attivitaModal');
        const attivitaForm = document.getElementById('attivitaForm');
        const tabellaAttivitaBody = document.getElementById('tabellaAttivitaBody');
        const listaMaterialiRichiestiDiv = document.getElementById('listaMaterialiRichiesti');
        const materialeInventarioSelect = document.getElementById('materialeInventarioSelect');
        const costoBaseAttivitaVisual = document.getElementById('costoBaseAttivitaVisual');
        
        // Mappature e Cache Globali
        const TipologiaLabMapping = {
            'OD': { nome: 'OpenDay', durata: 1 }, 'SI': { nome: 'Singolo', durata: 2 }, '1M': { nome: 'Mensile', durata: 4 },
            '2M': { nome: 'Bimestrale', durata: 8 }, '3M': { nome: 'Trimestrale', durata: 12 }, 'CE': { nome: 'Campus Estivo', durata: 20 },
            'AL': { nome: 'Altro', durata: null }
        };
        const TipologiaAttivitaMapping = {
            'ROU': 'Routine', 'PER': 'Persone', 'OGG': 'Oggetti', 'MOM': 'Momenti', 'COL': 'Colori', 'FOR': 'Forme', 
            'NUM': 'Numeri', 'SIT': 'Situazioni', 'AMB': 'Ambienti', 'ALT': 'Altro'
        };

        let sediCache = {}; 
        let inventarioCache = {}; 
        let attivitaCache = {}; 
        
        let materialiRichiestiAttivita = []; 
        let attivitaAbbinateLab = []; 

        // --- FUNZIONI UTILITY e FIREBASE ---

        function toggleNav() {
            document.getElementById('dashboardNav').classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        auth.onAuthStateChanged((user) => {
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (user) {
                dashboardContainer.style.display = 'flex';
                // Carica tutte le cache in parallelo prima di caricare le tabelle
                Promise.all([
                    caricaSediPerCache(),
                    caricaMaterialiInventarioPerCache(),
                    caricaAttivitaPerCache() 
                ]).then(() => {
                    // Carica le tabelle e la panoramica
                    caricaAttivita(); // SPOSTATO IN CIMA
                    caricaLabs();
                    caricaPanoramica(); // NUOVA FUNZIONE
                }).catch(err => {
                    console.error("Errore caricamento iniziale dati:", err);
                });
            } else {
                dashboardContainer.style.display = 'none';
                window.location.href = '00index.html'; 
            }
        });
        
        // ==========================================================
        //             LOGICA SEZIONE PANORAMICA (KPI)
        // ==========================================================
        
        /**
         * Carica e calcola i dati per la Panoramica Generale.
         */
        async function caricaPanoramica() {
            try {
                // 1. Dati LABS
                const labsSnapshot = await db.collection("labs").get();
                const totaleLabs = labsSnapshot.size;
                let costoTotaleLabs = 0;
                
                labsSnapshot.forEach(doc => {
                    costoTotaleLabs += parseFloat(doc.data().costoVivoLab || 0);
                });

                const costoMedioLab = totaleLabs > 0 ? costoTotaleLabs / totaleLabs : 0;
                
                // 2. Dati ISCRIZIONI (Assumendo una collezione 'iscrizioni' con campo 'labId')
                const iscrizioniSnapshot = await db.collection("iscrizioni").get();
                const totaleIscritti = iscrizioniSnapshot.size;
                
                // 3. Calcolo Incidenza
                const incidenzaCostoIscritto = totaleIscritti > 0 ? costoTotaleLabs / totaleIscritti : 0;
                
                // 4. Aggiorna l'HTML
                document.getElementById('totaleLabs').textContent = totaleLabs;
                document.getElementById('costoTotaleLabs').textContent = `€ ${costoTotaleLabs.toFixed(2)}`;
                document.getElementById('costoMedioLab').textContent = `€ ${costoMedioLab.toFixed(2)}`;
                document.getElementById('totaleIscritti').textContent = totaleIscritti;
                document.getElementById('incidenzaCostoIscritto').textContent = `€ ${incidenzaCostoIscritto.toFixed(2)}`;

            } catch (error) {
                console.error("Errore nel caricamento della Panoramica:", error);
                // Aggiorna la UI con un messaggio di errore se necessario
                document.getElementById('panoramicaGrid').innerHTML = '<div class="panoramica-item full-width" style="border-left: 5px solid red;"><span class="panoramica-title" style="color: red;">Errore caricamento dati</span><span class="panoramica-value">Verifica collezioni iscrizioni/labs.</span></div>';
            }
        }
        
        // ==========================================================
        //             LOGICHE DI CACHE DATI FONDAMENTALI
        // ==========================================================
        
        async function caricaSediPerCache() {
            sediCache = {};
            sedeLabSelect.innerHTML = '<option value="">-- Seleziona Sede (Costo Log.) --</option>';

            const fornitoriSnapshot = await db.collection("fornitori").get();
            fornitoriSnapshot.forEach(doc => {
                const data = doc.data();
                const sedi = data.sedi || [];
                const nomeFornitore = data.nome || 'Fornitore Sconosciuto';
                sedi.forEach((sede, index) => {
                    const sedeId = `${doc.id}_${index}`;
                    sediCache[sedeId] = {
                        nomeSede: `${nomeFornitore} - ${sede.nome || 'Sede Senza Nome'}`,
                        costoNolo: parseFloat(sede.costoNolo || 0)
                    };
                    
                    const option = document.createElement('option');
                    option.value = sedeId;
                    option.textContent = sediCache[sedeId].nomeSede + ` (€ ${sediCache[sedeId].costoNolo.toFixed(2)})`;
                    sedeLabSelect.appendChild(option);
                });
            });
        }

        async function caricaMaterialiInventarioPerCache() {
            inventarioCache = {};
            materialeInventarioSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>';
            
            const snapshot = await db.collection("inventario").orderBy("codiceArticolo", "asc").get();
            snapshot.forEach(doc => {
                const data = doc.data();
                inventarioCache[data.codiceArticolo] = {
                    nomeArticolo: data.nomeArticolo,
                    costoUnitario: parseFloat(data.costoUnitario || 0)
                };
                
                const option = document.createElement('option');
                option.value = data.codiceArticolo;
                option.textContent = `${data.codiceArticolo} - ${data.nomeArticolo} (€ ${inventarioCache[data.codiceArticolo].costoUnitario.toFixed(2)})`;
                materialeInventarioSelect.appendChild(option);
            });
        }
        
        async function caricaAttivitaPerCache() {
            attivitaCache = {};
            attivitaSelect.innerHTML = '<option value="">-- Seleziona Attività --</option>';
            
            const snapshot = await db.collection("attivita_labs").orderBy("nomeBreve", "asc").get();
            snapshot.forEach(doc => {
                const data = doc.data();
                attivitaCache[doc.id] = {
                    nomeBreve: data.nomeBreve,
                    costoBaseAttivita: parseFloat(data.costoBaseAttivita || 0),
                    durataMinuti: parseInt(data.durataMinutiAttivita || 60)
                };
                
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${data.codiceAttivita} - ${data.nomeBreve} (€ ${attivitaCache[doc.id].costoBaseAttivita.toFixed(2)})`;
                attivitaSelect.appendChild(option);
            });
        }
        
        // ==========================================================
        //         LOGICA GESTIONE LABS / PROGETTI
        // ==========================================================
        
        function impostaNomeDurata() {
            const tipologia = document.getElementById('tipologiaLab').value;
            const nomeBreveInput = document.getElementById('nomeBreveLab');
            const durataInput = document.getElementById('durataComplessivaOre');
            const data = TipologiaLabMapping[tipologia];

            if (data) {
                nomeBreveInput.value = data.nome;
                if (data.durata !== null) {
                    durataInput.value = data.durata;
                    durataInput.disabled = true;
                } else {
                    durataInput.disabled = false;
                }
            }
        }
        
        function aggiornaListaAttivitaHTML() {
            listaAttivitaAbbinateDiv.innerHTML = '';
            
            if (attivitaAbbinateLab.length === 0) {
                listaAttivitaAbbinateDiv.innerHTML = '<tr><td colspan="4" style="text-align: center; font-style: italic;">Nessuna attività abbinata.</td></tr>';
                calcolaDettagliFinanziari();
                return;
            }
            
            attivitaAbbinateLab.forEach((item, index) => {
                const attivita = attivitaCache[item.attivitaId] || { nomeBreve: 'Attività Sconosciuta', costoBaseAttivita: 0 };
                const row = listaAttivitaAbbinateDiv.insertRow();
                row.innerHTML = `
                    <td>${attivita.nomeBreve}</td>
                    <td>${item.durataAssegnataMinuti} min</td>
                    <td>€ ${attivita.costoBaseAttivita.toFixed(2)}</td>
                    <td><button type="button" class="danger" style="padding: 5px 8px; font-size: 0.8em;" onclick="rimuoviAttivitaLab(${index})">Rimuovi</button></td>
                `;
            });

            calcolaDettagliFinanziari();
        }

        function aggiungiAttivitaLab() {
            const attivitaId = attivitaSelect.value;
            const durata = parseInt(document.getElementById('durataAttivitaMinuti').value);
            
            if (!attivitaId || isNaN(durata) || durata <= 0 || !attivitaCache[attivitaId]) {
                alert("Selezione non valida.");
                return;
            }

            attivitaAbbinateLab.push({
                attivitaId: attivitaId,
                durataAssegnataMinuti: durata
            });
            
            aggiornaListaAttivitaHTML();
            document.getElementById('durataAttivitaMinuti').value = 60;
            attivitaSelect.value = '';
        }
        
        function rimuoviAttivitaLab(index) {
            attivitaAbbinateLab.splice(index, 1);
            aggiornaListaAttivitaHTML();
        }

        function calcolaDettagliFinanziari() {
            let costoTotaleAttivita = 0;
            attivitaAbbinateLab.forEach(item => {
                const attivita = attivitaCache[item.attivitaId];
                if (attivita) {
                    costoTotaleAttivita += attivita.costoBaseAttivita; 
                }
            });

            const sedeId = sedeLabSelect.value;
            const costoLogistica = sedeId && sediCache[sedeId] ? sediCache[sedeId].costoNolo : 0.00;
            
            const costoVivoLab = costoTotaleAttivita + costoLogistica;
            
            const profittoPerc = parseFloat(document.getElementById('percentualeProfittoDesiderata').value) || 125;
            const profittoMultiplier = profittoPerc / 100;
            const prezzoSuggerito = costoVivoLab * profittoMultiplier;
            const profittoEuro = prezzoSuggerito - costoVivoLab;

            const listinoEffettivo = parseFloat(document.getElementById('listinoEffettivo').value) || 0.00;
            const differenzaEuro = listinoEffettivo - prezzoSuggerito;
            const deltaPercent = (prezzoSuggerito > 0) ? (differenzaEuro / prezzoSuggerito) * 100 : 0;
            
            // Aggiornamento Visivo e Dataset
            document.getElementById('costoTotaleAttivita').textContent = `€ ${costoTotaleAttivita.toFixed(2)}`;
            document.getElementById('costoLogistica').textContent = `€ ${costoLogistica.toFixed(2)}`;
            
            document.getElementById('costoVivoLab').textContent = `€ ${costoVivoLab.toFixed(2)}`;
            document.getElementById('costoVivoLab').dataset.val = costoVivoLab.toFixed(2);

            document.getElementById('profittoDesideratoPerc').textContent = `${profittoPerc.toFixed(0)} %`;
            document.getElementById('profittoEuro').textContent = `€ ${profittoEuro.toFixed(2)}`;
            
            document.getElementById('prezzoSuggerito').textContent = `€ ${prezzoSuggerito.toFixed(2)}`;
            document.getElementById('prezzoSuggerito').dataset.val = prezzoSuggerito.toFixed(2);
            document.getElementById('listinoEffettivoVis').textContent = `€ ${listinoEffettivo.toFixed(2)}`;
            
            document.getElementById('differenzaEuro').textContent = `€ ${differenzaEuro.toFixed(2)}`;
            document.getElementById('differenzaEuro').style.color = differenzaEuro >= 0 ? 'green' : 'red';
            document.getElementById('differenzaEuro').dataset.val = differenzaEuro.toFixed(2);
            
            document.getElementById('deltaPercent').textContent = `${deltaPercent.toFixed(2)} %`;
            document.getElementById('deltaPercent').style.color = deltaPercent >= 0 ? 'green' : 'red';
            document.getElementById('deltaPercent').dataset.val = deltaPercent.toFixed(2);

            document.getElementById('costoPerPartecipante').textContent = `€ ${(costoVivoLab / 10).toFixed(2)}`;
        }

        async function caricaLabs() {
             tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Caricamento Labs...</td></tr>';
            
            db.collection("labs").orderBy("codiceLab", "asc").get().then(snapshot => {
                tabellaLabsBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nessun Lab trovato.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const costoVivo = parseFloat(data.costoVivoLab || 0);
                    const listino = parseFloat(data.listinoEffettivo || 0);
                    const prezzoSuggerito = parseFloat(data.prezzoSuggerito || 0);
                    const deltaPercent = parseFloat(data.deltaPercent || 0);
                    
                    const deltaColor = deltaPercent >= 0 ? '#28a745' : '#dc3545';
                    
                    const row = tabellaLabsBody.insertRow();
                    row.className = `row`;
                    
                    row.innerHTML = `
                        <td>${data.codiceLab || 'N/D'}</td>
                        <td>${TipologiaLabMapping[data.tipologiaLab]?.nome || data.tipologiaLab} - ${data.nomeBreve || 'N/D'}</td>
                        <td>${data.durataComplessivaOre || '-'}</td>
                        <td>€ ${costoVivo.toFixed(2)}</td>
                        <td>€ ${prezzoSuggerito.toFixed(2)}</td>
                        <td>€ ${listino.toFixed(2)}</td>
                        <td style="color: ${deltaColor}; font-weight: bold;">${deltaPercent.toFixed(1)} %</td>
                        <td>${data.statoAvanzamento || 'N/D'}</td>
                        <td>
                            <button class="primary" style="background-color: #007bff; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); stampaSchedaLabPDF('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">PDF</button>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleLab('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaLab('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaLabsBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Errore nel caricamento Labs.</td></tr>';
                 console.error("Errore nel caricamento Labs:", error);
            });
        }

        function apriModaleLab(id = null, data = {}) {
            labForm.reset();
            document.getElementById('labId').value = id || '';
            document.getElementById('labModalTitle').textContent = id ? 'Modifica Lab/Progetto' : 'Aggiungi Nuovo Lab/Progetto';
            
            attivitaAbbinateLab = data.attivitaAbbinate ? JSON.parse(JSON.stringify(data.attivitaAbbinate)) : [];

            if (id) {
                // [Riempimento campi... mantenuto come prima]
                document.getElementById('codiceLab').value = data.codiceLab || '';
                document.getElementById('tipologiaLab').value = data.tipologiaLab || 'AL';
                document.getElementById('nomeBreveLab').value = data.nomeBreve || '';
                document.getElementById('durataComplessivaOre').value = data.durataComplessivaOre || 1;
                document.getElementById('sedeLabId').value = data.sedeLabId || '';
                document.getElementById('statoAvanzamento').value = data.statoAvanzamento || 'bozza';
                document.getElementById('descrizioneLab').value = data.descrizioneLab || '';
                document.getElementById('percentualeProfittoDesiderata').value = data.percentualeProfittoDesiderata || 125;
                document.getElementById('listinoEffettivo').value = parseFloat(data.listinoEffettivo || 0).toFixed(2);
                
                impostaNomeDurata(); 
            } else {
                document.getElementById('statoAvanzamento').value = 'bozza';
                document.getElementById('percentualeProfittoDesiderata').value = 125;
                document.getElementById('listinoEffettivo').value = '0.00';
                impostaNomeDurata();
            }
            
            aggiornaListaAttivitaHTML(); 
            calcolaDettagliFinanziari(); 
            labModal.style.display = "block";
        }
        
        function chiudiModaleLab() {
            labModal.style.display = "none";
            attivitaAbbinateLab = [];
        }
        
        labForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const labId = document.getElementById('labId').value;
            const isEditing = !!labId;
            
            const costoVivoLab = parseFloat(document.getElementById('costoVivoLab').dataset.val) || 0;
            const prezzoSuggerito = parseFloat(document.getElementById('prezzoSuggerito').dataset.val) || 0;
            const differenzaEuro = parseFloat(document.getElementById('differenzaEuro').dataset.val) || 0;
            const deltaPercent = parseFloat(document.getElementById('deltaPercent').dataset.val) || 0;

            const labData = {
                codiceLab: document.getElementById('codiceLab').value.toUpperCase().trim(),
                tipologiaLab: document.getElementById('tipologiaLab').value,
                nomeBreve: document.getElementById('nomeBreveLab').value,
                durataComplessivaOre: parseFloat(document.getElementById('durataComplessivaOre').value) || 0,
                sedeLabId: document.getElementById('sedeLabId').value,
                statoAvanzamento: document.getElementById('statoAvanzamento').value,
                descrizioneLab: document.getElementById('descrizioneLab').value,
                percentualeProfittoDesiderata: parseFloat(document.getElementById('percentualeProfittoDesiderata').value) || 125,
                listinoEffettivo: parseFloat(document.getElementById('listinoEffettivo').value) || 0.00,
                
                costoVivoLab: costoVivoLab,
                prezzoSuggerito: prezzoSuggerito,
                differenzaEuro: differenzaEuro,
                deltaPercent: deltaPercent, // Salviamo anche il delta %
                
                attivitaAbbinate: attivitaAbbinateLab
            };
            
            const collectionRef = db.collection("labs");
            let operation;

            if (!isEditing) {
                operation = collectionRef.add(labData);
            } else {
                 operation = collectionRef.doc(labId).update(labData);
            }
            
            operation.then(() => {
                alert(`Lab/Progetto ${isEditing ? 'aggiornato' : 'aggiunto'} con successo!`);
                chiudiModaleLab();
                caricaLabs(); 
                caricaPanoramica(); // Aggiorna la panoramica
            }).catch(error => {
                alert(`Errore nel salvataggio del Lab: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        /**
         * Funzione per la stampa della scheda Lab in PDF (FUNZIONANTE come placeholder)
         */
        function stampaSchedaLabPDF(labId, data) {
            if (labId) {
                 const nomeLab = data.nomeBreve || 'Senza Nome';
                 const costoVivo = parseFloat(data.costoVivoLab || 0).toFixed(2);
                 const listino = parseFloat(data.listinoEffettivo || 0).toFixed(2);

                alert(`Scheda Lab (PDF) in preparazione per: ${nomeLab}.\n\nRiepilogo:\nCosto Vivo: € ${costoVivo}\nListino: € ${listino}\n\n(L'integrazione completa del generatore PDF richiede librerie esterne come jsPDF).`);
            } else {
                 alert("Salva il Lab prima di generare la scheda PDF.");
            }
        }

        function eliminaLab(id) {
            if (confirm("Sei sicuro di voler eliminare questo Lab/Progetto? L'operazione è irreversibile.")) {
                db.collection("labs").doc(id).delete().then(() => {
                    alert("Lab/Progetto eliminato con successo.");
                    caricaLabs(); 
                    caricaPanoramica(); // Aggiorna la panoramica
                }).catch(error => {
                    alert("Errore durante l'eliminazione del Lab: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }
        
        // ==========================================================
        //         LOGICA GESTIONE ATTIVITÀ
        // ==========================================================
        
        function impostaNomeBreveAttivita() {
            const tipologia = document.getElementById('tipologiaAttivita').value;
            document.getElementById('nomeBreveAttivita').value = TipologiaAttivitaMapping[tipologia] || '';
        }

        function calcolaCostoAttivita() {
            let costoTotale = 0;
            materialiRichiestiAttivita.forEach(materiale => {
                const inventarioItem = inventarioCache[materiale.codiceArticolo];
                if (inventarioItem) {
                    costoTotale += inventarioItem.costoUnitario * materiale.quantita;
                }
            });

            document.getElementById('costoBaseAttivita').value = costoTotale.toFixed(2);
            costoBaseAttivitaVisual.value = costoTotale.toFixed(2);
        }

        function aggiungiMateriale() {
            const codiceArticolo = materialeInventarioSelect.value;
            const quantita = parseInt(document.getElementById('quantitaRichiesta').value);
            
            if (!codiceArticolo || isNaN(quantita) || quantita <= 0 || !inventarioCache[codiceArticolo]) {
                alert("Selezione non valida.");
                return;
            }
            
            const inventarioItem = inventarioCache[codiceArticolo];
            const existingIndex = materialiRichiestiAttivita.findIndex(m => m.codiceArticolo === codiceArticolo);
            
            if (existingIndex > -1) {
                materialiRichiestiAttivita[existingIndex].quantita += quantita;
            } else {
                materialiRichiestiAttivita.push({
                    codiceArticolo: codiceArticolo,
                    nomeArticolo: inventarioItem.nomeArticolo,
                    quantita: quantita
                });
            }
            
            aggiornaListaMaterialiHTML();
            document.getElementById('quantitaRichiesta').value = 1;
            materialeInventarioSelect.value = '';
        }
        
        function rimuoviMateriale(index) {
            materialiRichiestiAttivita.splice(index, 1);
            aggiornaListaMaterialiHTML();
        }

        function aggiornaListaMaterialiHTML() {
            listaMaterialiRichiestiDiv.innerHTML = '';
            
            if (materialiRichiestiAttivita.length === 0) {
                listaMaterialiRichiestiDiv.innerHTML = '<tr><td colspan="4" style="text-align: center; font-style: italic;">Nessun materiale richiesto.</td></tr>';
            }
            
            materialiRichiestiAttivita.forEach((materiale, index) => {
                const inventarioItem = inventarioCache[materiale.codiceArticolo] || { costoUnitario: 0 };
                const row = listaMaterialiRichiestiDiv.insertRow();
                row.innerHTML = `
                    <td>${materiale.nomeArticolo} (${materiale.codiceArticolo})</td>
                    <td>${materiale.quantita}</td>
                    <td>€ ${inventarioItem.costoUnitario.toFixed(2)}</td>
                    <td><button type="button" class="danger" style="padding: 5px 8px; font-size: 0.8em;" onclick="rimuoviMateriale(${index})">Rimuovi</button></td>
                `;
            });
            
            calcolaCostoAttivita();
        }
        
        function caricaAttivita() {
             tabellaAttivitaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Caricamento Attività...</td></tr>';
            
            db.collection("attivita_labs").orderBy("codiceAttivita", "asc").get().then(snapshot => {
                tabellaAttivitaBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaAttivitaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nessuna Attività trovata.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const materialiCount = (data.materialiRichiesti || []).length;
                    const fabbisognoVisual = materialiCount > 0 ? `${materialiCount} Articoli (OK)` : 'Nessun Fabbisogno';
                    
                    const row = tabellaAttivitaBody.insertRow();
                    row.className = `row`;
                    
                    row.innerHTML = `
                        <td>${data.codiceAttivita || 'N/D'}</td>
                        <td>${TipologiaAttivitaMapping[data.tipologiaAttivita] || data.tipologiaAttivita} - ${data.nomeBreve || 'N/D'}</td>
                        <td>${data.durataMinutiAttivita || '0'}</td>
                        <td>€ ${parseFloat(data.costoBaseAttivita || 0).toFixed(2)}</td>
                        <td>${fabbisognoVisual}</td>
                        <td>${data.statoAttivita || 'N/D'}</td>
                        <td>
                            <button class="primary" style="background-color: #007bff; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); stampaSchedaAttivitaPDF('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">PDF</button>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleAttivita('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaAttivita('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaAttivitaBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Errore nel caricamento attività.</td></tr>';
                 console.error("Errore nel caricamento attività:", error);
            });
        }
        
        function apriModaleAttivita(id = null, data = {}) {
            attivitaForm.reset();
            document.getElementById('attivitaId').value = id || '';
            document.getElementById('attivitaModalTitle').textContent = id ? 'Modifica Attività' : 'Aggiungi Nuova Attività';
            
            materialiRichiestiAttivita = data.materialiRichiesti ? JSON.parse(JSON.stringify(data.materialiRichiesti)) : [];

            if (id) {
                // [Riempimento campi... mantenuto come prima]
                document.getElementById('codiceAttivita').value = data.codiceAttivita || '';
                document.getElementById('tipologiaAttivita').value = data.tipologiaAttivita || 'ROU';
                document.getElementById('nomeBreveAttivita').value = data.nomeBreve || '';
                document.getElementById('durataMinutiAttivita').value = data.durataMinutiAttivita || 60;
                document.getElementById('statoAttivita').value = data.statoAttivita || 'bozza';
                document.getElementById('linkAudio').value = data.linkAudio || '';
                document.getElementById('descrizioneAttivita').value = data.descrizioneAttivita || '';
            } else {
                document.getElementById('statoAttivita').value = 'bozza';
                impostaNomeBreveAttivita(); 
            }
            
            aggiornaListaMaterialiHTML(); 
            attivitaModal.style.display = "block";
        }

        function chiudiModaleAttivita() {
            attivitaModal.style.display = "none";
            materialiRichiestiAttivita = []; 
        }
        
        attivitaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const attivitaId = document.getElementById('attivitaId').value;
            const isEditing = !!attivitaId;
            
            const costoBaseAttivita = parseFloat(document.getElementById('costoBaseAttivita').value) || 0.00;

            const attivitaData = {
                codiceAttivita: document.getElementById('codiceAttivita').value.toUpperCase().trim(),
                tipologiaAttivita: document.getElementById('tipologiaAttivita').value,
                nomeBreve: document.getElementById('nomeBreveAttivita').value,
                durataMinutiAttivita: parseInt(document.getElementById('durataMinutiAttivita').value) || 60,
                statoAttivita: document.getElementById('statoAttivita').value,
                linkAudio: document.getElementById('linkAudio').value.trim(),
                descrizioneAttivita: document.getElementById('descrizioneAttivita').value,
                
                costoBaseAttivita: costoBaseAttivita,
                materialiRichiesti: materialiRichiestiAttivita
            };
            
            const collectionRef = db.collection("attivita_labs");
            let operation;

            if (!isEditing) {
                operation = collectionRef.add(attivitaData);
            } else {
                 operation = collectionRef.doc(attivitaId).update(attivitaData);
            }
            
            operation.then(() => {
                alert(`Attività ${isEditing ? 'aggiornata' : 'aggiunta'} con successo!`);
                chiudiModaleAttivita();
                caricaAttivita(); 
                caricaAttivitaPerCache(); 
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        /**
         * Funzione per la stampa della scheda Attività in PDF (FUNZIONANTE come placeholder)
         */
        function stampaSchedaAttivitaPDF(attivitaId, data) {
             if (attivitaId) {
                const nomeAttivita = data.nomeBreve || 'Senza Nome';
                const costoBase = parseFloat(data.costoBaseAttivita || 0).toFixed(2);
                const materiali = (data.materialiRichiesti || []).length;
                
                alert(`Scheda Attività (PDF) in preparazione per: ${nomeAttivita}.\n\nRiepilogo:\nCosto Base Materiali: € ${costoBase}\nFabbisogno: ${materiali} articoli.\n\n(L'integrazione completa del generatore PDF richiede librerie esterne come jsPDF).`);
             } else {
                alert("Salva l'Attività prima di generare la scheda PDF.");
             }
        }

        function eliminaAttivita(id) {
            if (confirm("Sei sicuro di voler eliminare questa Attività dal catalogo?")) {
                db.collection("attivita_labs").doc(id).delete().then(() => {
                    alert("Attività eliminata con successo.");
                    caricaAttivita(); 
                    caricaAttivitaPerCache();
                }).catch(error => {
                    alert("Errore durante l'eliminazione dell'attività: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }
    </script>
</body>
</html>