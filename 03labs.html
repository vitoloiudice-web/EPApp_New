<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Labs & Attività</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>

    <style>
        /* [Stili CSS base identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .mobile-header { display: none; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 1000px; /* Aumentato per i nuovi campi */ } 
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* Griglia Modale */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Stili specifici per la gestione dei materiali (Fabbisogno) */
        .fabbisogno-header { margin-top: 20px; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; color: #343a40; border-bottom: 2px solid #A5DD2E; padding-bottom: 5px; }
        .materiale-add-grid { display: grid; grid-template-columns: 3fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 15px; }
        .materiali-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .materiali-list-table th, .materiali-list-table td { padding: 8px; border: 1px solid #eee; text-align: left; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .form-grid, .materiale-add-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 10% 5%; width: 90%; max-width: 90%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Labs & Attività</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI & ISCRIZIONI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link active">LABS & ATTIVITÀ</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Labs, Progetti e Attività Didattiche</h1>

            <div class="data-section" style="margin-bottom: 30px;">
                <h2 style="margin-top: 0;">Gestione Labs/Progetti</h2>
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLab(null)">➕ Aggiungi Lab/Progetto</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome Lab/Progetto</th>
                                <th>Costo Orario Base</th>
                                <th>Listino</th>
                                <th>Differenza €</th>
                                <th>Delta %</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLabsBody">
                            <tr><td colspan="8" style="text-align: center;">Nessun Lab caricato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="data-section">
                <h2>Catalogo Attività (Fabbisogno)</h2>
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleAttivita(null)">➕ Aggiungi Attività</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome Attività</th>
                                <th>Categoria</th>
                                <th>Costo Base</th>
                                <th>Materiali (Fabbisogno)</th>
                                <th>Link Audio/Base</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaAttivitaBody">
                            <tr><td colspan="6" style="text-align: center;">Nessuna Attività caricata.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="labModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLab()">&times;</span>
            <h2 id="labModalTitle">Aggiungi Nuovo Lab/Progetto</h2>
            <form id="labForm">
                <input type="hidden" id="labId" value="">

                <div class="form-grid">
                    <div class="form-group">
                        <label for="codiceLab">Codice Lab (Interno)</label>
                        <input type="text" id="codiceLab" required>
                    </div>
                    <div class="form-group">
                        <label for="nomeLab">Nome Lab/Progetto</label>
                        <input type="text" id="nomeLab" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetEta">Target Età</label>
                        <input type="text" id="targetEta" placeholder="Es: 6-10 anni">
                    </div>
                    
                    <div class="form-group">
                        <label for="costoOrarioBase">Costo Orario Base (€) - *Costo Interno</label>
                        <input type="number" id="costoOrarioBase" step="0.01" min="0" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="listinoOrario">Listino Orario (€) - *Prezzo al Pubblico</label>
                        <input type="number" id="listinoOrario" step="0.01" min="0" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="statoLab">Stato Lab</label>
                        <select id="statoLab">
                            <option value="disponibile">Disponibile (Catalogo)</option>
                            <option value="bozza">Bozza (In Elaborazione)</option>
                            <option value="archiviato">Archiviato</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dettagliLogistica">Logistica / Note Aggiuntive</label>
                    <textarea id="dettagliLogistica" rows="2" placeholder="Costo stimato nolo furgone, necessità di trasporto specifiche..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="descrizioneLab">Descrizione Dettagliata</label>
                    <textarea id="descrizioneLab" rows="3"></textarea>
                </div>

                <div class="modal-buttons" style="margin-top: 30px; text-align: right;">
                    <button type="button" onclick="chiudiModaleLab()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Lab</button>
                </div>
            </form>
        </div>
    </div>


    <div id="attivitaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleAttivita()">&times;</span>
            <h2 id="attivitaModalTitle">Aggiungi Nuova Attività</h2>
            <form id="attivitaForm">
                <input type="hidden" id="attivitaId" value="">

                <div class="form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="nomeAttivita">Nome Attività</label>
                        <input type="text" id="nomeAttivita" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoriaAttivita">Categoria</label>
                        <select id="categoriaAttivita">
                            <option value="arte">Arte e Manualità</option>
                            <option value="scien">Scienza e Natura</option>
                            <option value="musica">Musica e Ritmo</option>
                            <option value="motoria">Attività Motoria</option>
                            <option value="teatro">Teatro e Narrazione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="costoBaseAttivita">Costo Base Attività (€)</label>
                        <input type="number" id="costoBaseAttivita" step="0.01" min="0" value="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="linkAudio">Link Audio/Base (YouTube/Spotify, ecc.)</label>
                    <input type="url" id="linkAudio" placeholder="https://youtube.com/...">
                </div>
                
                <div class="form-group">
                    <label for="descrizioneAttivita">Descrizione Dettagliata</label>
                    <textarea id="descrizioneAttivita" rows="3"></textarea>
                </div>

                <div class="fabbisogno-header">Fabbisogno Materiali (da Inventario)</div>
                <div class="materiale-add-grid">
                    <div class="form-group">
                        <label for="materialeInventarioSelect">Articolo dall'Inventario</label>
                        <select id="materialeInventarioSelect">
                            <option value="">-- Caricamento Inventario... --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantitaRichiesta">Quantità Necessaria</label>
                        <input type="number" id="quantitaRichiesta" min="1" value="1">
                    </div>
                    <button type="button" class="primary" onclick="aggiungiMateriale()" style="width: 100%; margin: 0; padding: 10px 5px;">Aggiungi</button>
                </div>

                <div class="table-responsive">
                    <table class="materiali-list-table">
                        <thead>
                            <tr>
                                <th style="width: 70%;">Articolo</th>
                                <th style="width: 15%;">Qtà</th>
                                <th style="width: 15%;">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="listaMaterialiRichiesti">
                            <tr><td colspan="3" style="text-align: center; font-style: italic;">Nessun materiale richiesto.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-buttons" style="margin-top: 30px; text-align: right;">
                    <button type="button" onclick="chiudiModaleAttivita()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Attività</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // CONFIGURAZIONE FIREBASE 
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaLabsBody = document.getElementById('tabellaLabsBody');
        const labModal = document.getElementById('labModal');
        const labForm = document.getElementById('labForm');

        const attivitaModal = document.getElementById('attivitaModal');
        const attivitaForm = document.getElementById('attivitaForm');
        const tabellaAttivitaBody = document.getElementById('tabellaAttivitaBody');
        const listaMaterialiRichiestiDiv = document.getElementById('listaMaterialiRichiesti');
        const materialeInventarioSelect = document.getElementById('materialeInventarioSelect');

        // Mappatura per visualizzazione (Attività)
        const CategoriaAttivitaMapping = {
            'arte': 'Arte e Manualità', 
            'scien': 'Scienza e Natura', 
            'musica': 'Musica e Ritmo',
            'motoria': 'Attività Motoria',
            'teatro': 'Teatro e Narrazione'
        };

        // VARIABILE GLOBALE PER IL FABBISOGNO: Array di oggetti materiali per l'attività corrente
        let materialiRichiestiAttivita = [];

        // --- FUNZIONI UTILITY e FIREBASE ---

        function toggleNav() {
            document.getElementById('dashboardNav').classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        auth.onAuthStateChanged((user) => {
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (user) {
                dashboardContainer.style.display = 'flex';
                // Carica entrambe le collezioni e i materiali
                caricaLabs();
                caricaAttivita(); 
                caricaMaterialiInventarioPerSelect();
            } else {
                dashboardContainer.style.display = 'none';
                window.location.href = '00index.html'; 
            }
        });
        
        // ==========================================================
        //         LOGICA GESTIONE LABS / PROGETTI (COMPLETA)
        // ==========================================================
        
        /**
         * Carica e visualizza tutti i Labs/Progetti.
         */
        function caricaLabs() {
             tabellaLabsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Caricamento Labs...</td></tr>';
            
            db.collection("labs").orderBy("nomeLab", "asc").get().then(snapshot => {
                tabellaLabsBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaLabsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun Lab trovato.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const costoBase = parseFloat(data.costoOrarioBase || 0);
                    const listino = parseFloat(data.listinoOrario || 0);
                    
                    const differenza = listino - costoBase;
                    const deltaPercent = (costoBase > 0) ? (differenza / costoBase) * 100 : 0;
                    
                    // Colore del Delta %
                    const deltaColor = deltaPercent > 0 ? '#28a745' : (deltaPercent < 0 ? '#dc3545' : '#6c757d');
                    
                    const row = tabellaLabsBody.insertRow();
                    row.className = `row`;
                    
                    row.innerHTML = `
                        <td>${data.codiceLab || 'N/D'}</td>
                        <td>${data.nomeLab || 'N/D'} (${data.targetEta || 'N/D'})</td>
                        <td>€ ${costoBase.toFixed(2)}</td>
                        <td>€ ${listino.toFixed(2)}</td>
                        <td>€ ${differenza.toFixed(2)}</td>
                        <td style="color: ${deltaColor}; font-weight: bold;">${deltaPercent.toFixed(1)} %</td>
                        <td>${data.statoLab || 'N/D'}</td>
                        <td>
                            <button class="primary" style="background-color: #007bff; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); stampaSchedaLabPDF('${doc.id}')">PDF</button>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleLab('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaLab('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaLabsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento Labs.</td></tr>';
                 console.error("Errore nel caricamento Labs:", error);
            });
        }

        /**
         * Apre la modale per aggiungere o modificare un Lab.
         */
        function apriModaleLab(id = null, data = {}) {
            labForm.reset();
            document.getElementById('labId').value = id || '';
            document.getElementById('labModalTitle').textContent = id ? 'Modifica Lab/Progetto' : 'Aggiungi Nuovo Lab/Progetto';

            if (id) {
                document.getElementById('codiceLab').value = data.codiceLab || '';
                document.getElementById('nomeLab').value = data.nomeLab || '';
                document.getElementById('targetEta').value = data.targetEta || '';
                document.getElementById('statoLab').value = data.statoLab || 'disponibile';
                document.getElementById('descrizioneLab').value = data.descrizioneLab || '';
                
                // CAMPI FINANZIARI E LOGISTICA
                document.getElementById('costoOrarioBase').value = parseFloat(data.costoOrarioBase || 0).toFixed(2);
                document.getElementById('listinoOrario').value = parseFloat(data.listinoOrario || 0).toFixed(2);
                document.getElementById('dettagliLogistica').value = data.dettagliLogistica || '';

            } else {
                document.getElementById('statoLab').value = 'disponibile';
                document.getElementById('costoOrarioBase').value = '0.00';
                document.getElementById('listinoOrario').value = '0.00';
            }
            
            labModal.style.display = "block";
        }
        
        /**
         * Chiude la modale Lab.
         */
        function chiudiModaleLab() {
            labModal.style.display = "none";
        }
        
        /**
         * Gestisce il salvataggio o l'aggiornamento del Lab.
         */
        labForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const labId = document.getElementById('labId').value;
            const isEditing = !!labId;
            
            const costoBase = parseFloat(document.getElementById('costoOrarioBase').value) || 0.00;
            const listino = parseFloat(document.getElementById('listinoOrario').value) || 0.00;

            const labData = {
                codiceLab: document.getElementById('codiceLab').value.toUpperCase().trim(),
                nomeLab: document.getElementById('nomeLab').value,
                targetEta: document.getElementById('targetEta').value.trim(),
                statoLab: document.getElementById('statoLab').value,
                descrizioneLab: document.getElementById('descrizioneLab').value,
                
                // CAMPI FINANZIARI E LOGISTICA
                costoOrarioBase: costoBase, 
                listinoOrario: listino,
                dettagliLogistica: document.getElementById('dettagliLogistica').value,
                // Campi calcolati in fase di caricamento tabella, ma utili per il salvataggio
                differenzaEuro: listino - costoBase,
            };
            
            const collectionRef = db.collection("labs");
            let operation;

            if (!isEditing) {
                operation = collectionRef.add(labData);
            } else {
                 operation = collectionRef.doc(labId).update(labData);
            }
            
            operation.then(() => {
                alert(`Lab/Progetto ${isEditing ? 'aggiornato' : 'aggiunto'} con successo!`);
                chiudiModaleLab();
                caricaLabs(); 
            }).catch(error => {
                alert(`Errore nel salvataggio del Lab: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        /**
         * Funzione placeholder per la stampa della scheda Lab in PDF
         */
        function stampaSchedaLabPDF(labId) {
            // Qui andrebbe la logica per generare un PDF (es. usando librerie come jsPDF o un servizio backend)
            alert(`Generazione Scheda Lab PDF per l'ID: ${labId}. (Funzione da implementare)`);
            console.log("PDF generation triggered for Lab ID:", labId);
        }

        /**
         * Elimina un Lab.
         */
        function eliminaLab(id) {
            if (confirm("Sei sicuro di voler eliminare questo Lab/Progetto? L'operazione è irreversibile.")) {
                db.collection("labs").doc(id).delete().then(() => {
                    alert("Lab/Progetto eliminato con successo.");
                    caricaLabs(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione del Lab: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }
        
        // ==========================================================
        //         LOGICA GESTIONE ATTIVITÀ (CON FABBISOGNO E COSTO)
        // ==========================================================
        
        // (Le funzioni caricaMaterialiInventarioPerSelect, aggiungiMateriale, rimuoviMateriale, 
        //  aggiornaListaMaterialiHTML, caricaAttivita, apriModaleAttivita, chiudiModaleAttivita, 
        //  attivitaForm.addEventListener('submit'), eliminaAttivita sono invariate e corrette per la logica Attività/Fabbisogno)
        
        
        /**
         * Carica l'elenco degli articoli dall'Inventario e popola il campo select.
         */
        function caricaMaterialiInventarioPerSelect() {
            materialeInventarioSelect.innerHTML = '<option value="">-- Caricamento Inventario... --</option>';
            
            db.collection("inventario").orderBy("codiceArticolo", "asc").get().then(snapshot => {
                
                materialeInventarioSelect.innerHTML = '<option value="">-- Seleziona Articolo --</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const nomeVisualizzato = `${data.codiceArticolo || 'N/D'} - ${data.nomeArticolo || 'Articolo Senza Nome'}`;
                    
                    const option = document.createElement('option');
                    option.value = data.codiceArticolo; 
                    option.textContent = nomeVisualizzato;
                    option.setAttribute('data-nome', data.nomeArticolo); 
                    materialeInventarioSelect.appendChild(option);
                });

                if (snapshot.empty) {
                     materialeInventarioSelect.innerHTML = '<option value="">-- Nessun Articolo Trovato in Inventario --</option>';
                }
                
            }).catch(error => {
                materialeInventarioSelect.innerHTML = '<option value="">-- Errore Caricamento Inventario --</option>';
                console.error("Errore nel caricamento inventario per la select:", error);
            });
        }

        /**
         * Aggiunge un materiale selezionato e la quantità all'array del fabbisogno.
         */
        function aggiungiMateriale() {
            const codiceArticolo = materialeInventarioSelect.value;
            const quantita = parseInt(document.getElementById('quantitaRichiesta').value);
            
            if (!codiceArticolo) {
                alert("Seleziona prima un articolo dall'inventario.");
                return;
            }
            if (isNaN(quantita) || quantita <= 0) {
                alert("Inserisci una quantità valida (maggiore di zero).");
                return;
            }
            
            const selectedOption = materialeInventarioSelect.options[materialeInventarioSelect.selectedIndex];
            const nomeArticolo = selectedOption.getAttribute('data-nome') || selectedOption.textContent.split(' - ')[1] || selectedOption.textContent;

            const existingIndex = materialiRichiestiAttivita.findIndex(m => m.codiceArticolo === codiceArticolo);
            
            if (existingIndex > -1) {
                materialiRichiestiAttivita[existingIndex].quantita += quantita;
                alert(`Quantità per ${nomeArticolo} aggiornata a ${materialiRichiestiAttivita[existingIndex].quantita}.`);
            } else {
                materialiRichiestiAttivita.push({
                    codiceArticolo: codiceArticolo,
                    nomeArticolo: nomeArticolo,
                    quantita: quantita
                });
            }
            
            aggiornaListaMaterialiHTML();
            
            document.getElementById('quantitaRichiesta').value = 1;
            materialeInventarioSelect.value = '';
        }
        
        /**
         * Rimuove un materiale dall'array del fabbisogno.
         */
        function rimuoviMateriale(index) {
            if (confirm(`Sei sicuro di voler rimuovere ${materialiRichiestiAttivita[index].nomeArticolo} dal fabbisogno?`)) {
                materialiRichiestiAttivita.splice(index, 1);
                aggiornaListaMaterialiHTML();
            }
        }

        /**
         * Aggiorna la tabella HTML dei materiali richiesti.
         */
        function aggiornaListaMaterialiHTML() {
            listaMaterialiRichiestiDiv.innerHTML = '';
            
            if (materialiRichiestiAttivita.length === 0) {
                listaMaterialiRichiestiDiv.innerHTML = '<tr><td colspan="3" style="text-align: center; font-style: italic;">Nessun materiale richiesto.</td></tr>';
                return;
            }
            
            materialiRichiestiAttivita.forEach((materiale, index) => {
                const row = listaMaterialiRichiestiDiv.insertRow();
                row.innerHTML = `
                    <td>${materiale.nomeArticolo} (${materiale.codiceArticolo})</td>
                    <td>${materiale.quantita}</td>
                    <td><button type="button" class="danger" style="padding: 5px 8px; font-size: 0.8em;" onclick="rimuoviMateriale(${index})">Rimuovi</button></td>
                `;
            });
        }
        
        /**
         * Carica e visualizza tutte le attività.
         */
        function caricaAttivita() {
             tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Caricamento Attività...</td></tr>';
            
            db.collection("attivita_labs").orderBy("nomeAttivita", "asc").get().then(snapshot => {
                tabellaAttivitaBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nessuna Attività trovata.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const materialiCount = (data.materialiRichiesti || []).length;
                    const fabbisognoVisual = materialiCount > 0 ? `${materialiCount} Articoli (OK)` : 'Nessun Fabbisogno';
                    
                    const row = tabellaAttivitaBody.insertRow();
                    row.className = `row`;
                    
                    row.innerHTML = `
                        <td>${data.nomeAttivita || 'N/D'}</td>
                        <td>${CategoriaAttivitaMapping[data.categoriaAttivita] || data.categoriaAttivita}</td>
                        <td>€ ${parseFloat(data.costoBaseAttivita || 0).toFixed(2)}</td>
                        <td>${fabbisognoVisual}</td>
                        <td>${data.linkAudio ? '<a href="' + data.linkAudio + '" target="_blank">Link</a>' : '-'}</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleAttivita('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaAttivita('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaAttivitaBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Errore nel caricamento attività.</td></tr>';
                 console.error("Errore nel caricamento attività:", error);
            });
        }
        
        /**
         * Apre la modale per aggiungere o modificare un'attività.
         */
        function apriModaleAttivita(id = null, data = {}) {
            attivitaForm.reset();
            document.getElementById('attivitaId').value = id || '';
            document.getElementById('attivitaModalTitle').textContent = id ? 'Modifica Attività' : 'Aggiungi Nuova Attività';
            
            materialiRichiestiAttivita = data.materialiRichiesti ? JSON.parse(JSON.stringify(data.materialiRichiesti)) : [];

            if (id) {
                document.getElementById('nomeAttivita').value = data.nomeAttivita || '';
                document.getElementById('categoriaAttivita').value = data.categoriaAttivita || 'arte';
                document.getElementById('linkAudio').value = data.linkAudio || '';
                document.getElementById('descrizioneAttivita').value = data.descrizioneAttivita || '';
                document.getElementById('costoBaseAttivita').value = parseFloat(data.costoBaseAttivita || 0).toFixed(2);
            } else {
                document.getElementById('categoriaAttivita').value = 'arte';
                document.getElementById('costoBaseAttivita').value = '0.00';
            }
            
            aggiornaListaMaterialiHTML();
            
            attivitaModal.style.display = "block";
        }

        /**
         * Chiude la modale Attività.
         */
        function chiudiModaleAttivita() {
            attivitaModal.style.display = "none";
            materialiRichiestiAttivita = []; 
        }
        
        /**
         * Gestisce il salvataggio o l'aggiornamento dell'attività.
         */
        attivitaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const attivitaId = document.getElementById('attivitaId').value;
            const isEditing = !!attivitaId;
            
            const attivitaData = {
                nomeAttivita: document.getElementById('nomeAttivita').value,
                categoriaAttivita: document.getElementById('categoriaAttivita').value,
                linkAudio: document.getElementById('linkAudio').value.trim(),
                descrizioneAttivita: document.getElementById('descrizioneAttivita').value,
                costoBaseAttivita: parseFloat(document.getElementById('costoBaseAttivita').value) || 0.00,
                
                materialiRichiesti: materialiRichiestiAttivita
            };
            
            const collectionRef = db.collection("attivita_labs");
            let operation;

            if (!isEditing) {
                operation = collectionRef.add(attivitaData);
            } else {
                 operation = collectionRef.doc(attivitaId).update(attivitaData);
            }
            
            operation.then(() => {
                alert(`Attività ${isEditing ? 'aggiornata' : 'aggiunta'} con successo!`);
                chiudiModaleAttivita();
                caricaAttivita(); 
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        /**
         * Elimina un'attività.
         */
        function eliminaAttivita(id) {
            if (confirm("Sei sicuro di voler eliminare questa Attività dal catalogo?")) {
                db.collection("attivita_labs").doc(id).delete().then(() => {
                    alert("Attività eliminata con successo.");
                    caricaAttivita(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione dell'attività: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }

    </script>
</body>
</html>
