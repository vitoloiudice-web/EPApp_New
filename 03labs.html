<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Labs & Attivit√†</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* [Stili CSS base copiati per coerenza] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .mobile-header { display: none; }
        .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 3% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Stili per la sezione Attivit√† */
        .attivita-item { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .attivita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .attivita-header h4 { margin: 0; font-size: 1.1em; }

        /* Stili per la sezione Materiali/Strumenti */
        .materiale-row {
            display: grid;
            /* Descrizione/Link (2fr) | Prezzo (1fr) | Bottone (50px) */
            grid-template-columns: 2fr 1fr 50px; 
            gap: 10px;
            margin-bottom: 8px;
            align-items: end;
        }
        .materiale-row label { display: none; } 
        .materiale-costo { 
            font-weight: bold; 
            margin-top: 10px;
            text-align: right;
            padding-right: 15px;
            color: #28a745;
        }
        /* Stili per la sezione Finanza/Riepilogo */
        #riepilogoFinanziario p {
            font-size: 1.1em;
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        #prezzoSuggerito { color: #A5DD2E; font-size: 1.2em; }
        #moltiplicatoreMinimo { color: #dc3545; }
        
        /* Stili specifici per il PDF (Da nascondere) */
        .pdf-export-content {
            padding: 30px;
            font-family: Arial, sans-serif;
            color: #000;
        }
        .pdf-section-title {
            background-color: #A5DD2E;
            color: #343a40;
            padding: 5px;
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .pdf-data-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            border: 1px solid #ccc;
            margin-top: 5px;
        }
        .pdf-label {
            padding: 5px 10px;
            background-color: #f1f1f1;
            font-weight: bold;
            border-right: 1px solid #ccc;
        }
        .pdf-value {
            padding: 5px 10px;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .pdf-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }


        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .form-grid { grid-template-columns: 1fr; }
            .materiale-row { grid-template-columns: 1fr 1fr 50px; }
            .modal-content { margin: 10% 5%; width: 90%; max-width: 90%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">‚ò∞</span>
            <h2>Labs & Attivit√†</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI & ISCRIZIONI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link active">LABS & ATTIVIT√Ä</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Gestione Labs e Progetti</h1>

            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleLab(null)">‚ûï Crea Nuovo Lab</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome Lab</th>
                                <th>Tipologia</th>
                                <th>Data Inizio</th>
                                <th>Stato</th>
                                <th>Costo Totale Stimato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaLabsBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="labModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleLab()">&times;</span>
            <h2 id="labModalTitle">Crea Nuovo Lab</h2>
            <form id="labForm">
                <input type="hidden" id="labId" value="">
                <input type="hidden" id="costoLogisticoInputHidden" value="0"> 

                <h3>Dati Principali</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nomeLab">Nome del Lab/Progetto</label>
                        <input type="text" id="nomeLab" required>
                    </div>
                    <div class="form-group">
                        <label for="tipoLab">Tipologia</label>
                        <select id="tipoLab">
                            <option value="scuola">Scuola</option>
                            <option value="estivo">Campus Estivo</option>
                            <option value="eventi">Evento/Fiera</option>
                            <option value="altro">Altro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataInizio">Data Inizio</label>
                        <input type="date" id="dataInizio">
                    </div>
                    <div class="form-group">
                        <label for="stato">Stato</label>
                        <select id="stato">
                            <option value="bozza">Bozza</option>
                            <option value="in preparazione">In Preparazione</option>
                            <option value="attivo">Attivo</option>
                            <option value="archiviato">Archiviato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="descrizione">Descrizione Breve</label>
                        <textarea id="descrizione" rows="1" style="resize: none;"></textarea>
                    </div>
                </div>

                <h3>Attivit√† (Fabbisogno)</h3>
                <p>Definisci qui le attivit√† e i **materiali/strumenti necessari** per questo Lab. Il costo √® calcolato automaticamente. **Usa il campo Descrizione Materiale anche per URL/Link.**</p>
                
                <div id="attivitaList">
                    </div>

                <button type="button" class="primary" style="margin-top: 10px;" onclick="aggiungiAttivita()">‚ûï Aggiungi Attivit√†</button>

                <h3>Costi Vivi & Finanza</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="costoMaterialiTotale">Costi Materiali & Attivit√† (Auto-calcolato)</label>
                        <input type="text" id="costoMaterialiTotale" value="‚Ç¨ 0.00" disabled style="background-color: #eee;">
                    </div>

                    <div class="form-group">
                        <label for="logisticaSelezionata">1. Logistica Associata (da 04logistica.html)</label>
                        <select id="logisticaSelezionata" onchange="handleLogisticaChange()">
                            <option value="">-- Seleziona Logistica --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="costoLogisticoDisplay">Costi Logistici (‚Ç¨) [Solo Visualizzazione]</label>
                        <strong id="costoLogisticoDisplay" style="display: block; padding: 10px; border: 1px solid #ccc; background-color: #f1f1f1; border-radius: 4px;">‚Ç¨ 0.00</strong>
                    </div>

                    <div class="form-group">
                        <label for="profittoDesiderato">2. Profitto Desiderato (%) <span style="color: #dc3545;">(Min. 125%)</span></label>
                        <input type="number" id="profittoDesiderato" step="1" min="125" value="125" onchange="calcolaRiepilogoFinanziario()">
                    </div>
                </div>

                <h4>Riepilogo Lab (Prezzo Suggerito)</h4>
                <div id="riepilogoFinanziario">
                    <p>Costo Totale Lab (Materiali + Logistica): <strong id="costoTotaleLab">‚Ç¨ 0.00</strong></p>
                    <p>Moltiplicatore Minimo (225% - Tasse/Admin): <strong id="moltiplicatoreMinimo">‚Ç¨ 0.00</strong></p>
                    <p>Prezzo Suggerito (con % Profitto): <strong id="prezzoSuggerito">‚Ç¨ 0.00</strong></p>
                </div>
                <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
                    <button type="button" class="primary" onclick="esportaLabInPDF()" style="background-color: #007bff; color: white;">
                        üíæ Esporta Scheda Lab in PDF
                    </button>
                    </div>


                <div class="modal-buttons" style="margin-top: 30px; text-align: right;">
                    <button type="button" onclick="chiudiModaleLab()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Lab</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pdfContent" class="pdf-export-content" style="display: none;">
        </div>


    <script>
        // CONFIGURAZIONE FIREBASE 
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaLabsBody = document.getElementById('tabellaLabsBody');
        const labModal = document.getElementById('labModal');
        const labForm = document.getElementById('labForm');
        const dashboardNav = document.getElementById('dashboardNav');
        const attivitaListDiv = document.getElementById('attivitaList');
        
        // Array per gestire le Attivit√† temporaneamente nella Modale
        let labAttivita = []; 
        let logisticaOptions = []; // Array per i dati Logistica
        
        // --- FUNZIONI UTILITY e FIREBASE ---

        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        auth.onAuthStateChanged((user) => {
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (user) {
                dashboardContainer.style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                caricaLabs(); 
            } else {
                dashboardContainer.style.display = 'none';
                window.location.href = '00index.html'; 
            }
        });

        // --- FUNZIONI GESTIONE LOGISTICA (SIMULATA) ---

        /**
         * FUNZIONE SIMULATA: Carica i record Logistica dal database.
         */
        async function caricaLogisticaOptions() {
            logisticaOptions = [
                { id: 'log_a', nome: 'Trasporto Kit Standard', costo: 150.00 },
                { id: 'log_b', nome: 'Noleggio Attrezzatura Esterno', costo: 450.00 },
                { id: 'log_c', nome: 'Nessun Costo Logistico (Log0)', costo: 0.00 }
            ];
            // Quando 04logistica.html esister√†, sostituiremo con la vera lettura da Firestore.
        }
        
        function popolaLogisticaSelect(selectedLogisticaId) {
            const select = document.getElementById('logisticaSelezionata');
            select.innerHTML = '<option value="">-- Seleziona Logistica --</option>';
            
            logisticaOptions.forEach(log => {
                const option = document.createElement('option');
                option.value = log.id;
                option.textContent = `${log.nome} (‚Ç¨ ${log.costo.toFixed(2)})`;
                option.dataset.costo = log.costo;
                if (log.id === selectedLogisticaId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function handleLogisticaChange() {
            const select = document.getElementById('logisticaSelezionata');
            const selectedOption = select.options[select.selectedIndex];
            
            let costo = 0;

            if (selectedOption && selectedOption.value) {
                costo = parseFloat(selectedOption.dataset.costo) || 0;
            }
            
            document.getElementById('costoLogisticoInputHidden').value = costo;
            document.getElementById('costoLogisticoDisplay').textContent = `‚Ç¨ ${costo.toFixed(2)}`;
            
            calcolaRiepilogoFinanziario();
        }

        // --- FUNZIONI CALCOLO ---

        function getCostoMaterialiTotale() {
            return labAttivita.reduce((sum, current) => {
                const costoAttivita = (current.materiali || []).reduce((matSum, mat) => matSum + (parseFloat(mat.prezzo) || 0), 0);
                return sum + costoAttivita;
            }, 0);
        }

        function calcolaCostoAttivita(attivitaIndex) {
            const materiali = labAttivita[attivitaIndex].materiali || [];
            const costoTotale = materiali.reduce((sum, mat) => sum + (parseFloat(mat.prezzo) || 0), 0);
            return costoTotale.toFixed(2);
        }

        function aggiornaCostoVisualizzato(attivitaIndex) {
            const costo = calcolaCostoAttivita(attivitaIndex);
            const costoElement = document.getElementById(`costoAttivita${attivitaIndex}`);
            if (costoElement) {
                costoElement.textContent = `Costo Attivit√†: ‚Ç¨ ${costo}`;
            }
            calcolaRiepilogoFinanziario(); 
        }

        function calcolaRiepilogoFinanziario() {
            const costoMaterialiTotale = getCostoMaterialiTotale();
            const costoLogistico = parseFloat(document.getElementById('costoLogisticoInputHidden').value) || 0;
            
            const inputProfitto = document.getElementById('profittoDesiderato');
            let profittoDesideratoPerc = parseFloat(inputProfitto.value) || 125;
            
            if (profittoDesideratoPerc < 125) {
                profittoDesideratoPerc = 125;
                inputProfitto.value = 125;
            }

            const costoTotaleLab = costoMaterialiTotale + costoLogistico;

            const moltiplicatoreMinimo = costoTotaleLab * 2.25;

            const moltiplicatoreUtente = 1 + (profittoDesideratoPerc / 100);
            const prezzoSuggerito = costoTotaleLab * moltiplicatoreUtente;

            document.getElementById('costoMaterialiTotale').value = `‚Ç¨ ${costoMaterialiTotale.toFixed(2)}`;
            document.getElementById('costoTotaleLab').textContent = `‚Ç¨ ${costoTotaleLab.toFixed(2)}`;
            document.getElementById('moltiplicatoreMinimo').textContent = `‚Ç¨ ${moltiplicatoreMinimo.toFixed(2)}`;
            document.getElementById('prezzoSuggerito').textContent = `‚Ç¨ ${prezzoSuggerito.toFixed(2)}`;
            
            return {
                costoMaterialiTotale: costoMaterialiTotale,
                costoLogistico: costoLogistico,
                profittoDesideratoPerc: profittoDesideratoPerc,
                costoTotaleLab: costoTotaleLab,
                moltiplicatoreMinimo: moltiplicatoreMinimo,
                prezzoSuggerito: prezzoSuggerito
            };
        }

        // --- FUNZIONI CRUD LABS ---

        function caricaLabs() {
            // ... (Funzione caricaLabs invariata)
             tabellaLabsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Caricamento Labs...</td></tr>';
            
            db.collection("labs").orderBy("dataInizio", "desc").get().then(snapshot => {
                tabellaLabsBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaLabsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nessun Lab trovato.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const costoMateriali = (data.attivita || []).reduce((sum, current) => {
                        const costoAttivita = (current.materiali || []).reduce((matSum, mat) => matSum + (mat.prezzo || 0), 0);
                        return sum + costoAttivita;
                    }, 0);

                    const costoLogistico = data.costoLogistico || 0;
                    const costoStimatoTotale = costoMateriali + costoLogistico;

                    const row = tabellaLabsBody.insertRow();
                    row.className = 'row';
                    row.onclick = () => apriModaleLab(doc.id, data);

                    row.innerHTML = `
                        <td>${data.nomeLab || 'N/D'}</td>
                        <td>${data.tipoLab || 'N/D'}</td>
                        <td>${data.dataInizio || 'N/D'}</td>
                        <td>${data.stato || 'bozza'}</td>
                        <td>‚Ç¨ ${costoStimatoTotale.toFixed(2)}</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleLab('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaLab('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaLabsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Errore nel caricamento Labs.</td></tr>';
                 console.error("Errore nel caricamento Labs:", error);
            });
        }

        async function apriModaleLab(id = null, data = {}) {
            labForm.reset();
            labAttivita = [];
            attivitaListDiv.innerHTML = '';
            document.getElementById('labId').value = id || '';
            document.getElementById('labModalTitle').textContent = id ? 'Modifica Lab' : 'Crea Nuovo Lab';

            await caricaLogisticaOptions(); 

            let logisticaIdSelezionata = '';
            
            if (id) {
                document.getElementById('nomeLab').value = data.nomeLab || '';
                document.getElementById('tipoLab').value = data.tipoLab || 'scuola';
                document.getElementById('dataInizio').value = data.dataInizio || '';
                document.getElementById('stato').value = data.stato || 'bozza';
                document.getElementById('descrizione').value = data.descrizione || '';
                
                document.getElementById('profittoDesiderato').value = data.profittoDesideratoPerc || 125;
                logisticaIdSelezionata = data.logisticaId || '';
                
                // Imposta il costo logistico salvato (in attesa del vero caricamento)
                document.getElementById('costoLogisticoInputHidden').value = data.costoLogistico || 0;

                labAttivita = data.attivita || [];
            } else {
                document.getElementById('profittoDesiderato').value = 125;
                document.getElementById('costoLogisticoInputHidden').value = 0;
            }
            
            popolaLogisticaSelect(logisticaIdSelezionata); 
            handleLogisticaChange(); 
            
            ricaricaListaAttivita(); 
            labModal.style.display = "block";
        }

        function chiudiModaleLab() {
            labModal.style.display = "none";
        }
        
        labForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const risultatiFinanziari = calcolaRiepilogoFinanziario(); 
            
            const labId = document.getElementById('labId').value;
            const isEditing = !!labId;
            
            const logisticaSelect = document.getElementById('logisticaSelezionata');
            
            const labData = {
                nomeLab: document.getElementById('nomeLab').value,
                tipoLab: document.getElementById('tipoLab').value,
                dataInizio: document.getElementById('dataInizio').value,
                stato: document.getElementById('stato').value,
                descrizione: document.getElementById('descrizione').value,
                
                // CAMPI FINANZIARI SALVATI
                logisticaId: logisticaSelect.value || null, 
                costoLogistico: risultatiFinanziari.costoLogistico, 
                costoMateriali: risultatiFinanziari.costoMaterialiTotale, // Aggiunto per tracciamento storico
                profittoDesideratoPerc: risultatiFinanziari.profittoDesideratoPerc,

                attivita: labAttivita 
            };
            
            const collectionRef = db.collection("labs");
            const operation = isEditing ? collectionRef.doc(labId).update(labData) : collectionRef.add(labData);
            
            operation.then(() => {
                // 1. Chiede se salvare il Lab
                if (confirm(`Lab ${isEditing ? 'aggiornato' : 'creato'} con successo! Vuoi salvare questa scheda Lab in PDF per il tracciamento storico?`)) {
                    // Se l'utente clicca OK, procede all'esportazione
                    esportaLabInPDF(labData); 
                }
                
                chiudiModaleLab();
                caricaLabs(); 
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        });

        // --- NUOVA FUNZIONE: ESPORTAZIONE PDF ---

        /**
         * Genera un PDF strutturato con i dati del Lab e forza il download.
         * @param {object} labData - L'oggetto dati Lab appena salvato o visualizzato.
         */
        function esportaLabInPDF(labData = null) {
            // Se la funzione √® chiamata dopo un salvataggio, usa i dati passati.
            // Altrimenti, recupera i dati attuali dalla Modale (utile se l'utente modifica ma non salva subito)
            if (!labData) {
                labData = {
                    nomeLab: document.getElementById('nomeLab').value || 'Lab Senza Nome',
                    tipoLab: document.getElementById('tipoLab').value,
                    dataInizio: document.getElementById('dataInizio').value,
                    stato: document.getElementById('stato').value,
                    descrizione: document.getElementById('descrizione').value,
                    attivita: labAttivita,
                    // Recupero dati finanziari
                    ...calcolaRiepilogoFinanziario(),
                    logisticaId: document.getElementById('logisticaSelezionata').value
                };
            }

            const risultatiFinanziari = calcolaRiepilogoFinanziario(); // Recalcolo per sicurezza
            const labName = labData.nomeLab.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'Scheda_Lab'; // Pulisce il nome per il file
            
            const pdfContainer = document.getElementById('pdfContent');
            
            // 2. e 3. Legge e Struttura i Valori in HTML (che sostituisce il CSV temporaneo)
            let htmlContent = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="color: #343a40;">SCHEDA LAB - ${labData.nomeLab.toUpperCase()}</h1>
                    <p style="color: #555;">Rapporto generato il: ${new Date().toLocaleDateString('it-IT')}</p>
                </div>
            `;

            // SEZIONE 1: DATI PRINCIPALI
            htmlContent += `
                <div class="pdf-section-title">DATI PRINCIPALI</div>
                <div class="pdf-data-grid">
                    <div class="pdf-label">Nome Lab</div><div class="pdf-value">${labData.nomeLab}</div>
                    <div class="pdf-label">Tipologia</div><div class="pdf-value">${labData.tipoLab}</div>
                    <div class="pdf-label">Data Inizio</div><div class="pdf-value">${labData.dataInizio}</div>
                    <div class="pdf-label">Stato</div><div class="pdf-value">${labData.stato}</div>
                    <div class="pdf-label">Descrizione</div><div class="pdf-value">${labData.descrizione || 'N/D'}</div>
                </div>
            `;

            // SEZIONE 2: RIEPILOGO FINANZIARIO
            // Trovo il nome della Logistica
            const logisticaNome = logisticaOptions.find(opt => opt.id === labData.logisticaId)?.nome || 'Nessuna Logistica Associata';

            htmlContent += `
                <div class="pdf-section-title">RIEPILOGO FINANZIARIO</div>
                <div class="pdf-data-grid">
                    <div class="pdf-label">Logistica Associata</div><div class="pdf-value">${logisticaNome}</div>
                    <div class="pdf-label">Costi Logistici (‚Ç¨)</div><div class="pdf-value">‚Ç¨ ${risultatiFinanziari.costoLogistico.toFixed(2)}</div>
                    <div class="pdf-label">Costi Materiali & Attivit√†</div><div class="pdf-value">‚Ç¨ ${risultatiFinanziari.costoMaterialiTotale.toFixed(2)}</div>
                    <div class="pdf-label" style="background-color: #A5DD2E;">COSTO TOTALE LAB (VIVO)</div><div class="pdf-value" style="font-weight: bold; background-color: #A5DD2E;">‚Ç¨ ${risultatiFinanziari.costoTotaleLab.toFixed(2)}</div>
                    <div class="pdf-label">Profitto Desiderato (%)</div><div class="pdf-value">${risultatiFinanziari.profittoDesideratoPerc}%</div>
                    <div class="pdf-label" style="color: #dc3545;">MOLTIPLICATORE MINIMO (225%)</div><div class="pdf-value" style="color: #dc3545; font-weight: bold;">‚Ç¨ ${risultatiFinanziari.moltiplicatoreMinimo.toFixed(2)}</div>
                    <div class="pdf-label" style="background-color: #f1f1f1;">PREZZO SUGGERITO</div><div class="pdf-value" style="font-weight: bold; font-size: 1.1em;">‚Ç¨ ${risultatiFinanziari.prezzoSuggerito.toFixed(2)}</div>
                </div>
            `;
            
            // SEZIONE 3: DETTAGLIO ATTIVIT√Ä
            htmlContent += `<div class="pdf-section-title">DETTAGLIO ATTIVIT√Ä E MATERIALI</div>`;

            if (labData.attivita && labData.attivita.length > 0) {
                labData.attivita.forEach((att, attIndex) => {
                    const costoAttivita = (att.materiali || []).reduce((sum, mat) => sum + (parseFloat(mat.prezzo) || 0), 0);
                    
                    htmlContent += `
                        <h5 style="margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; font-size: 1em;">
                            Attivit√† ${attIndex + 1}: ${att.nome} 
                            <span style="float: right; color: #28a745;">(Totale: ‚Ç¨ ${costoAttivita.toFixed(2)})</span>
                        </h5>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th style="width: 75%;">Descrizione Materiale/Link</th>
                                    <th style="width: 25%;">Costo (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    (att.materiali || []).forEach(mat => {
                        htmlContent += `
                            <tr>
                                <td>${mat.descrizione}</td>
                                <td style="text-align: right;">‚Ç¨ ${parseFloat(mat.prezzo || 0).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    htmlContent += `
                            </tbody>
                        </table>
                    `;
                });
            } else {
                 htmlContent += `<p style="margin-top: 10px;">Nessuna attivit√† o materiale definito per questo Lab.</p>`;
            }

            pdfContainer.innerHTML = htmlContent;

            // 4. Genera il file PDF e 5. Popola il file
            // Si usa html2canvas per rendere l'HTML in una tela, che jsPDF converte in PDF.
            html2canvas(pdfContainer, { scale: 2 }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 200; // Larghezza A4 in mm (-10mm margini)
                const pageHeight = 295; // Altezza A4 in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                const pdf = new jsPDF('p', 'mm', 'a4');
                let position = 5; // Margine superiore

                // Se l'immagine √® troppo grande, la divido su pi√π pagine
                pdf.addImage(imgData, 'PNG', 5, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 5;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 5, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // 6. Rinomina in automatico il pdf con il nome del Lab
                const nomeFile = `SCHEDA_LAB_${labName}_${labData.dataInizio || 'Data_Sconosciuta'}.pdf`;
                
                // 7. e 8. Salva il pdf (il browser chieder√† la directory)
                pdf.save(nomeFile);
                
                // 5. Elimina il csv (Non necessario, dato che non usiamo un CSV intermedio)
                // Pulisce il contenitore nascosto dopo il salvataggio
                pdfContainer.innerHTML = '';
            });
        }
        
        // --- FUNZIONI GESTIONE ATTIVIT√Ä E MATERIALI ---

        function ricaricaListaAttivita() {
            attivitaListDiv.innerHTML = '';
            labAttivita.forEach((attivita, index) => {
                aggiungiAttivitaHTML(attivita, index);
            });
            calcolaRiepilogoFinanziario(); 
        }

        function aggiungiAttivita() {
            const nuovaAttivita = { 
                nome: 'Nuova Attivit√†', 
                materiali: [{ descrizione: 'Materiale/Link', prezzo: 0.00 }] 
            };
            labAttivita.push(nuovaAttivita);
            ricaricaListaAttivita();
        }
        
        function rimuoviAttivita(index) {
            if (confirm("Sei sicuro di voler rimuovere questa Attivit√†?")) {
                labAttivita.splice(index, 1);
                ricaricaListaAttivita();
            }
        }

        function aggiungiAttivitaHTML(attivita, attivitaIndex) {
            const div = document.createElement('div');
            div.className = 'attivita-item';
            
            let html = `
                <div class="attivita-header">
                    <div class="form-group" style="flex-grow: 1; margin-right: 15px;">
                        <label>Descrizione Attivit√†</label>
                        <input type="text" value="${attivita.nome}" placeholder="Nome/Descrizione attivit√†" 
                            onchange="aggiornaAttivitaNome(${attivitaIndex}, this.value)" required>
                    </div>
                    <button type="button" class="danger" onclick="rimuoviAttivita(${attivitaIndex})" style="height: 40px;">Rimuovi Attivit√†</button>
                </div>

                <h4>Materiali/Strumenti o Link Necessari</h4>
                <div id="materialiList${attivitaIndex}">
            `;

            (attivita.materiali || []).forEach((materiale, materialeIndex) => {
                html += aggiungiMaterialeHTML(attivitaIndex, materialeIndex, materiale.descrizione, materiale.prezzo);
            });
            
            html += `
                </div>
                
                <button type="button" class="primary" onclick="aggiungiMateriale(${attivitaIndex})" style="margin-top: 10px; padding: 5px 10px;">‚ûï Aggiungi Materiale/Link</button>
                
                <div id="costoAttivita${attivitaIndex}" class="materiale-costo">
                    Costo Attivit√†: ‚Ç¨ ${calcolaCostoAttivita(attivitaIndex)}
                </div>
            `;

            div.innerHTML = html;
            attivitaListDiv.appendChild(div);
        }

        function aggiungiMaterialeHTML(attivitaIndex, materialeIndex, descrizione = '', prezzo = 0) {
            const prezzoValue = typeof prezzo === 'number' ? prezzo.toFixed(2) : parseFloat(prezzo || 0).toFixed(2);

            return `
                <div class="materiale-row">
                    <div class="form-group">
                        <label>Descrizione Materiale o Link Web</label>
                        <textarea rows="1" style="resize: none;" placeholder="Nome materiale, strumento o URL/Link" 
                            onchange="aggiornaMateriale(${attivitaIndex}, ${materialeIndex}, 'descrizione', this.value)" 
                            required>${descrizione}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Materiale (‚Ç¨)</label>
                        <input type="number" step="0.01" min="0" value="${prezzoValue}" placeholder="Costo (‚Ç¨) - 0 per link" 
                            onchange="aggiornaMateriale(${attivitaIndex}, ${materialeIndex}, 'prezzo', parseFloat(this.value) || 0)">
                    </div>
                    <button type="button" class="danger" onclick="rimuoviMateriale(${attivitaIndex}, ${materialeIndex})">X</button>
                </div>
            `;
        }

        function aggiornaAttivitaNome(attivitaIndex, nome) {
            if (labAttivita[attivitaIndex]) {
                labAttivita[attivitaIndex].nome = nome;
            }
        }

        function aggiornaMateriale(attivitaIndex, materialeIndex, field, value) {
            if (labAttivita[attivitaIndex] && labAttivita[attivitaIndex].materiali[materialeIndex]) {
                labAttivita[attivitaIndex].materiali[materialeIndex][field] = value;
                aggiornaCostoVisualizzato(attivitaIndex);
            }
        }

        function aggiungiMateriale(attivitaIndex) {
            if (labAttivita[attivitaIndex]) {
                labAttivita[attivitaIndex].materiali.push({ descrizione: 'Nuovo Materiale/Link', prezzo: 0.00 });
                
                const materialiListDiv = document.getElementById(`materialiList${attivitaIndex}`);
                if (materialiListDiv) {
                    materialiListDiv.innerHTML = '';
                    labAttivita[attivitaIndex].materiali.forEach((materiale, materialeIndex) => {
                        materialiListDiv.innerHTML += aggiungiMaterialeHTML(attivitaIndex, materialeIndex, materiale.descrizione, materiale.prezzo);
                    });
                }
                aggiornaCostoVisualizzato(attivitaIndex);
            }
        }

        function rimuoviMateriale(attivitaIndex, materialeIndex) {
            if (confirm("Sei sicuro di voler rimuovere questo Materiale/Link?")) {
                if (labAttivita[attivitaIndex] && labAttivita[attivitaIndex].materiali) {
                    labAttivita[attivitaIndex].materiali.splice(materialeIndex, 1);
                    ricaricaListaAttivita(); 
                }
            }
        }
    </script>
</body>
</html>
