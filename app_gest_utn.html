<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Gestione Utenti</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script> 

    <link rel="stylesheet" href="main_style.css">

    <style>
        .utente-details { 
            margin-top: 20px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
        }
        .sede-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .sede-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sede-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #ddd;
        }
        .sede-list-item:last-child {
            border-bottom: none;
        }
        .sede-list-item button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    
    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">‚ò∞</span>
            <h2>Gestione Utenti</h2>
            <button class="mobile-logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="index.html" class="logo-link" onclick="toggleNav()"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="index.html" class="tab-link" onclick="toggleNav()">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="app_gest_cli.html" class="tab-link" onclick="toggleNav()">CLIENTI</a> 
            <a href="app_gest_frn.html" class="tab-link" onclick="toggleNav()">FORNITORI & SEDI</a>
            <a href="app_gest_utn.html" class="tab-link active" onclick="toggleNav()">UTENTI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="app_gest_lab.html" class="tab-link" onclick="toggleNav()">LABS & ATTIVIT√Ä</a> 
            <a href="app_gest_isc.html" class="tab-link" onclick="toggleNav()">ISCRIZIONI & PAGAMENTI</a> 
            <a href="app_gest_inv.html" class="tab-link" onclick="toggleNav()">INVENTARIO</a> 
            <a href="app_gest_log.html" class="tab-link" onclick="toggleNav()">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="app_gest_pre.html" class="tab-link" onclick="toggleNav()">PREVENTIVI</a> 
            <a href="app_gest_fat.html" class="tab-link" onclick="toggleNav()">FATTURE</a>
            <a href="app_gest_sta.html" class="tab-link" onclick="toggleNav()">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout(); toggleNav();">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            <h1>Gestione Utenti (db_utn)</h1>
            <p>Aggiungi, modifica o elimina gli account Utente e definisci il loro Ruolo e la Sede di riferimento.</p>

            <div class="data-section">
                <button class="primary" onclick="apriModaleUtente()">AGGIUNGI NUOVO UTENTE</button>
                
                <h2>Elenco Utenti</h2>
                <table id="tabellaUtenti">
                    <thead>
                        <tr>
                            <th>Nome Completo</th>
                            <th>Email (Accesso)</th>
                            <th>Ruolo</th>
                            <th>Sede di Riferimento</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tabellaUtentiBody">
                        <tr><td colspan="5" style="text-align: center;">Caricamento utenti...</td></tr>
                    </tbody>
                </table>
            </div>
            
        </main>
    </div>

    <div id="modaleUtente" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModaleUtente()">&times;</span>
            <h2 id="modalTitleUtente">Aggiungi Utente</h2>
            
            <form id="utenteForm">
                <input type="hidden" id="utenteId">
                
                <h3>Dati Anagrafici (db_utn)</h3>
                
                <div class="form-group">
                    <label for="nome">Nome *</label>
                    <input type="text" id="nome" required>
                </div>
                <div class="form-group">
                    <label for="cognome">Cognome *</label>
                    <input type="text" id="cognome" required>
                </div>
                
                <div class="form-group">
                    <label for="emailUtn">Email (Accesso) *</label>
                    <input type="email" id="emailUtn" required>
                </div>
                
                <div class="form-group">
                    <label for="passwordUtn">Password (solo in creazione) *</label>
                    <input type="password" id="passwordUtn">
                    <small style="color: red; display: none;" id="passwordWarning">Lascia vuoto per non modificare la password esistente.</small>
                </div>
                
                <div class="form-group">
                    <label for="ruoloUtn">Ruolo *</label>
                    <select id="ruoloUtn" required>
                        <option value="Admin">Admin</option>
                        <option value="Manager">Manager</option>
                        <option value="Operativo">Operativo</option>
                        <option value="Visualizzatore">Visualizzatore</option>
                    </select>
                </div>
                
                <div class="utente-details">
                    <h3>Sede di Riferimento (db_utn_sed)</h3>
                    
                    <div class="sede-header">
                        <h4>Sede Assegnata</h4>
                        <button type="button" class="secondary" onclick="apriModaleSede()">Assegna/Modifica Sede</button>
                    </div>
                    
                    <div class="sede-container">
                        <div id="dettagliSedeUtente">
                            <p style="text-align: center; margin: 5px;">Nessuna sede di riferimento assegnata.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="danger" onclick="eliminaUtente(document.getElementById('utenteId').value)" id="eliminaUtenteButton" style="display: none;">Elimina Utente</button>
                    <button type="submit" class="secondary">Salva Utente</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modaleSede" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModaleSede()">&times;</span>
            <h2 id="modalTitleSede">Assegna Sede di Riferimento</h2>
            
            <form id="sedeForm">
                <input type="hidden" id="sedeIdUtente">
                
                <h3>Dati Sede (db_utn_sed)</h3>
                <p>Questi dati rappresentano la sede principale in cui lavora l'utente o il suo indirizzo di riferimento.</p>

                <div class="form-group">
                    <label for="tipoIndirizzo">Tipo Indirizzo</label>
                    <select id="tipoIndirizzo">
                        <option value="Lavoro Principale">Lavoro Principale</option>
                        <option value="Domicilio">Domicilio</option>
                        <option value="Sede Commerciale">Sede Commerciale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="indirizzoSedeUtn">Indirizzo *</label>
                    <input type="text" id="indirizzoSedeUtn" required>
                </div>
                
                <div class="form-group">
                    <label for="cittaSedeUtn">Citt√† *</label>
                    <input type="text" id="cittaSedeUtn" required>
                </div>
                
                <div class="form-group">
                    <label for="capSedeUtn">CAP</label>
                    <input type="text" id="capSedeUtn">
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="secondary">Salva Sede</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =========================================================
        // 1. CONFIGURAZIONE E INIZIALIZZAZIONE
        // =========================================================

        const firebaseConfig = {
            // ‚ö†Ô∏è INSERISCI QUI LE TUE CREDENZIALI ‚ö†Ô∏è
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY", 
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // Riferimenti alle Collezioni (NOMENCLATURA CORRETTA: db_utn e db_utn_sed)
        const colUtenti = db.collection('db_utn'); 
        const colSediUtn = db.collection('db_utn_sed'); 
        
        // Variabili di Stato
        let utenteIdCorrente = null; 
        let sedeIdCorrente = null;
        let sedeUtenteCache = {}; // Cache per le sedi utente
        let currentUserId = null; // üîë UID dell'utente LOGGATO per la protezione

        // =========================================================
        // 2. FUNZIONI UTILITY E NAVIGAZIONE
        // =========================================================

        /**
         * Funzione per aprire/chiudere il menu di navigazione su mobile.
         */
        function toggleNav() {
            document.getElementById('dashboardNav').classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = 'app_login.html'; 
            });
        }

        // =========================================================
        // 3. GESTIONE UTENTE (CRUD su db_utn)
        // =========================================================

        /**
         * Apre la modale per l'aggiunta o la modifica di un utente.
         */
        function apriModaleUtente(utenteData = {}) {
            utenteIdCorrente = utenteData.id || null;
            const isEdit = !!utenteIdCorrente;
            
            document.getElementById('modalTitleUtente').textContent = isEdit ? 'Modifica Utente' : 'Aggiungi Nuovo Utente';
            document.getElementById('utenteId').value = utenteIdCorrente || '';
            document.getElementById('utenteForm').reset();
            
            // Logica di Sicurezza per il pulsante Elimina nella modale:
            const isCurrentUser = utenteData.idFirebase === currentUserId;
            
            if (isEdit && !isCurrentUser) {
                document.getElementById('eliminaUtenteButton').style.display = 'inline-block';
                document.getElementById('eliminaUtenteButton').disabled = false;
            } else {
                document.getElementById('eliminaUtenteButton').style.display = 'none';
                // Se visibile, lo disabilita se √® l'utente corrente
                if (isCurrentUser) document.getElementById('eliminaUtenteButton').disabled = true;
            }
            
            document.getElementById('passwordWarning').style.display = isEdit ? 'inline-block' : 'none';
            document.getElementById('passwordUtn').required = !isEdit; // Password richiesta solo in creazione
            
            // Popola la modale Utente
            if (isEdit) {
                document.getElementById('nome').value = utenteData.nome || '';
                document.getElementById('cognome').value = utenteData.cognome || '';
                document.getElementById('emailUtn').value = utenteData.email || '';
                document.getElementById('ruoloUtn').value = utenteData.ruolo || 'Operativo';
                
                document.getElementById('passwordUtn').value = ''; 
                
                sedeIdCorrente = utenteData.idSedeRiferimento || null;
                visualizzaSedeAssegnata(utenteData.idSedeRiferimento);

            } else {
                sedeIdCorrente = null;
                document.getElementById('dettagliSedeUtente').innerHTML = '<p style="text-align: center; margin: 5px;">Nessuna sede di riferimento assegnata.</p>';
            }
            
            document.getElementById('modaleUtente').style.display = 'block';
        }

        function chiudiModaleUtente() {
            document.getElementById('modaleUtente').style.display = 'none';
            document.getElementById('utenteForm').reset();
            utenteIdCorrente = null;
            sedeIdCorrente = null;
        }

        document.getElementById('utenteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaUtente();
        });

        async function salvaUtente() {
            const id = document.getElementById('utenteId').value;
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const email = document.getElementById('emailUtn').value.trim();
            const password = document.getElementById('passwordUtn').value.trim();
            const ruolo = document.getElementById('ruoloUtn').value;
            
            if (!nome || !cognome || !email || !ruolo) {
                alert("Nome, Cognome, Email e Ruolo sono campi obbligatori.");
                return;
            }

            const utenteData = {
                nome: nome,
                cognome: cognome,
                email: email,
                ruolo: ruolo,
                idSedeRiferimento: sedeIdCorrente || null, 
                dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    // AGGIORNAMENTO
                    await colUtenti.doc(id).update(utenteData);
                    
                    if (password) {
                        alert("‚ö†Ô∏è Attenzione: L'aggiornamento della password deve essere gestito tramite Cloud Functions per ragioni di sicurezza.");
                    }

                } else {
                    // CREAZIONE
                    if (!password) {
                         alert("Inserire una password per il nuovo utente.");
                         return;
                    }

                    // Creazione in Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;

                    // Salvataggio dati anagrafici in Firestore (db_utn)
                    utenteData.idFirebase = uid; // üîë SALVATAGGIO DELL'UID PER LA SICUREZZA
                    utenteData.dataCreazione = firebase.firestore.FieldValue.serverTimestamp();
                    await colUtenti.add(utenteData);
                }

                alert(`Utente ${id ? 'aggiornato' : 'aggiunto'} con successo!`);
                chiudiModaleUtente();
                caricaUtenti(); 

            } catch (error) {
                console.error("üî¥ Errore nel salvataggio/aggiornamento Utente:", error);
                
                let errorMessage = "Errore critico: Impossibile salvare l'utente.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "L'email fornita √® gi√† in uso da un altro account.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "La password deve contenere almeno 6 caratteri.";
                }
                alert(errorMessage + " Controlla la console per i dettagli.");
            }
        }

        async function eliminaUtente(id) {
            if (!id) return;
            
            // üö´ SICUREZZA: Doppia verifica prima dell'eliminazione
            const utenteDoc = await colUtenti.doc(id).get();
            const utenteData = utenteDoc.data();
            if (utenteData.idFirebase === currentUserId) {
                alert("ERRORE DI SICUREZZA: Non puoi eliminare l'utente attualmente loggato. Utilizza la console di Firebase Auth per l'eliminazione manuale dell'Admin.");
                return;
            }
            
            if (confirm("Sei sicuro di voler eliminare questo Utente? Verranno eliminati solo i suoi dati anagrafici e la sede in Firestore. L'account di accesso in Firebase Auth RIMARR√Ä ATTIVO (richiede Cloud Functions per la cancellazione completa).")) {
                try {
                    // 1. Eliminazione Sede (db_utn_sed)
                    const idSede = utenteData.idSedeRiferimento;
                    if (idSede) {
                        await colSediUtn.doc(idSede).delete();
                    }
                    
                    // 2. Eliminazione Utente da Firestore (db_utn)
                    await colUtenti.doc(id).delete();
                    
                    alert("Utente (dati e sede) eliminato con successo da Firestore. L'account di accesso (Firebase Auth) √® RIMASTO ATTIVO per ragioni di sicurezza e deve essere gestito tramite Cloud Functions o manualmente.");
                    
                    caricaUtenti();
                    chiudiModaleUtente();
                } catch(e) {
                    console.error("üî¥ Errore eliminazione Utente:", e);
                    alert("Errore durante l'eliminazione dell'Utente.");
                }
            }
        }


        // =========================================================
        // 4. GESTIONE SEDE UTENTE (CRUD su db_utn_sed)
        // =========================================================
        // [... LE FUNZIONI DELLA SEDE RIMANGONO INVARIATE PER BREVIT√Ä E CHIAREZZA ... ]
        // (La logica interna della sede √® corretta e punta a db_utn_sed)
        
        async function apriModaleSede() {
            if (!utenteIdCorrente) {
                alert("Devi prima salvare l'utente per potergli assegnare una sede.");
                return;
            }

            document.getElementById('modalTitleSede').textContent = sedeIdCorrente ? 'Modifica Sede' : 'Assegna Sede';
            document.getElementById('sedeIdUtente').value = sedeIdCorrente || '';
            document.getElementById('sedeForm').reset();
            
            if (sedeIdCorrente) {
                const sedeData = sedeUtenteCache[sedeIdCorrente];
                if (sedeData) {
                    document.getElementById('tipoIndirizzo').value = sedeData.tipo || 'Lavoro Principale';
                    document.getElementById('indirizzoSedeUtn').value = sedeData.indirizzo || '';
                    document.getElementById('cittaSedeUtn').value = sedeData.citta || '';
                    document.getElementById('capSedeUtn').value = sedeData.cap || '';
                }
            } 
            
            document.getElementById('modaleSede').style.display = 'block';
        }

        function chiudiModaleSede() {
            document.getElementById('modaleSede').style.display = 'none';
            document.getElementById('sedeForm').reset();
        }

        document.getElementById('sedeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaSedeUtente();
        });

        async function salvaSedeUtente() {
            const tipo = document.getElementById('tipoIndirizzo').value;
            const indirizzo = document.getElementById('indirizzoSedeUtn').value.trim();
            const citta = document.getElementById('cittaSedeUtn').value.trim();
            const cap = document.getElementById('capSedeUtn').value.trim();

            if (!indirizzo || !citta) {
                alert("Indirizzo e Citt√† sono campi obbligatori.");
                return;
            }

            const sedeData = {
                idUtente: utenteIdCorrente, // Riferimento all'utente padre
                tipo: tipo,
                indirizzo: indirizzo,
                citta: citta,
                cap: cap,
                dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                let idSede = sedeIdCorrente;

                if (idSede) {
                    // Aggiornamento Sede (db_utn_sed)
                    await colSediUtn.doc(idSede).update(sedeData);
                } else {
                    // Creazione Nuova Sede (db_utn_sed)
                    sedeData.dataCreazione = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await colSediUtn.add(sedeData);
                    idSede = docRef.id;
                }
                
                // Aggiorna il riferimento in db_utn
                await colUtenti.doc(utenteIdCorrente).update({
                    idSedeRiferimento: idSede,
                    dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                sedeIdCorrente = idSede;
                sedeUtenteCache[idSede] = { id: idSede, ...sedeData };
                visualizzaSedeAssegnata(idSede); 

                alert(`Sede di riferimento ${sedeIdCorrente ? 'aggiornata' : 'assegnata'} con successo!`);
                chiudiModaleSede();
                caricaUtenti(); 

            } catch (error) {
                console.error("üî¥ Errore nel salvataggio/aggiornamento della Sede Utente:", error);
                alert("Errore critico: Impossibile salvare la Sede. Controlla la console.");
            }
        }
        
        function visualizzaSedeAssegnata(idSede) {
            const div = document.getElementById('dettagliSedeUtente');
            if (idSede && sedeUtenteCache[idSede]) {
                const sede = sedeUtenteCache[idSede];
                div.innerHTML = `
                    <div class="sede-list-item">
                        <span>**${sede.tipo}**: ${sede.indirizzo}, ${sede.citta} (${sede.cap || 'N/D'})</span>
                        <button class="danger secondary" onclick="disassegnaSede('${idSede}')">Rimuovi</button>
                    </div>
                `;
            } else {
                div.innerHTML = '<p style="text-align: center; margin: 5px;">Nessuna sede di riferimento assegnata.</p>';
            }
        }
        
        async function disassegnaSede(idSede) {
            if (confirm("Sei sicuro di voler rimuovere il riferimento a questa Sede? (La sede rimarr√† in db_utn_sed finch√© non verr√† eliminata manualmente).")) {
                try {
                    await colUtenti.doc(utenteIdCorrente).update({
                        idSedeRiferimento: null,
                        dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    sedeIdCorrente = null;
                    visualizzaSedeAssegnata(null); 
                    caricaUtenti(); 
                    
                    alert("Riferimento Sede rimosso con successo dall'utente.");
                } catch (e) {
                    console.error("üî¥ Errore nella disassegnazione della Sede:", e);
                    alert("Errore durante la rimozione del riferimento alla Sede.");
                }
            }
        }


        // =========================================================
        // 5. CARICAMENTO DATI
        // =========================================================
        
        /**
         * Carica tutti gli utenti e le loro sedi, applicando la logica di sicurezza.
         */
        function caricaUtenti() {
            const body = document.getElementById('tabellaUtentiBody');
            body.innerHTML = '<tr><td colspan="5" style="text-align: center;">Caricamento utenti in corso...</td></tr>';

            // 1. Caricamento Cache Sedi
            colSediUtn.get().then(sediSnapshot => {
                sedeUtenteCache = {};
                sediSnapshot.forEach(doc => {
                    sedeUtenteCache[doc.id] = { id: doc.id, ...doc.data() };
                });

                // 2. Caricamento Utenti
                colUtenti.onSnapshot(utenteSnapshot => {
                    const utenti = utenteSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    body.innerHTML = ''; 

                    if (utenteSnapshot.empty) {
                        body.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nessun utente registrato.</td></tr>';
                        return;
                    }

                    utenti.forEach(utente => {
                        const row = body.insertRow();
                        
                        const sede = sedeUtenteCache[utente.idSedeRiferimento] || {};
                        const sedeDisplay = sede.citta ? `${sede.tipo} - ${sede.citta} (${sede.cap})` : 'Nessuna';
                        
                        // üîë CONTROLLO SICUREZZA: L'utente √® quello loggato?
                        const isCurrentUser = utente.idFirebase === currentUserId;
                        
                        const utnJson = JSON.stringify(utente).replace(/"/g, '&quot;');

                        // Colonna Nome Completo
                        row.insertCell().setAttribute('data-label', 'Nome Completo');
                        row.cells[0].textContent = `${utente.nome || ''} ${utente.cognome || ''}`;
                        
                        // Colonna Email
                        row.insertCell().setAttribute('data-label', 'Email (Accesso)');
                        row.cells[1].textContent = utente.email;
                        
                        // Colonna Ruolo
                        row.insertCell().setAttribute('data-label', 'Ruolo');
                        row.cells[2].textContent = utente.ruolo || 'N/D';
                        
                        // Colonna Sede di Riferimento
                        row.insertCell().setAttribute('data-label', 'Sede di Riferimento');
                        row.cells[3].textContent = sedeDisplay;
                        
                        // Colonna Azioni - LOGICA DI SICUREZZA
                        const actionsCell = row.insertCell();
                        actionsCell.setAttribute('data-label', 'Azioni'); 
                        
                        let deleteButtonHtml = '';
                        if (isCurrentUser) {
                            deleteButtonHtml = `<button class="danger" disabled title="Non puoi eliminare l'account in uso.">Elimina</button>`;
                            // L'utente corrente non pu√≤ essere modificato (per evitare che si tolga il ruolo Admin)
                            actionsCell.innerHTML = `<button class="secondary" disabled title="Modifica disabilitata per l'utente corrente.">Modifica</button>` + deleteButtonHtml;
                        } else {
                            deleteButtonHtml = `<button class="danger" onclick="eliminaUtente('${utente.id}')">Elimina</button>`;
                            actionsCell.innerHTML = `<button class="secondary" onclick="apriModaleUtente(${utnJson})">Modifica</button>` + deleteButtonHtml;
                        }
                    });

                }, error => {
                    console.error("üî¥ Errore nel fetch degli Utenti:", error);
                    body.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Errore nel caricamento degli Utenti.</td></tr>';
                });

            }).catch(error => {
                console.error("üî¥ Errore nel fetch delle Sedi Utente (Cache):", error);
            });
        }


        // =========================================================
        // 6. INIZIALIZZAZIONE (CONTROLLO AUTENTICAZIONE)
        // =========================================================

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid; // üîë SALVA L'UID dell'utente loggato
                document.getElementById('dashboardContainer').style.display = 'flex';
                caricaUtenti();
            } else {
                window.location.href = 'app_login.html';
            }
        });
    </script>
</body>
</html>