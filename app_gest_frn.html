<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Gestione Fornitori e Sedi</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <link rel="stylesheet" href="main_style.css">

    <style>
        .fornitore-details { 
            margin-top: 20px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
        }
        .sede-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .sede-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sede-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #ddd;
        }
        .sede-list-item:last-child {
            border-bottom: none;
        }
        .sede-list-item button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    
    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">☰</span>
            <h2>Gestione Fornitori</h2>
            <button class="mobile-logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="index.html" class="logo-link" onclick="toggleNav()"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="index.html" class="tab-link" onclick="toggleNav()">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="app_gest_cli.html" class="tab-link" onclick="toggleNav()">CLIENTI</a> 
            <a href="app_gest_frn.html" class="tab-link active" onclick="toggleNav()">FORNITORI & SEDI</a> <a href="app_gest_utn.html" class="tab-link" onclick="toggleNav()">UTENTI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="app_gest_lab.html" class="tab-link" onclick="toggleNav()">LABS & ATTIVITÀ</a> 
            <a href="app_gest_isc.html" class="tab-link" onclick="toggleNav()">ISCRIZIONI & PAGAMENTI</a> 
            <a href="app_gest_inv.html" class="tab-link" onclick="toggleNav()">INVENTARIO</a> 
            <a href="app_gest_log.html" class="tab-link" onclick="toggleNav()">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="app_gest_pre.html" class="tab-link" onclick="toggleNav()">PREVENTIVI</a> 
            <a href="app_gest_fat.html" class="tab-link" onclick="toggleNav()">FATTURE</a>
            <a href="app_gest_sta.html" class="tab-link" onclick="toggleNav()">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout(); toggleNav();">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            <h1>Gestione Fornitori e Sedi (db_frn, db_sedefrn)</h1>
            <p>Aggiungi, modifica o elimina le anagrafiche complete dei fornitori e le loro sedi operative.</p>

            <div class="data-section">
                <button class="primary" onclick="apriModaleFornitore()">AGGIUNGI NUOVO FORNITORE</button>
                
                <h2>Elenco Fornitori</h2>
                <table id="tabellaFornitori">
                    <thead>
                        <tr>
                            <th>Ragione Sociale</th>
                            <th>P.IVA/C.F.</th>
                            <th>Email</th>
                            <th>Sedi Registrate</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tabellaFornitoriBody">
                        <tr><td colspan="5" style="text-align: center;">Caricamento fornitori...</td></tr>
                    </tbody>
                </table>
            </div>
            
        </main>
    </div>

    <div id="modaleFornitore" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModaleFornitore()">&times;</span>
            <h2 id="modalTitleFornitore">Aggiungi Fornitore</h2>
            
            <form id="fornitoreForm">
                <input type="hidden" id="fornitoreId">
                
                <h3>Dati Anagrafici (db_frn)</h3>
                <div class="form-group">
                    <label for="ragioneSocialeFrn">Ragione Sociale *</label>
                    <input type="text" id="ragioneSocialeFrn" required>
                </div>
                
                <div class="form-group">
                    <label for="pivaCfFrn">P.IVA / Codice Fiscale *</label>
                    <input type="text" id="pivaCfFrn" required>
                </div>
                
                <div class="form-group">
                    <label for="emailFrn">Email Principale</label>
                    <input type="email" id="emailFrn">
                </div>
                
                <div class="form-group">
                    <label for="telefonoFrn">Telefono</label>
                    <input type="text" id="telefonoFrn">
                </div>
                
                <div class="fornitore-details" id="fornitoreSediSection" style="display: none;">
                    <h3>Gestione Sedi Associate (db_sedefrn)</h3>
                    <div class="sede-header">
                        <h4>Elenco Sedi</h4>
                        <button type="button" class="secondary" onclick="apriModaleSede()">+ Aggiungi Sede</button>
                    </div>
                    
                    <div class="sede-container">
                        <div id="listaSediFornitore">
                            <p style="text-align: center; margin: 5px;">Nessuna sede collegata.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="danger" onclick="eliminaFornitore(document.getElementById('fornitoreId').value)" id="eliminaFornitoreButton" style="display: none;">Elimina Fornitore</button>
                    <button type="submit" class="secondary">Salva Fornitore</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modaleSede" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModaleSede()">&times;</span>
            <h2 id="modalTitleSede">Aggiungi Sede</h2>
            
            <form id="sedeForm">
                <input type="hidden" id="sedeId">
                <input type="hidden" id="idFornitorePadre">
                
                <h3>Dati Sede (db_sedefrn)</h3>
                <div class="form-group">
                    <label for="tipoSede">Tipo Sede</label>
                    <select id="tipoSede">
                        <option value="Sede Legale">Sede Legale</option>
                        <option value="Sede Operativa">Sede Operativa</option>
                        <option value="Sede Commerciale">Sede Commerciale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="indirizzoSede">Indirizzo *</label>
                    <input type="text" id="indirizzoSede" required>
                </div>
                
                <div class="form-group">
                    <label for="cittaSede">Città *</label>
                    <input type="text" id="cittaSede" required>
                </div>
                
                <div class="form-group">
                    <label for="capSede">CAP</label>
                    <input type="text" id="capSede">
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="secondary">Salva Sede</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =========================================================
        // 1. CONFIGURAZIONE E INIZIALIZZAZIONE
        // =========================================================

        const firebaseConfig = {
            // ⚠️ INSERISCI QUI LE TUE CREDENZIALI ⚠️
            apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY", 
            authDomain: "epapp-bb953.firebaseapp.com",
            projectId: "epapp-bb953",
            storageBucket: "epapp-bb953.firebasestorage.app",
            messagingSenderId: "797675959163",
            appId: "1:797675959163:web:30c077ce253990239d03de",
            measurementId: "G-RN2896V58E"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // Riferimenti alle Collezioni
        const colFornitori = db.collection('db_frn');
        const colSediFrn = db.collection('db_sedefrn'); 

        let fornitoreIdCorrente = null; 
        let sedeIdInModifica = null;

        // =========================================================
        // 2. FUNZIONI UTILITY
        // =========================================================

        /**
         * Funzione per aprire/chiudere il menu di navigazione su mobile.
         */
        function toggleNav() {
            document.getElementById('dashboardNav').classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = 'app_login.html'; 
            });
        }

        // =========================================================
        // 3. GESTIONE FORNITORE (CRUD su db_frn)
        // =========================================================

        /**
         * Apre la modale per l'aggiunta o la modifica di un fornitore.
         */
        function apriModaleFornitore(fornitoreData = {}) {
            fornitoreIdCorrente = fornitoreData.id || null;
            const isEdit = !!fornitoreIdCorrente;
            
            document.getElementById('modalTitleFornitore').textContent = isEdit ? 'Modifica Fornitore' : 'Aggiungi Nuovo Fornitore';
            document.getElementById('fornitoreId').value = fornitoreIdCorrente || '';
            document.getElementById('fornitoreForm').reset();
            
            document.getElementById('eliminaFornitoreButton').style.display = isEdit ? 'inline-block' : 'none';

            if (isEdit) {
                document.getElementById('ragioneSocialeFrn').value = fornitoreData.ragioneSociale || '';
                document.getElementById('pivaCfFrn').value = fornitoreData.pivaCf || '';
                document.getElementById('emailFrn').value = fornitoreData.email || '';
                document.getElementById('telefonoFrn').value = fornitoreData.telefono || '';

                // Mostra la sezione sedi solo in modifica
                document.getElementById('fornitoreSediSection').style.display = 'block';
                caricaSediPerFornitore(fornitoreIdCorrente);
            } else {
                // Nasconde la sezione sedi in creazione
                document.getElementById('fornitoreSediSection').style.display = 'none';
            }
            
            document.getElementById('modaleFornitore').style.display = 'block';
        }

        function chiudiModaleFornitore() {
            document.getElementById('modaleFornitore').style.display = 'none';
            document.getElementById('fornitoreForm').reset();
            fornitoreIdCorrente = null;
        }

        document.getElementById('fornitoreForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaFornitore();
        });

        async function salvaFornitore() {
            const id = document.getElementById('fornitoreId').value;
            const ragioneSociale = document.getElementById('ragioneSocialeFrn').value.trim();
            const pivaCf = document.getElementById('pivaCfFrn').value.trim();
            const email = document.getElementById('emailFrn').value.trim();
            const telefono = document.getElementById('telefonoFrn').value.trim();
            
            if (!ragioneSociale || !pivaCf) {
                alert("Ragione Sociale e P.IVA/C.F. sono campi obbligatori.");
                return;
            }

            const fornitoreData = {
                ragioneSociale: ragioneSociale,
                pivaCf: pivaCf,
                email: email,
                telefono: telefono,
                dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await colFornitori.doc(id).update(fornitoreData);
                } else {
                    fornitoreData.dataCreazione = firebase.firestore.FieldValue.serverTimestamp();
                    await colFornitori.add(fornitoreData);
                }

                alert(`Fornitore ${id ? 'aggiornato' : 'aggiunto'} con successo!`);
                chiudiModaleFornitore();
                caricaFornitori(); // Ricarica la tabella principale
            } catch (error) {
                console.error("🔴 Errore nel salvataggio/aggiornamento del Fornitore:", error);
                alert("Errore critico: Impossibile salvare il Fornitore. Controlla la console.");
            }
        }

        async function eliminaFornitore(id) {
            if (confirm("Sei sicuro di voler eliminare questo Fornitore? Saranno eliminate anche tutte le SEDI collegate (db_sedefrn)!")) {
                try {
                    // 1. Elimina le Sedi collegate (Integrità Referenziale)
                    const sediDaEliminare = await colSediFrn.where('idFornitore', '==', id).get();
                    const deleteSediPromises = sediDaEliminare.docs.map(doc => colSediFrn.doc(doc.id).delete());
                    await Promise.all(deleteSediPromises);
                    
                    // 2. Elimina il Fornitore
                    await colFornitori.doc(id).delete();

                    alert("Fornitore e sedi associate eliminate con successo.");
                    caricaFornitori();
                } catch(e) {
                    console.error("🔴 Errore eliminazione Fornitore:", e);
                    alert("Errore durante l'eliminazione del Fornitore e/o delle sedi.");
                }
            }
        }


        // =========================================================
        // 4. GESTIONE SEDI (CRUD su db_sedefrn)
        // =========================================================

        function apriModaleSede(sedeData = {}) {
            if (!fornitoreIdCorrente) {
                alert("Devi prima salvare il Fornitore per aggiungere una sede.");
                return;
            }
            
            sedeIdInModifica = sedeData.id || null;
            document.getElementById('modalTitleSede').textContent = sedeIdInModifica ? 'Modifica Sede' : 'Aggiungi Nuova Sede';
            document.getElementById('sedeId').value = sedeIdInModifica || '';
            document.getElementById('idFornitorePadre').value = fornitoreIdCorrente; 
            document.getElementById('sedeForm').reset();
            
            if (sedeIdInModifica) {
                document.getElementById('tipoSede').value = sedeData.tipo || 'Sede Operativa';
                document.getElementById('indirizzoSede').value = sedeData.indirizzo || '';
                document.getElementById('cittaSede').value = sedeData.citta || '';
                document.getElementById('capSede').value = sedeData.cap || '';
            } 
            document.getElementById('modaleSede').style.display = 'block';
        }

        function chiudiModaleSede() {
            document.getElementById('modaleSede').style.display = 'none';
            document.getElementById('sedeForm').reset();
            sedeIdInModifica = null;
        }

        document.getElementById('sedeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaSede();
        });

        async function salvaSede() {
            const idFornitore = document.getElementById('idFornitorePadre').value;
            const tipo = document.getElementById('tipoSede').value;
            const indirizzo = document.getElementById('indirizzoSede').value.trim();
            const citta = document.getElementById('cittaSede').value.trim();
            const cap = document.getElementById('capSede').value.trim();

            if (!idFornitore || !indirizzo || !citta) {
                alert("Indirizzo e Città sono campi obbligatori.");
                return;
            }

            const sedeData = {
                idFornitore: idFornitore,
                tipo: tipo,
                indirizzo: indirizzo,
                citta: citta,
                cap: cap,
                dataUltimaModifica: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (sedeIdInModifica) {
                    await colSediFrn.doc(sedeIdInModifica).update(sedeData);
                } else {
                    sedeData.dataCreazione = firebase.firestore.FieldValue.serverTimestamp();
                    await colSediFrn.add(sedeData);
                }

                alert(`Sede ${sedeIdInModifica ? 'aggiornata' : 'aggiunta'} con successo!`);
                chiudiModaleSede();
                caricaSediPerFornitore(idFornitore); // Aggiorna la lista sedi nella modale Fornitore
                caricaFornitori(); // Aggiorna il conteggio nella tabella principale
            } catch (error) {
                console.error("🔴 Errore nel salvataggio/aggiornamento della Sede:", error);
                alert("Errore critico: Impossibile salvare la Sede. Controlla la console.");
            }
        }

        function caricaSediPerFornitore(idFornitore) {
            const lista = document.getElementById('listaSediFornitore');
            lista.innerHTML = '<p style="text-align: center; margin: 5px;">Caricamento sedi...</p>';
            
            // Ascoltatore per le sedi relative al Fornitore corrente
            colSediFrn.where('idFornitore', '==', idFornitore).onSnapshot(snapshot => {
                lista.innerHTML = '';
                if (snapshot.empty) {
                    lista.innerHTML = '<p style="text-align: center; margin: 5px;">Nessuna sede collegata.</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const sede = { id: doc.id, ...doc.data() };
                    const sedeJson = JSON.stringify(sede).replace(/"/g, '&quot;');
                    
                    const item = document.createElement('div');
                    item.className = 'sede-list-item';
                    item.innerHTML = `
                        <span>${sede.tipo}: ${sede.indirizzo}, ${sede.citta} (${sede.cap || 'N/D'})</span>
                        <div>
                            <button class="secondary" onclick="apriModaleSede(${sedeJson})">Modifica</button>
                            <button class="danger" onclick="eliminaSede('${sede.id}', '${idFornitore}')">Elimina</button>
                        </div>
                    `;
                    lista.appendChild(item);
                });
            }, error => {
                console.error("🔴 Errore nel fetch delle Sedi:", error);
                lista.innerHTML = '<p style="text-
