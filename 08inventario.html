<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPApp - Inventario e Magazzino</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* [Stili CSS base identici agli altri files] */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .dashboard-nav { width: 250px; background-color: #343a40; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .logo-link { width: 100%; text-align: center; margin-bottom: 30px; }
        .logo-link img { max-width: 80%; height: auto; border-radius: 5px; cursor: pointer; } 
        .dashboard-nav small { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; align-self: flex-start; margin-left: 20px; margin-top: 15px; color: #909090; }
        .dashboard-nav hr { width: 85%; border: 0; border-top: 1px solid #495057; margin: 5px 0 10px 0; }
        .dashboard-nav a { color: #ccc; text-decoration: none; padding: 12px 15px; margin: 3px 0; display: block; width: 85%; text-align: left; border-radius: 4px; transition: background-color 0.3s, padding-left 0.3s; }
        .dashboard-nav a:hover, .dashboard-nav a.active { background-color: #A5DD2E; color: #343a40; font-weight: bold; padding-left: 20px; }
        .dashboard-content { flex-grow: 1; padding: 30px; }
        .data-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .mobile-header { display: none; }
        .add-button-container { text-align: right; margin-bottom: 20px; }
        button.primary { background-color: #A5DD2E; color: #343a40; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-left: 10px; }
        button.danger { background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 950px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        .data-table th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .data-table tr.row:hover { background-color: #f1f1f1; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 95%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* Griglia Modale */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Stile specifico per l'allerta inventario */
        .scorta-bassa { background-color: #f8d7da !important; color: #721c24; font-weight: bold; }
        .scorta-sufficiente { background-color: #d4edda !important; color: #155724; }
        #codiceArticolo { background-color: #f0f0f0; }

        @media (max-width: 768px) {
            .dashboard-container { display: block; } .dashboard-content { padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500; }
            .mobile-header h2 { margin: 0; font-size: 1.2em; color: #343a40; }
            .hamburger-icon { font-size: 24px; cursor: pointer; color: #343a40; }
            .dashboard-nav { position: fixed; top: 0; left: -250px; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .dashboard-nav.open { left: 0; } .form-grid, .form-grid-4 { grid-template-columns: 1fr; }
            .modal-content { margin: 10% 5%; width: 90%; max-width: 90%; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        
        <div class="mobile-header">
            <span class="hamburger-icon" onclick="toggleNav()">‚ò∞</span>
            <h2>Inventario</h2>
            <a href="#" onclick="handleLogout()" style="text-decoration: none; color: #ff9999; font-weight: bold; font-size: 0.9em;">LOGOUT</a>
        </div>

        <nav class="dashboard-nav" id="dashboardNav">
            <a href="00index.html" class="logo-link"><img src="lemon_logo.png" alt="EPApp Logo"></a>
            
            <small>Dashboard</small><hr>
            <a href="00index.html" class="tab-link">DASHBOARD</a> 

            <small>Anagrafiche</small><hr>
            <a href="01clienti.html" class="tab-link">CLIENTI & ISCRIZIONI</a> 
            <a href="02fornitori.html" class="tab-link">FORNITORI & SEDI</a> 
            
            <small>Labs & Logistica</small><hr>
            <a href="03labs.html" class="tab-link">LABS & ATTIVIT√Ä</a> 
            <a href="07iscrizioni.html" class="tab-link">ISCRIZIONI & PAGAMENTI</a> 
            <a href="08inventario.html" class="tab-link active">INVENTARIO</a> 
            <a href="04logistica.html" class="tab-link">LOGISTICA</a> 
            
            <small>Finanza & Analisi</small><hr>
            <a href="05preventivi.html" class="tab-link">PREVENTIVI & FATTURE</a> 
            <a href="06stats.html" class="tab-link">STATISTICHE & KPI</a> 

            <a href="#" id="logoutLink" onclick="handleLogout()" style="color: #ff9999; margin-top: auto; font-weight: bold; display: block;">LOGOUT</a>
        </nav>

        <main class="dashboard-content">
            
            <h1>Inventario e Gestione Magazzino</h1>

            <div class="data-section">
                <div class="add-button-container">
                    <button class="primary" onclick="apriModaleArticolo(null)">‚ûï Aggiungi Articolo</button>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Codice Interno</th>
                                <th>Nome Articolo</th>
                                <th>SKU/Codice Fornitore</th>
                                <th>Categoria</th>
                                <th>Quantit√† (Disp.)</th>
                                <th>Quantit√† (Minima)</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaInventarioBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="articoloModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="chiudiModaleArticolo()">&times;</span>
            <h2 id="articoloModalTitle">Aggiungi Nuovo Articolo</h2>
            <form id="articoloForm">
                <input type="hidden" id="articoloId" value="">

                <div class="form-grid">
                    <div class="form-group">
                        <label for="nomeArticolo">Nome Articolo / Materiale</label>
                        <input type="text" id="nomeArticolo" required onchange="if(document.getElementById('articoloId').value === '') generaCodiceParlante()">
                    </div>
                    <div class="form-group">
                        <label for="codiceArticolo">Codice Interno (Parlante)</label>
                        <input type="text" id="codiceArticolo" readonly title="Generato automaticamente al salvataggio. Clicca per modificare se vuoto." onfocus="if(document.getElementById('articoloId').value === '' && this.value === '') generaCodiceParlante(true)">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoria">Categoria</label>
                        <select id="categoria" required onchange="if(document.getElementById('articoloId').value === '') generaCodiceParlante()">
                            <option value="matp">Materie prime</option>
                            <option value="canc">Cancelleria</option>
                            <option value="uten">Utensili e Accessori</option>
                            <option value="beni">Beni strumentali</option>
                            <option value="gioc">Giocattoli</option>
                            <option value="alle">Allestimenti</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="codiceSKU">SKU / Codice Fornitore/Produttore</label>
                        <input type="text" id="codiceSKU" placeholder="Codice a barre o fornitore">
                    </div>
                    
                    <div class="form-group">
                        <label for="stato">Stato Articolo</label>
                        <select id="stato">
                            <option value="in_casa">In Casa</option>
                            <option value="in_uso">In Uso</option>
                            <option value="da_acquistare">Da Acquistare</option>
                            <option value="obsoleto">Obsoleto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        </div>

                </div>

                <div class="form-grid-4">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="quantitaMinima">Quantit√† Minima di Scorta</label>
                        <input type="number" id="quantitaMinima" min="0" value="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantitaDisponibile">Quantit√† Disponibile</label>
                        <input type="number" id="quantitaDisponibile" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="dataUltimoAggiornamento">Ultimo Aggiornamento</label>
                        <input type="date" id="dataUltimoAggiornamento">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="costoUnitario">Costo Unitario (‚Ç¨)</label>
                        <input type="number" id="costoUnitario" step="0.01" min="0" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="fornitorePreferito">Fornitore Preferito</label>
                        <select id="fornitorePreferito">
                            <option value="">-- Caricamento... --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="note">Note / Link Acquisto</label>
                    <textarea id="note" rows="3"></textarea>
                </div>

                <div class="modal-buttons" style="margin-top: 20px; text-align: left;">
                    <button type="button" class="primary" style="background-color: #007bff; color: white; margin-right: 15px;" 
                        id="stampaArticoloBtn" onclick="stampaSchedaArticolo(document.getElementById('articoloId').value)">üñ®Ô∏è Stampa Scheda Articolo</button>
                        
                    <button type="button" onclick="chiudiModaleArticolo()" style="background-color: #ccc;">Annulla</button>
                    <button type="submit" class="primary">Salva Articolo</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // CONFIGURAZIONE FIREBASE (Identica agli altri file)
        const firebaseConfig = {
  	apiKey: "AIzaSyCumjnczv2vErHKu-KHF_2sh4GJey5RFTY",
  	authDomain: "epapp-bb953.firebaseapp.com",
  	projectId: "epapp-bb953",
  	storageBucket: "epapp-bb953.firebasestorage.app",
  	messagingSenderId: "797675959163",
  	appId: "1:797675959163:web:30c077ce253990239d03de",
  	measurementId: "G-RN2896V58E"
	};
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); 
        
        // Elementi HTML
        const tabellaInventarioBody = document.getElementById('tabellaInventarioBody');
        const articoloModal = document.getElementById('articoloModal');
        const articoloForm = document.getElementById('articoloForm');
        const dashboardNav = document.getElementById('dashboardNav');
        const stampaArticoloBtn = document.getElementById('stampaArticoloBtn');
        
        // Mappatura per visualizzazione e Codice Parlante
        const CategoriaMapping = {
            'matp': 'Materie prime', 
            'canc': 'Cancelleria', 
            'uten': 'Utensili e Accessori',
            'beni': 'Beni strumentali',
            'gioc': 'Giocattoli',
            'alle': 'Allestimenti'
        };
        const StatoMapping = {
            'in_casa': 'In Casa', 
            'in_uso': 'In Uso', 
            'da_acquistare': 'Da Acquistare',
            'obsoleto': 'Obsoleto'
        };

        // --- FUNZIONI UTILITY e FIREBASE ---

        function toggleNav() {
            dashboardNav.classList.toggle('open');
        }

        function handleLogout() { 
            auth.signOut().then(() => { 
                window.location.href = '00index.html'; 
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        /**
         * Carica l'elenco dei fornitori dalla collection "fornitori" e popola il campo select.
         */
        function caricaFornitoriPerSelect() {
            const selectFornitore = document.getElementById('fornitorePreferito');
            selectFornitore.innerHTML = '<option value="">-- Caricamento... --</option>';
            
            db.collection("fornitori").orderBy("nomeAzienda", "asc").get().then(snapshot => {
                
                selectFornitore.innerHTML = '<option value="">-- Seleziona Fornitore --</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.nomeAzienda;
                    option.textContent = data.nomeAzienda;
                    selectFornitore.appendChild(option);
                });

                if (snapshot.empty) {
                     selectFornitore.innerHTML = '<option value="">-- Nessun Fornitore Trovato --</option>';
                }
                
            }).catch(error => {
                selectFornitore.innerHTML = '<option value="">-- Errore Caricamento Fornitori --</option>';
                console.error("Errore nel caricamento dei fornitori per la select:", error);
            });
        }

        auth.onAuthStateChanged((user) => {
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (user) {
                dashboardContainer.style.display = 'flex';
                if(window.innerWidth <= 768) { document.getElementById('logoutLink').style.display = 'none'; }
                caricaFornitoriPerSelect(); 
                caricaInventario(); 
            } else {
                dashboardContainer.style.display = 'none';
                window.location.href = '00index.html'; 
            }
        });
        
        // --- LOGICA CODICE PARLANTE ---

        /**
         * Genera il Codice Interno Parlante basato su Categoria e Nome Articolo.
         * Formato: CAT.NOM-###
         * @param {boolean} forceManual Se true, ignora l'automatismo e chiede direttamente l'input manuale.
         */
        async function generaCodiceParlante(forceManual = false) {
            const categoriaSelect = document.getElementById('categoria');
            const nomeArticoloInput = document.getElementById('nomeArticolo');
            const codiceArticoloInput = document.getElementById('codiceArticolo');
            
            // Non generare il codice se siamo in modifica o se i campi chiave sono vuoti
            if (document.getElementById('articoloId').value !== '') return;
            if (!nomeArticoloInput.value.trim() || !categoriaSelect.value) {
                codiceArticoloInput.value = '';
                return;
            }

            const catCodice = categoriaSelect.value.toUpperCase().substring(0, 3); 
            const nomeCodice = nomeArticoloInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 3).padEnd(3, 'X'); 
            
            if (nomeCodice.trim() === 'XXX') {
                codiceArticoloInput.value = '';
                return; 
            }

            const prefisso = `${catCodice}.${nomeCodice}-`;

            try {
                // 1. Cerca il progressivo massimo per il prefisso attuale nel DB
                const snapshot = await db.collection("inventario")
                    .where("codiceArticolo", ">=", prefisso)
                    .where("codiceArticolo", "<", prefisso + 'z')
                    .orderBy("codiceArticolo", "desc")
                    .limit(1)
                    .get();

                let progressivo = 1;
                
                if (!snapshot.empty) {
                    const ultimoCodice = snapshot.docs[0].data().codiceArticolo;
                    const match = ultimoCodice.match(/-(\d{3})$/);
                    if (match) {
                        progressivo = parseInt(match[1]) + 1;
                    }
                }
                
                const codiceProposto = prefisso + String(progressivo).padStart(3, '0');
                
                let scelta = forceManual ? null : confirm(`Codice Interno Proposto: ${codiceProposto}\n\nVuoi accettare questo codice? Clicca OK per accettare o Annulla per immetterlo manualmente.`);
                
                if (scelta === true) {
                    codiceArticoloInput.value = codiceProposto;
                    codiceArticoloInput.readOnly = true; // Rende solo lettura se accettato
                } else {
                    // L'utente ha annullato o √® stato forzato l'input manuale
                    codiceArticoloInput.value = codiceProposto; // Suggerisce ma permette la modifica
                    codiceArticoloInput.readOnly = false;
                    alert('Ora puoi sovrascrivere il Codice Interno Proposto.');
                }
                
            } catch (error) {
                console.error("Errore nella generazione del codice parlante:", error);
                alert("Errore nella generazione del codice automatico. Immetti il Codice Interno manualmente.");
                codiceArticoloInput.readOnly = false;
            }
        }
        
        // --- FUNZIONI STAMPA PDF ---

        /**
         * Genera e scarica la scheda dettagliata dell'articolo in PDF.
         * @param {string} id ID del documento Articolo.
         */
        async function stampaSchedaArticolo(id) {
            if (!id) {
                alert("Impossibile stampare: l'articolo non √® ancora stato salvato.");
                return;
            }
            
            try {
                // 1. Recupera i dati dal database
                const doc = await db.collection("inventario").doc(id).get();
                if (!doc.exists) {
                    alert("Articolo non trovato nel database.");
                    return;
                }
                const data = doc.data();

                // 2. Inizializza jsPDF
                const { jsPDF } = window.jspdf;
                const docPdf = new jsPDF();
                
                let y = 15;
                const MARGIN = 15;

                // 3. Intestazione
                docPdf.setFontSize(18);
                docPdf.text(`SCHEDA ARTICOLO - INVENTARIO`, MARGIN, y);
                y += 10;
                docPdf.setFontSize(14);
                docPdf.text(data.nomeArticolo.toUpperCase() || 'ARTICOLO SENZA NOME', MARGIN, y);
                y += 5;
                docPdf.setFontSize(10);
                docPdf.text(`Codice Interno: ${data.codiceArticolo || 'N/D'}`, MARGIN, y);
                y += 10;

                // 4. Tabella Dettagli principali
                const tableData = [
                    ["Categoria", CategoriaMapping[data.categoria] || 'N/D'],
                    ["SKU/Codice Fornitore", data.codiceSKU || 'N/D'],
                    ["Stato Articolo", StatoMapping[data.stato] || 'N/D'],
                    ["Costo Unitario", `‚Ç¨ ${parseFloat(data.costoUnitario || 0).toFixed(2)}`],
                    ["Fornitore Preferito", data.fornitorePreferito || 'N/D'],
                    ["Ultimo Aggiornamento Quantit√†", data.dataUltimoAggiornamento || 'N/D']
                ];

                docPdf.autoTable({
                    startY: y,
                    head: [['Campo', 'Valore']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [165, 221, 46], textColor: [52, 58, 64] },
                    margin: { left: MARGIN, right: MARGIN }
                });

                y = docPdf.autoTable.previous.finalY + 10;

                // 5. Sezione Quantit√† e Scorte
                docPdf.setFontSize(12);
                docPdf.text("DETTAGLI SCORTE", MARGIN, y);
                y += 5;

                const scorteData = [
                    ["Quantit√† Disponibile", data.quantitaDisponibile || 0],
                    ["Quantit√† Minima di Scorta", data.quantitaMinima || 1],
                    ["Stato Scorte", (data.quantitaDisponibile < data.quantitaMinima) ? 'SOTTO MINIMO (ORDINARE!)' : 'OK']
                ];
                
                docPdf.autoTable({
                    startY: y,
                    body: scorteData,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 3 },
                    columnStyles: { 1: { fontStyle: 'bold' } },
                    margin: { left: MARGIN, right: MARGIN }
                });
                
                y = docPdf.autoTable.previous.finalY + 10;
                
                // 6. Sezione Note
                docPdf.setFontSize(12);
                docPdf.text("NOTE / LINK ACQUISTO", MARGIN, y);
                y += 5;

                const noteText = data.note || 'Nessuna nota aggiunta.';
                // Splitta il testo delle note in righe per adattarsi alla pagina
                const splitNotes = docPdf.splitTextToSize(noteText, docPdf.internal.pageSize.width - (MARGIN * 2));
                docPdf.setFontSize(10);
                docPdf.text(splitNotes, MARGIN, y);
                y += (splitNotes.length * 5) + 10;
                
                // 7. Footer
                docPdf.setFontSize(8);
                docPdf.text(`Generato da EPApp - Inventario il ${new Date().toLocaleDateString('it-IT')}`, MARGIN, docPdf.internal.pageSize.height - 10);

                // 8. Download
                docPdf.save(`Scheda_Articolo_${data.codiceArticolo || id}.pdf`);

            } catch (error) {
                alert(`Errore durante la creazione del PDF: ${error.message}`);
                console.error("Errore PDF:", error);
            }
        }
        
        // --- FUNZIONI CRUD INVENTARIO ---

        /**
         * Carica e visualizza tutti gli articoli dell'inventario.
         */
        function caricaInventario() {
             tabellaInventarioBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Caricamento Inventario...</td></tr>';
            
            db.collection("inventario").orderBy("nomeArticolo", "asc").get().then(snapshot => {
                tabellaInventarioBody.innerHTML = '';
                if (snapshot.empty) {
                    tabellaInventarioBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessun articolo trovato in inventario.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const quantitaDisp = parseInt(data.quantitaDisponibile) || 0;
                    const quantitaMin = parseInt(data.quantitaMinima) || 0;
                    
                    const isScortaBassa = quantitaDisp < quantitaMin;
                    
                    const row = tabellaInventarioBody.insertRow();
                    row.className = `row ${isScortaBassa ? 'scorta-bassa' : 'scorta-sufficiente'}`;
                    
                    // Helper per tradurre i valori interni del db in testo visualizzabile
                    const getCategoriaVisual = (cod) => CategoriaMapping[cod] || cod;
                    const getStatoVisual = (cod) => StatoMapping[cod] || cod;
                    
                    row.innerHTML = `
                        <td>${data.codiceArticolo || 'N/D'}</td>
                        <td>${data.nomeArticolo || 'N/D'}</td>
                        <td>${data.codiceSKU || '-'}</td>
                        <td>${getCategoriaVisual(data.categoria)}</td>
                        <td>${quantitaDisp}</td>
                        <td>${quantitaMin}</td>
                        <td>${getStatoVisual(data.stato)}</td>
                        <td>
                            <button class="primary" style="background-color: #ffc107; color: white; margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick="event.stopPropagation(); apriModaleArticolo('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Modifica</button>
                            <button class="danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); eliminaArticolo('${doc.id}')">Elimina</button>
                        </td>
                    `;
                });
            }).catch(error => {
                 tabellaInventarioBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Errore nel caricamento inventario.</td></tr>';
                 console.error("Errore nel caricamento inventario:", error);
            });
        }
        
        /**
         * Apre la modale per aggiungere o modificare un articolo.
         */
        function apriModaleArticolo(id = null, data = {}) {
            articoloForm.reset();
            document.getElementById('articoloId').value = id || '';
            document.getElementById('articoloModalTitle').textContent = id ? 'Modifica Articolo Inventario' : 'Aggiungi Nuovo Articolo';
            
            const codiceArticoloInput = document.getElementById('codiceArticolo');
            codiceArticoloInput.readOnly = !!id; 
            
            // Visualizza/Nascondi bottone stampa in base allo stato
            stampaArticoloBtn.style.display = id ? 'inline-block' : 'none';

            if (id) {
                document.getElementById('nomeArticolo').value = data.nomeArticolo || '';
                document.getElementById('codiceArticolo').value = data.codiceArticolo || '';
                document.getElementById('codiceSKU').value = data.codiceSKU || '';
                document.getElementById('categoria').value = data.categoria || 'matp'; 
                document.getElementById('stato').value = data.stato || 'in_casa'; 
                
                document.getElementById('quantitaMinima').value = data.quantitaMinima || 1;
                document.getElementById('quantitaDisponibile').value = data.quantitaDisponibile || 0;
                document.getElementById('dataUltimoAggiornamento').value = data.dataUltimoAggiornamento || ''; 
                
                document.getElementById('costoUnitario').value = parseFloat(data.costoUnitario || 0).toFixed(2);
                document.getElementById('fornitorePreferito').value = data.fornitorePreferito || ''; 
                
                document.getElementById('note').value = data.note || '';
            } else {
                // Nuovi articoli
                document.getElementById('quantitaMinima').value = 1;
                document.getElementById('quantitaDisponibile').value = 0;
                document.getElementById('costoUnitario').value = 0.00;
                document.getElementById('stato').value = 'in_casa';
                document.getElementById('categoria').value = 'matp';
                document.getElementById('fornitorePreferito').value = '';
                codiceArticoloInput.value = '';
                codiceArticoloInput.readOnly = true; 
                document.getElementById('dataUltimoAggiornamento').value = new Date().toISOString().slice(0, 10);
            }
            
            articoloModal.style.display = "block";
        }

        /**
         * Chiude la modale.
         */
        function chiudiModaleArticolo() {
            articoloModal.style.display = "none";
        }
        
        /**
         * Gestisce il salvataggio o l'aggiornamento dell'articolo.
         */
        articoloForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const articoloId = document.getElementById('articoloId').value;
            const isEditing = !!articoloId;
            
            const codiceArticoloInput = document.getElementById('codiceArticolo');
            
            if (!codiceArticoloInput.value.trim()) {
                alert("Il campo 'Codice Interno (Parlante)' √® obbligatorio.");
                codiceArticoloInput.focus();
                return;
            }

            const articoloData = {
                nomeArticolo: document.getElementById('nomeArticolo').value,
                codiceArticolo: codiceArticoloInput.value.toUpperCase().trim(),
                codiceSKU: document.getElementById('codiceSKU').value.trim(),
                categoria: document.getElementById('categoria').value,
                stato: document.getElementById('stato').value,
                
                quantitaMinima: parseInt(document.getElementById('quantitaMinima').value) || 1,
                quantitaDisponibile: parseInt(document.getElementById('quantitaDisponibile').value) || 0,
                costoUnitario: parseFloat(document.getElementById('costoUnitario').value) || 0.00,
                
                dataUltimoAggiornamento: document.getElementById('dataUltimoAggiornamento').value || '',
                fornitorePreferito: document.getElementById('fornitorePreferito').value || '', 
                
                note: document.getElementById('note').value
            };
            
            const collectionRef = db.collection("inventario");
            
            if (!isEditing) {
                db.collection("inventario").where("codiceArticolo", "==", articoloData.codiceArticolo).get().then(snapshot => {
                    if (!snapshot.empty) {
                        alert(`Errore: Il codice parlante ${articoloData.codiceArticolo} esiste gi√†. Modifica il progressivo numerico per salvare.`);
                        codiceArticoloInput.readOnly = false;
                        return;
                    }
                    salvaArticolo(collectionRef.add(articoloData), isEditing);
                }).catch(error => {
                    alert(`Errore di controllo: ${error.message}`);
                });
            } else {
                 salvaArticolo(collectionRef.doc(articoloId).update(articoloData), isEditing);
            }
        });

        function salvaArticolo(operation, isEditing) {
            operation.then(() => {
                alert(`Articolo ${isEditing ? 'aggiornato' : 'aggiunto'} con successo!`);
                chiudiModaleArticolo();
                caricaInventario(); 
            }).catch(error => {
                alert(`Errore nel salvataggio: ${error.message}`);
                console.error("Errore:", error);
            });
        }

        /**
         * Elimina un articolo dall'inventario.
         */
        function eliminaArticolo(id) {
            if (confirm("Sei sicuro di voler eliminare questo articolo dall'inventario? L'operazione √® irreversibile.")) {
                db.collection("inventario").doc(id).delete().then(() => {
                    alert("Articolo eliminato con successo.");
                    caricaInventario(); 
                }).catch(error => {
                    alert("Errore durante l'eliminazione dell'articolo: " + error.message);
                    console.error("Errore eliminazione:", error);
                });
            }
        }
    </script>
</body>
</html>
